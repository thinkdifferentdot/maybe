---
session_id: lunchflow-supabase-integration-2025-12-28
project: Maybe Finance App
feature: Lunchflow + Supabase Integration
date: 2025-12-28
status: Planning Complete - Ready for Implementation
tags: [lunchflow, supabase, integration, design, planning]
---

# Lunchflow + Supabase Integration - Session Context

## Session Summary

Completed comprehensive design and implementation planning for integrating Maybe finance app with Lunchflow via Supabase as an intermediary data layer.

## Project State

### Current Branch
- **Branch**: `feature/lunchflow-supabase-integration`
- **Worktree Location**: `/Users/andrewbewernick/GitHub/local-budget/maybe/.worktrees/lunchflow-supabase`
- **Base Branch**: `main`

### Test Baseline
- 902 tests, 5688 assertions
- 0 failures, 7 pre-existing errors (Plaid mock issues), 9 skips
- Pre-existing errors are unrelated to this integration

## Completed Work

### 1. Design Phase (Completed)
**Design Document**: `docs/plans/2025-12-28-lunchflow-supabase-integration-design.md`

Key design decisions:
- **Architecture**: Three-tier (Lunchflow API → Supabase Edge Function → Supabase DB → Maybe Rails App)
- **Data Flow**: Supabase acts as centralized data layer for multiple apps
- **Sync Strategy**: Hybrid (automatic periodic + manual trigger)
- **Account Mapping**: Hybrid (auto-create + manual override)

Components designed:
1. **Supabase Data Layer**
   - Tables: lunchflow_accounts, lunchflow_transactions, lunchflow_balances, lunchflow_sync_log
   - Indexes optimized for queries by account_id, date, status

2. **Supabase Edge Function**
   - TypeScript/Deno serverless function
   - Fetches from Lunchflow API, writes to Supabase
   - Scheduled via pg_cron (every 6 hours)

3. **Maybe Integration**
   - Models: LunchflowConnection (like PlaidItem), LunchflowAccount
   - Uses existing Syncable concern and Sync infrastructure
   - SupabaseClient service for API communication

### 2. Implementation Planning (Completed)
**Implementation Plan**: `docs/plans/2025-12-28-lunchflow-supabase-implementation.md`

19 tasks organized in 8 phases:
- Phase 1: Supabase Schema (4 tasks)
- Phase 2: Edge Function (1 task)
- Phase 3: Rails Migrations (2 tasks)
- Phase 4: Models (5 tasks)
- Phase 5: Background Jobs (2 tasks)
- Phase 6: Controller/Routes (1 task)
- Phase 7: Views (1 task)
- Phase 8: Documentation (1 task)

### 3. Worktree Setup (Completed)
- Created `.worktrees/` directory
- Added `.worktrees/` to .gitignore
- Installed dependencies (bundle, npm)
- Verified clean test baseline

## Architecture Details

### Data Flow
```
Lunchflow API (https://lunchflow.com/api/v1)
    ↓ (Edge Function polls every 6 hours)
Supabase PostgreSQL Tables
    ↓ (Maybe reads via SupabaseClient)
Maybe Rails Models (LunchflowConnection, LunchflowAccount)
    ↓ (Creates/updates)
Maybe Account and Entry records
```

### Key Models

**LunchflowConnection** (Syncable)
- belongs_to :family
- has_many :lunchflow_accounts
- has_many :accounts (through lunchflow_accounts)
- Implements Syncable protocol

**LunchflowAccount**
- belongs_to :lunchflow_connection
- belongs_to :account (optional, for mapping)
- Stores Lunchflow account metadata
- Methods: ensure_account!, potential_duplicates

**LunchflowConnection::Syncer**
- Fetches accounts from Supabase
- Upserts LunchflowAccount records
- Syncs transactions and balances
- Creates Entry records for transactions

### Lunchflow API Endpoints Used

1. **GET /accounts**
   - Returns: accounts array with id, name, institution_name, provider, currency, status

2. **GET /accounts/:accountId/transactions?include_pending=true**
   - Returns: transactions array with id, accountId, amount, currency, date, merchant, description, isPending

3. **GET /accounts/:accountId/balance**
   - Returns: balance object with amount, currency

### Supabase Schema

**lunchflow_accounts**
- id BIGINT (PK, from Lunchflow)
- name, institution_name, institution_logo, provider, currency, status
- created_at, updated_at

**lunchflow_transactions**
- id TEXT (PK, from Lunchflow)
- account_id BIGINT (FK)
- amount NUMERIC, currency, date, merchant, description, is_pending
- Indexes: (account_id, date DESC), (account_id, is_pending)

**lunchflow_balances**
- id BIGSERIAL (PK)
- account_id BIGINT (FK)
- amount NUMERIC, currency, synced_at
- Index: (account_id, synced_at DESC)

**lunchflow_sync_log**
- Tracks Edge Function sync runs
- status, accounts_synced, transactions_synced, error_message

### Rails Schema

**lunchflow_connections** (UUID PK)
- family_id (FK), name, status, last_synced_at

**lunchflow_accounts** (UUID PK)
- lunchflow_connection_id (FK)
- account_id (FK, nullable - for mapping)
- lunchflow_id BIGINT (unique)
- name, institution_name, institution_logo, provider, currency, status

## Technical Decisions

### Why Supabase as Intermediary?
- **Multi-app access**: Other applications besides Maybe can consume the data
- **Decoupling**: Separates data collection from consumption
- **Centralized data warehouse**: Single source of truth for financial data

### Why Edge Functions?
- **Serverless**: No infrastructure to manage
- **Scheduled execution**: Built-in cron support via pg_cron
- **Independent**: Runs outside Maybe app lifecycle

### Why Hybrid Account Mapping?
- **Default auto-create**: Smooth onboarding, minimal user friction
- **Manual override**: Power users can prevent duplicates (e.g., if same account in Plaid and Lunchflow)
- **Duplicate detection**: Suggests potential matches by institution name

### Why Reuse Syncable Pattern?
- **Consistency**: Follows existing Plaid integration pattern
- **Leverage existing infrastructure**: Sync model, state machine, UI patterns
- **Familiar codebase patterns**: Easier maintenance

## Configuration Requirements

### Supabase Setup
1. Create Supabase project
2. Run migrations (4 SQL files)
3. Deploy Edge Function
4. Set `LUNCHFLOW_API_KEY` secret
5. Configure pg_cron schedule

### Rails Credentials
```yaml
supabase:
  url: https://PROJECT.supabase.co
  key: SERVICE_ROLE_KEY
  anon_key: ANON_KEY
  edge_function_url: https://PROJECT.supabase.co/functions/v1/sync-lunchflow
```

### Sidekiq Cron
- Job: SyncLunchflowConnectionsJob
- Schedule: Every 6 hours (`0 */6 * * *`)

## Next Steps

### Immediate Next Steps (Implementation)
1. **Option A: Subagent-Driven Development**
   - Use `superpowers:subagent-driven-development` skill
   - Execute tasks one-by-one with review between tasks
   - Stay in current session

2. **Option B: Parallel Session**
   - Open new session in worktree
   - Use `superpowers:executing-plans` skill
   - Batch execution with checkpoints

### Implementation Order
Follow the 19 tasks in implementation plan sequentially:
1. Start with Supabase schema migrations
2. Build Edge Function
3. Create Rails migrations and models
4. Add background jobs
5. Build controller and views
6. Write setup documentation

### Testing Strategy
- Model tests for LunchflowConnection, LunchflowAccount
- Syncer tests with mocked Supabase client
- Controller tests for CRUD + sync
- System tests for UI flows (optional)
- Mock Lunchflow API responses in tests

## Important Files

### Documentation
- `docs/plans/2025-12-28-lunchflow-supabase-integration-design.md` - Full design spec
- `docs/plans/2025-12-28-lunchflow-supabase-implementation.md` - Step-by-step plan
- `docs/lunchflow-setup.md` - Setup guide (to be created)

### Migrations
- `supabase/migrations/20251228000001_create_lunchflow_accounts.sql`
- `supabase/migrations/20251228000002_create_lunchflow_transactions.sql`
- `supabase/migrations/20251228000003_create_lunchflow_balances.sql`
- `supabase/migrations/20251228000004_create_lunchflow_sync_log.sql`

### Edge Function
- `supabase/functions/sync-lunchflow/index.ts`

### Rails Files (to be created)
- Migrations: `db/migrate/*_create_lunchflow_connections.rb`, `*_create_lunchflow_accounts.rb`
- Models: `app/models/lunchflow_connection.rb`, `app/models/lunchflow_account.rb`
- Syncer: `app/models/lunchflow_connection/syncer.rb`, `sync_complete_event.rb`
- Service: `app/services/supabase_client.rb`
- Controller: `app/controllers/lunchflow_connections_controller.rb`
- Views: `app/views/lunchflow_connections/*.html.erb`
- Job: `app/jobs/sync_lunchflow_connections_job.rb`

## Reference Patterns

### Existing Code Patterns to Follow

**PlaidItem → LunchflowConnection**
- Both include Syncable, Provided
- Both have has_many relationship to accounts
- Both implement perform_sync via Syncer class
- Both have SyncCompleteEvent for broadcasts

**PlaidAccount → LunchflowAccount**
- PlaidAccount has direct has_one :account
- LunchflowAccount has optional belongs_to :account (for mapping flexibility)
- Both store provider metadata

**PlaidEntry::Processor → Transaction Import in Syncer**
- Use find_or_initialize_by with unique ID
- Create Entry with Transaction entryable
- Use enrich_attribute for provider-sourced data

### Transaction ID Strategy
- Prefix Lunchflow transaction IDs: `lunchflow_#{txn_data['id']}`
- Store in Entry#plaid_id field (reuse existing field)
- Prevents collisions with Plaid transactions

## Known Constraints

### Project Conventions
- **Minimal dependencies**: Use Rails + existing patterns, avoid new gems
- **Skinny controllers, fat models**: Business logic in models
- **Hotwire-first**: Use Turbo, avoid heavy JS
- **Testing**: Minitest + fixtures (no RSpec/FactoryBot)

### Maybe Codebase Specifics
- Use `Current.family` and `Current.user` (not current_family/current_user)
- Entry model uses delegated_type :entryable
- Account has delegated_type :accountable
- Fixtures kept minimal (2-3 per model)

## Risks and Mitigations

### Risk: Duplicate Transactions
**Mitigation**: Use unique transaction IDs prefixed with "lunchflow_"

### Risk: Supabase Credentials Exposure
**Mitigation**: Store in Rails encrypted credentials, use service role key carefully

### Risk: Rate Limiting from Lunchflow API
**Mitigation**: Add configurable delays in Edge Function, implement exponential backoff

### Risk: Account Mapping Confusion
**Mitigation**: Provide clear UI with duplicate detection, show potential matches

### Risk: Sync Failures
**Mitigation**: Use Sync state machine (pending/syncing/completed/failed), log errors, broadcast updates

## Commits Made

1. `Add .worktrees/ to .gitignore` - Prepare for worktree development
2. `Add Lunchflow + Supabase integration design document` - Full design spec
3. `docs: add Lunchflow + Supabase implementation plan` - Step-by-step implementation guide

## Session Timeline

1. **Brainstorming Phase**: Used superpowers:brainstorming skill to explore integration approaches
2. **Design Phase**: Presented design in 6 sections (architecture, schema, edge function, models, sync, mapping)
3. **Worktree Setup**: Created isolated workspace using superpowers:using-git-worktrees skill
4. **Planning Phase**: Used superpowers:writing-plans skill to create detailed implementation plan

## Key Learnings

### Lunchflow API Structure
- Simple REST API with 4 main endpoints
- Bearer token authentication
- Supports multiple providers (gocardless, quiltt, finverse, pluggy, etc.)
- Transaction data includes pending flag, merchant, description

### Supabase Edge Functions
- Deno runtime, TypeScript
- Access via `https://PROJECT.supabase.co/functions/v1/FUNCTION_NAME`
- Secrets via environment variables
- Can be triggered by HTTP POST or pg_cron

### Maybe Sync Infrastructure
- Syncable concern provides sync_later method
- Sync model tracks state (pending → syncing → completed/failed)
- Syncer classes implement perform_sync and perform_post_sync
- SyncCompleteEvent broadcasts to UI via Turbo Streams

## Questions for Future Sessions

1. Should we support multiple Lunchflow connections per family?
2. How to handle transaction categories from Lunchflow (if available)?
3. Should we sync investment holdings from Lunchflow?
4. How to handle currency conversion for multi-currency accounts?
5. Should we implement real-time sync via Supabase Realtime?

## Context for Next Developer

**Start here**: Read `docs/plans/2025-12-28-lunchflow-supabase-implementation.md`

**Quick start**:
1. You're in a worktree at `.worktrees/lunchflow-supabase`
2. Branch: `feature/lunchflow-supabase-integration`
3. Dependencies installed, tests passing (with pre-existing errors)
4. Ready to start Task 1: Create Supabase migrations

**Recommended approach**:
- Use `superpowers:executing-plans` or `superpowers:subagent-driven-development`
- Follow TDD: write failing test → implement → verify → commit
- Commit after each task (19 tasks total)
- Run `bin/rails test` before final PR

**Help available**:
- Design doc has full architecture details
- Implementation plan has exact code for each task
- Refer to PlaidItem/PlaidAccount patterns for guidance
