# Milestone v1.3: Codebase Health

**Status:** ✅ SHIPPED 2026-01-11
**Phases:** 24-29
**Total Plans:** 6

## Overview

Reduce technical debt and fix known bugs to establish clean patterns for future feature work. Focuses on DRY-ing up duplicated code, improving error handling, and enhancing AI categorization accuracy.

## Phases

### Phase 24: Env Example Updates

**Goal**: Add ANTHROPIC_* entries to .env.example for documentation
**Depends on**: Phase 20
**Plans**: 1 plan

Plans:

- [x] 24-01: Add ANTHROPIC_API_KEY and ANTHROPIC_MODEL to .env.example

**Details:**
Added ANTHROPIC_API_KEY environment variable entry and ANTHROPIC_MODEL with default value (claude-sonnet-4-5-20250929). Grouped entries with descriptive section header following existing patterns.

---

### Phase 25: Extract JSON Parser

**Goal**: DRY up parse_json_flexibly across 4 provider files
**Depends on**: Phase 20
**Plans**: 1 plan

Plans:

- [x] 25-01: Create shared Provider::Concerns::JsonParser module

**Details:**
Created shared `Provider::Concerns::JsonParser` module with 4-strategy JSON parsing and dual tag format support. Refactored all 4 provider classes (Anthropic::AutoCategorizer, Anthropic::AutoMerchantDetector, OpenAI::AutoCategorizer, OpenAI::AutoMerchantDetector) to use shared concern. Eliminated ~390 lines of duplicate code. All tests passing (174 provider tests, 482 assertions).

---

### Phase 26: Extract Thinking Tags

**Goal**: DRY up strip_thinking_tags across 4 files
**Depends on**: Phase 25
**Plans**: 1 plan

Plans:

- [x] 26-01: Refactor provider classes to use shared JsonParser concern

**Details:**
Phase 26 is obsolete — all planned work was completed as part of Phase 25 execution. When Phase 25 was executed, the scope expanded to include both the JsonParser concern creation AND the refactoring of all 4 provider classes to use it. This rendered Phase 26's planned work unnecessary.

---

### Phase 27: Simplify JSON Parsing

**Goal**: Break down complex parse_json_flexibly method with helpers
**Depends on**: Phase 25
**Plans**: 1 plan

Plans:

- [x] 27-01: Refactor parse_json_flexibly into helper methods

**Details:**
Refactored 85-line parse_json_flexibly method into 5 focused helper methods: extract_from_closed_code_blocks, extract_from_unclosed_code_blocks, extract_json_with_key, extract_any_json_object. Simplified main method from ~85 to ~30 lines. Added comprehensive unit tests in json_parser_test.rb with 36 test cases. Fixed regex interpolation issue in extract_json_with_key. All 210 provider tests passing.

---

### Phase 28: Standardize Error Handling

**Goal**: Consistent error handling patterns across all providers
**Depends on**: Phase 25
**Plans**: 1 plan

Plans:

- [x] 28-01: Create shared Provider::Concerns::ErrorHandler module

**Details:**
Created shared `Provider::Concerns::ErrorHandler` module with provider-specific error translation methods (with_anthropic_error_handler, with_openai_error_handler). Refactored all 4 provider classes (Anthropic::AutoCategorizer, Anthropic::AutoMerchantDetector, OpenAI::AutoCategorizer, OpenAI::AutoMerchantDetector) to use shared concern. Eliminated ~60 lines of duplicate error handling code. Comprehensive error handling for all SDK-specific error types (APIConnectionError, APITimeoutError, RateLimitError, AuthenticationError, APIStatusError, JSON::ParserError). All 210 provider tests passing.

---

### Phase 29: Improve Categorization Prompts

**Goal**: Add few-shot examples to reduce null categorizations
**Depends on**: Phase 28
**Plans**: 1 plan

Plans:

- [x] 29-01: Implement few-shot examples for AI categorization

**Details:**
Implemented two-tier few-shot examples system for AI transaction categorization prompts. Created Provider::Concerns::FewShotExamples with static baseline examples (5 hardcoded covering common categories) and dynamic examples from user's LearnedPattern records (0-3, one per category for diversity). Integrated into both OpenAI and Anthropic AutoCategorizers. Added comprehensive test coverage (14 tests). Expected to significantly reduce >50% null categorization results. All 76 provider tests passing (11 OpenAI + 15 Anthropic + 36 JsonParser + 14 FewShotExamples).

---

## Milestone Summary

**Decimal Phases:**
None

**Key Decisions:**
- Use Provider::Concerns namespace pattern for shared provider logic (established in Phase 20)
- ErrorHandler provides with_anthropic_error_handler and with_openai_error_handler wrapper methods
- OpenAI Faraday::BadRequestError fallback logic remains inline (specific to JSON mode retry)
- Few-shot examples use two-tier approach: static baseline + dynamic LearnedPattern examples
- Token impact of ~200-400 tokens per prompt is acceptable (<500 threshold)

**Issues Resolved:**
- Character encoding issues with special thinking tags (<think>) resolved using Unicode escape sequences
- Regex interpolation bug in extract_json_with_key fixed
- File corruption during initial JsonParser creation resolved by using Python with proper escaping

**Issues Deferred:**
None

**Technical Debt Incurred:**
None - this milestone focused on reducing technical debt

**Stats:**
- 31 files changed
- +4,189 insertions, -685 deletions
- 6 phases, 6 plans
- ~1.3 hours development time (2026-01-11 11:27 → 12:44)
- Git range: f302b2bf → ea953eec

---

_For current project status, see .planning/ROADMAP.md_
