# Milestone v1.1: AI Auto-Categorization Triggers

**Status:** SHIPPED 2026-01-10
**Phases:** 10-15 + 14.1 + 14.2
**Total Plans:** 8

## Overview

Implement AI auto-categorization triggers across the application with settings UI, import/sync integration, individual and bulk categorization workflows, comprehensive test coverage, and Anthropic model autopopulation. Users can now configure AI to automatically categorize transactions on CSV import, account sync, or manual action with confidence tracking and learned pattern creation.

## Phases

### Phase 10: Settings & Config

**Goal**: Add AI auto-categorization settings with three opt-in toggles
**Depends on**: v1.0 complete
**Plans**: 1 plan

Plans:
- [x] 10-01: Add settings fields, controller, view, and navigation

**Status**: Complete (2026-01-10)

**Details:**
Added three boolean settings fields (ai_categorize_on_import, ai_categorize_on_sync, ai_categorize_on_ui_action) with default: false. Created Settings::AutoCategorizationController with admin-only access. Added settings view with three toggle switches using DS::Toggle component. Added navigation item in Transactions section with sparkles icon. All defaults are OFF (opt-in pattern to avoid surprise AI costs).

---

### Phase 11: Import Triggers

**Goal**: Implement AI categorization triggers in CSV import and Lunchflow sync
**Depends on**: Phase 10
**Plans**: 4 plans

Plans:
- [x] 11-01: LearnedPattern Model
- [x] 11-02: CSV Import AI Categorization
- [x] 11-03: Lunchflow Sync AI Categorization
- [x] 11-04: Bulk Review Workflow

**Status**: Complete (2026-01-10)

**Details:**

**11-01 LearnedPattern Model:**
Created learned_patterns table migration with family/category associations. Implemented LearnedPattern model with automatic merchant name normalization. Created LearnedPatternMatcher service for fuzzy substring matching. Added has_many :learned_patterns to Family model. Added learned_pattern_for and learn_pattern_from! methods to Family. Updated AutoCategorizer to check learned patterns before AI calls.

**11-02 CSV Import AI Categorization:**
Added `ai_categorize_enabled?` helper to TransactionImport. Modified `TransactionImport#import!` to trigger AI categorization for uncategorized transactions. AI categorization runs asynchronously via AutoCategorizeJob. Check setting at import time (not queue time). Only categorize transactions without user-provided categories.

**11-03 Lunchflow Sync AI Categorization:**
Created LunchflowAccount::PostProcessor for batch AI categorization. Modified LunchflowAccount::Transactions::Processor to track imported IDs. Integrated PostProcessor into LunchflowAccount::Processor flow. Track IDs in memory during processing (no DB changes). Async job to avoid blocking sync.

**11-04 Bulk Review Workflow:**
Created bulk review workflow for AI-categorized transactions. Users can approve (create learned pattern) or reject (remove category) AI suggestions. Added "Recent AI" filter to show transactions with AI categorization from last 7 days. Inline approve/reject buttons appear only for AI-categorized transactions. Turbo Stream provides smooth UX without page reload.

---

### Phase 12: Transaction UI Actions

**Goal**: Add individual and bulk AI categorization buttons to transaction UI
**Depends on**: Phase 11
**Plans**: 3 plans

Plans:
- [x] 12-01: Backend Provider Selection & Confidence
- [x] 12-02: Individual AI Categorize Button
- [x] 12-03: Bulk AI Categorization

**Status**: Complete (2026-01-10)

**Details:**

**12-01 Backend Provider Selection & Confidence:**
Updated AutoCategorizer to use family's configured LLM provider (openai/anthropic). Added AutoCategorizer::Result struct with transaction_id, category_name, confidence. Confidence scores stored in transaction.extra["ai_categorization_confidence"]. Default confidence of 1.0 for now until providers return actual confidence scores.

**12-02 Individual AI Categorize Button:**
Added AI categorize button to each transaction row with sparkle icon. Created AiCategorizationsController with Turbo Stream responses for inline updates. Added ai_categorize Stimulus controller for loading states and error handling. Confidence badge displays AI certainty percentage with color coding (green >80%, yellow 60-80%, orange <60%).

**12-03 Bulk AI Categorization:**
Added bulk AI categorize button to selection bar with sparkle icon. Cost estimation displayed dynamically based on selection count. BulkAiCategorizationsController processes batches with per-transaction error handling. Low-confidence (<60%) results require user confirmation. High-confidence results apply immediately. Summary modal shows categorization results.

---

### Phase 13: Testing & Docs

**Goal**: Comprehensive test coverage and full regression testing
**Depends on**: Phase 12
**Plans**: 4 plans

Plans:
- [x] 13-01: LearnedPattern Model Tests
- [x] 13-02: AI Categorization Controllers
- [x] 13-03: Settings & Confidence Integration
- [x] 13-04: Full AI Regression

**Status**: Complete (2026-01-10)

**Details:**

**13-01 LearnedPattern Model Tests:**
Created test/models/learned_pattern_test.rb with validation and normalization tests (23 tests). Created test/models/learned_pattern_matcher_test.rb with matching logic tests (22 tests). Added Family learned pattern integration tests to family_test.rb (5 tests).

**13-02 AI Categorization Controllers:**
Created test/controllers/transactions/ai_categorizations_controller_test.rb with 10 tests. Created test/controllers/transactions/bulk_ai_categorizations_controller_test.rb with 13 tests. Created test/system/transactions_ai_categorize_system_test.rb with 6 tests. Fixed route definition bug and controller bug during testing.

**13-03 Settings & Confidence Integration:**
Verified existing AI trigger tests for CSV import and Lunchflow sync settings integration. Created confidence badge view tests with 9 test cases covering all confidence ranges and boundary conditions. Confirmed settings UI toggle tests pass from Phase 10.

**13-04 Full AI Regression:**
Ran OpenAI provider regression tests - all pass (11 tests, 53 assertions). Ran Anthropic provider regression tests - all pass (11 tests, 40 assertions). Ran AutoCategorizer integration tests with provider selection - all pass (7 tests, 19 assertions). Full test suite: 1731 tests, 8346 assertions, 0 failures.

---

### Phase 14: Manual Testing

**Goal**: Create manual testing checklist document
**Depends on**: Phase 13
**Plans**: 1 plan

Plans:
- [x] 14-01: Manual Testing Checklist

**Status**: Complete (2026-01-10)

**Details:**
Created comprehensive MANUAL_TEST_CHECKLIST.md document with 275 checkable items. Organized by v1.1 feature (Settings, CSV Import, Individual, Bulk). Clear test steps with URLs and expected outcomes. Edge cases covered (disabled settings, error handling, confidence levels). Issues found table for documenting bugs.

---

### Phase 14.1: Fix AI Categorize Route (INSERTED)

**Goal**: Fix 404 error on individual AI categorize button
**Depends on**: Phase 14
**Plans**: 1 plan

Plans:
- [x] 14.1-01: Fix AI Categorize Route 404 Error

**Status**: Complete (2026-01-10) (INSERTED)

**Details:**
Fixed root cause: view was sending `transaction.id` but controller expects `entry.id` (different UUIDs in delegated_type pattern). Added controller-level `rescue_from` to override StoreLocation concern's 404 handling. Added test coverage for orphaned entry scenario. 404 error now returns 422 with user-friendly error message.

---

### Phase 14.2: Fix Auto-Categorize Page Labels (INSERTED)

**Goal**: Fix missing toggle labels on auto-categorization settings page
**Depends on**: Phase 14.1
**Plans**: 1 plan

Plans:
- [x] 14.2-01: Fix Auto-Categorize Page Labels

**Status**: Complete (2026-01-10) (INSERTED)

**Details:**
Root cause was DS::Toggle component not accepting or displaying label parameter. Fixed by adding label attribute to component and updating template to render label text conditionally with flex container for proper alignment. All three AI categorization options now display their descriptive labels. Backward compatible with existing toggle usages.

---

### Phase 15: Anthropic Model Autopopulate

**Goal**: Convert Anthropic model field from text input to select dropdown with dynamic model fetching
**Depends on**: v1.0 settings UI
**Plans**: 1 plan

Plans:
- [x] 15-01: Anthropic Model Autopopulate

**Status**: Complete (2026-01-10)

**Details:**
Created `/settings/hosting/anthropic_models` backend endpoint that proxies requests to Anthropic's `/v1/models` API. Implemented `anthropic-model-select` Stimulus controller for fetching models and managing selection UI. Updated Anthropic settings view to use select dropdown with "Custom..." fallback for manual entry. Added comprehensive locale strings for model selection, loading states, and error messages. Added full test coverage for the models endpoint with mocked API responses.

---

## Milestone Summary

**Decimal Phases:**
- Phase 14.1: Fix AI Categorize Route (inserted after Phase 14 for urgent fix)
- Phase 14.2: Fix Auto-Categorize Page Labels (inserted after Phase 14.1 for UI fix)

**Key Decisions:**
- All AI trigger settings default to OFF (opt-in pattern to avoid surprise AI costs)
- Confidence stored in transaction.extra metadata for simplicity (no new table)
- Learned patterns applied BEFORE AI calls (cost reduction)
- PostProcessor pattern for batch AI categorization after sync
- Track IDs in memory during processing (no DB changes)
- 60% confidence threshold for confirmation
- Errors per transaction continue batch process (don't stop bulk operation)
- Backend proxy pattern for Anthropic models API (avoid exposing API keys to frontend)
- Filter Anthropic API response to only claude- prefixed models
- "Custom..." option in dropdown for manual model entry

**Issues Resolved:**
- Fixed 404 error on AI categorize button (view sending transaction.id instead of entry.id)
- Fixed StoreLocation concern overriding local error handlers
- Fixed DS::Toggle component not displaying label text
- Fixed route definition bug for ai_categorization
- Fixed controller bug with transactions.reload on Array
- Fixed VCR test environment issues with .env file

**Technical Debt Incurred:**
None — this milestone focused on feature implementation with comprehensive test coverage.

---

**Stats:**
- 40+ files created/modified
- 8 phases (10-15, 14.1, 14.2)
- 8 plans
- ~1 day from v1.0 to ship (2026-01-09 → 2026-01-10)

---

_For current project status, see .planning/ROADMAP.md_
