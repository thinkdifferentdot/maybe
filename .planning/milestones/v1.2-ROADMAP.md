# Milestone v1.2: Anthropic Feature Parity

**Status:** SHIPPED 2026-01-11
**Phases:** 16-18, 20
**Total Plans:** 4

## Overview

Achieve feature parity between OpenAI and Anthropic provider implementations. This milestone completes the Anthropic integration by implementing remaining features that existed in OpenAI but were missing from Anthropic: real streaming support, fuzzy category/merchant matching, and centralized usage recording. Phase 19 (Flexible JSON Parsing) was deferred to v1.3 technical debt work.

## Phases

### Phase 16: Real Streaming Support

**Goal**: Implement token-by-token streaming for Anthropic chat responses
**Depends on**: v1.1 complete
**Plans**: 1 plan

Plans:
- [x] 16-01: Implement real streaming for Anthropic chat responses

**Status**: Complete (2026-01-10)

**Details:**
Implemented token-by-token streaming for Anthropic chat responses using MessageStream API. Created Provider::Anthropic::ChatStreamParser to convert MessageStream events to ChatStreamChunk format. Updated Provider::Anthropic#chat_response to use client.messages.stream() when streamer provided. Added comprehensive test coverage (13 tests) for ChatStreamParser event handling. Handles Anthropic MessageStream event types: content_block_delta, message_delta, message_stop, content_block_start, content_block_stop. Emits output_text chunks for text deltas (progressive rendering). Emits response chunk on message_stop with usage extracted from accumulated message.

---

### Phase 17: Auto-Categorization Test Coverage

**Goal**: Add auto_categorize test for Provider::Anthropic to achieve test parity with OpenAI
**Depends on**: Phase 16
**Plans**: 1 plan

Plans:
- [x] 17-01: Record VCR cassette for Anthropic auto_categorize API call
- [x] 17-01: Add "auto categorizes transactions by various attributes" test to anthropic_test.rb
- [x] 17-01: Verify all 12 Anthropic tests pass (no regressions)

**Status**: Complete (2026-01-10)

**Details:**
Recorded VCR cassette for Anthropic auto_categorize API call. Added "auto categorizes transactions by various attributes" test to anthropic_test.rb following OpenAI test patterns. Verified all 12 Anthropic tests pass with no regressions.

---

### Phase 18: Fuzzy Category & Merchant Matching

**Goal**: Port fuzzy name matching from OpenAI to Anthropic for better category/merchant normalization
**Depends on**: Phase 17
**Plans**: 1 plan

Plans:
- [x] 18-01: Port fuzzy name matching from OpenAI to Anthropic

**Status**: Complete (2026-01-11)

**Details:**
Ported fuzzy name matching from OpenAI to Anthropic, enabling better category/merchant normalization with synonym and substring matching. Added fuzzy_name_match? method to handle common category name variations (synonyms like "gasoline" → "Gas & Fuel", "coffee shop" → "Coffee Shops"). Added find_fuzzy_category_match method for substring matching and synonym lookup. Updated normalize_category_name to apply fuzzy matching as fallback after exact and case-insensitive matching. Added 3 tests validating fuzzy matching behavior.

**Decisions:**
- Port existing OpenAI implementation as-is for feature parity
- Levenshtein distance improvement deferred per research recommendation

**Patterns Established:**
- Normalization flow: exact match, case-insensitive, fuzzy match, return raw
- Substring matching using normalized strings (downcase + remove non-alphanumeric)
- Synonym lookup via variations hash mapping related terms

---

### Phase 20: Extract UsageRecorder Concern

**Goal**: Extract duplicated usage recording code into shared concern across provider classes
**Depends on**: Phase 19 (deferred), executed out-of-order
**Plans**: 1 plan

Plans:
- [x] 20-01: Create Provider::Concerns::UsageRecorder with shared usage recording methods

**Status**: Complete (2026-01-11)

**Details:**
Extracted duplicated usage recording code into shared concern module, eliminating ~160 lines of duplicate code across provider classes. Created Provider::Concerns::UsageRecorder shared module (112 lines) with format-detecting extract_tokens helper. Refactored Provider::Anthropic::AutoCategorizer to include shared concern, removed 34-line duplicate method. Refactored Provider::Anthropic::AutoMerchantDetector to include shared concern, removed 34-line duplicate method. Converted Provider::Openai::Concerns::UsageRecorder to backward-compatible alias (97 lines → 7 lines). All 26 provider tests passing with no regressions.

**Decisions:**
- Used top-level Provider::Concerns namespace for maximum portability
- Format detection via respond_to?(:input_tokens) handles both Hash (OpenAI) and BaseModel (Anthropic) formats
- Preserved OpenAI concern as backward-compatible alias

**Patterns Established:**
- Concern pattern: Shared behavior module at top-level namespace
- Format detection: Duck-typing via respond_to? for provider-agnostic handling

**Net change:** -158 lines of duplicate code eliminated

---

## Milestone Summary

**Decimal Phases:**
None in this milestone.

**Key Decisions:**
- Use stream.each (full event access) instead of stream.text.each to support future tool use streaming
- Extract usage from accumulated_message instead of tracking per-parser state (each parser instance is independent)
- Return nil for unhandled event types (ping, unknown) - graceful degradation
- Follow OpenAI's collected_chunks pattern to extract response/usage after stream completes
- Port existing OpenAI fuzzy matching implementation as-is for feature parity
- Use top-level Provider::Concerns namespace for maximum portability
- Format detection via respond_to?(:input_tokens) handles both Hash and BaseModel formats

**Issues Resolved:**
- Private method access error in tests: provider.client not accessible via attr_reader - fixed using instance_variable_get(:@client)

**Issues Deferred:**
- Phase 19: Flexible JSON Parsing — deferred to v1.3 Codebase Health milestone

**Technical Debt Incurred:**
None — this milestone focused on reducing technical debt through shared concerns.

---

**Stats:**
- 29 files changed
- +4,086 lines added
- -231 lines removed (net +3,855)
- 4 phases
- 4 plans
- ~1 day development time (2026-01-10 → 2026-01-11)

---

_For current project status, see .planning/ROADMAP.md_
