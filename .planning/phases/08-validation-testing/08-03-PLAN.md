---
phase: 08-validation-testing
plan: 03
type: execute
domain: rails-testing
---

<objective>
Test provider switching functionality and settings UI to ensure users can configure and switch between OpenAI and Anthropic providers.

Purpose: Verify the complete user-facing configuration flow - from settings UI to provider selection to actual API calls with the selected provider. This is the end-to-end validation of the settings feature.

Output: System tests for provider switching and settings UI, plus verification that the correct provider is used based on configuration.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-validation-testing/08-CONTEXT.md

# Settings UI files (Phase 6):
@app/views/settings/hostings/_llm_provider_selection.html.erb
@app/views/settings/hostings/_anthropic_settings.html.erb
@app/views/settings/hostings/show.html.erb
@app/controllers/settings/hostings_controller.rb

# Settings model (Phase 5):
@app/models/setting.rb - llm_provider field, validate_llm_provider! method

# Registry (Phase 4):
@app/models/provider/registry.rb - anthropic and openai methods, available_providers for :llm

# Test reference:
@test/models/provider/registry_test.rb

**Tech stack available:**
- Rails system tests for UI testing
- Minitest for model/controller tests
- ClimateControl for ENV override

**Established patterns:**
- System tests in test/system/
- Controller tests in test/controllers/
- Model tests in test/models/
- ENV -> Setting fallback pattern

**Constraining decisions:**
- Phase 5-02: Provider selection is global (single llm_provider field, not per-feature)
- Phase 5-03: LLM_PROVIDERS constant = %w[openai anthropic]
- Phase 6-01: Provider selector dropdown with auto-submit on blur
- Phase 6-02: Anthropic settings partial follows OpenAI structure

**Issues being addressed:** None

**Note:** Phase 6-03 and 06-04 (show/hide fields based on provider, validation UI) may not be complete. This plan focuses on testing what exists.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Setting model tests for llm_provider field</name>
  <files>test/models/setting_test.rb</files>
  <action>Add tests to test/models/setting_test.rb for the new llm_provider field:
1. Test llm_provider field accepts valid values (openai, anthropic)
2. Test llm_provider field validation rejects invalid values
3. Test validate_llm_provider! method
4. Test ENV fallback (LLM_PROVIDER -> Setting.llm_provider)

Example tests to add:
```ruby
test "llm_provider accepts valid provider values" do
  setting = Setting.new
  setting.llm_provider = "openai"
  assert_equal "openai", setting.llm_provider

  setting.llm_provider = "anthropic"
  assert_equal "anthropic", setting.llm_provider
end

test "llm_provider validation rejects invalid values" do
  setting = Setting.new
  setting.llm_provider = "invalid_provider"
  assert_not setting.valid?
  assert_includes setting.errors[:llm_provider], "is not included in the list"
end

test "validate_llm_provider! raises error for invalid provider" do
  setting = Setting.new(llm_provider: "invalid")
  assert_raises(ActiveModel::ValidationError) do
    setting.validate_llm_provider!
  end
end

test "llm_provider falls back to ENV" do
  ClimateControl.modify LLM_PROVIDER: "anthropic" do
    assert_equal "anthropic", Setting.llm_provider
  end
end
```</action>
  <verify>bin/rails test test/models/setting_test.rb -n /llm_provider/ passes</verify>
  <done>Setting model tests for llm_provider passing</done>
</task>

<task type="auto">
  <name>Task 2: Add Setting model tests for Anthropic fields</name>
  <files>test/models/setting_test.rb</files>
  <action>Add tests to test/models/setting_test.rb for Anthropic-specific fields:
1. Test anthropic_access_token field with ENV fallback (ANTHROPIC_API_KEY)
2. Test anthropic_model field with ENV fallback (ANTHROPIC_MODEL)
3. Test redaction placeholder ("********") doesn't overwrite valid tokens
4. Test whitespace stripping from tokens

Example tests:
```ruby
test "anthropic_access_token falls back to ENV" do
  ClimateControl.modify ANTHROPIC_API_KEY: "env-token" do
    assert_equal "env-token", Setting.anthropic_access_token
  end
end

test "anthropic_model falls back to ENV" do
  ClimateControl.modify ANTHROPIC_MODEL: "claude-opus-4-5" do
    assert_equal "claude-opus-4-5", Setting.anthropic_model
  end
end

test "anthropic_access_token redaction placeholder preserves existing value" do
  setting = Setting.new(anthropic_access_token: "existing-token")
  setting.update(anthropic_access_token: "********")
  assert_equal "existing-token", setting.anthropic_access_token
end
```</action>
  <verify>bin/rails test test/models/setting_test.rb -n /anthropic/ passes</verify>
  <done>Setting model tests for Anthropic fields passing</done>
</task>

<task type="auto">
  <name>Task 3: Add registry tests for provider selection based on llm_provider</name>
  <files>test/models/provider/registry_test.rb</files>
  <action>Add tests to verify Provider::Registry respects the llm_provider setting:
1. Test available_providers includes both :openai and :anthropic for :llm concept
2. Test get_provider(:openai) returns Provider::Openai when configured
3. Test get_provider(:anthropic) returns Provider::Anthropic when configured
4. Test get_provider returns nil when provider not configured

Example tests:
```ruby
test "llm concept has both openai and anthropic as available providers" do
  registry = Provider::Registry.for_concept(:llm)
  assert_includes registry.available_providers, :openai
  assert_includes registry.available_providers, :anthropic
end

test "get_provider returns nil when anthropic not configured" do
  ClimateControl.modify ANTHROPIC_API_KEY: nil do
    Setting.stubs(:anthropic_access_token).returns(nil)
    registry = Provider::Registry.for_concept(:llm)
    assert_nil registry.get_provider(:anthropic)
  end
end
```</action>
  <verify>bin/rails test test/models/provider/registry_test.rb -n /llm/ or /provider/ passes</verify>
  <done>Registry tests for provider selection passing</done>
</task>

<task type="auto">
  <name>Task 4: Add controller tests for settings update with Anthropic fields</name>
  <files>test/controllers/settings/hostings_controller_test.rb</files>
  <action>Add tests to test/controllers/settings/hostings_controller_test.rb:
1. Test successful update of anthropic_access_token
2. Test successful update of anthropic_model
3. Test successful update of llm_provider
4. Test redaction placeholder handling
5. Test invalid llm_provider value shows error

If the controller test file doesn't exist, create it following Rails patterns:
```ruby
require "test_helper"

class Settings::HostingsControllerTest < ActionDispatch::IntegrationTest
  setup do
    @user = users(:one)
    sign_in @user
  end

  test "can update anthropic_access_token" do
    patch settings_hosting_path, params: {
      setting: { anthropic_access_token: "new-token" }
    }
    assert_redirected_to settings_hosting_path
    assert_equal "new-token", @user.family.setting.anthropic_access_token
  end

  test "can update llm_provider" do
    patch settings_hosting_path, params: {
      setting: { llm_provider: "anthropic" }
    }
    assert_redirected_to settings_hosting_path
    assert_equal "anthropic", @user.family.setting.llm_provider
  end

  test "invalid llm_provider shows error" do
    patch settings_hosting_path, params: {
      setting: { llm_provider: "invalid" }
    }
    assert_response :success
    assert_not flash[:error].empty?
  end
end
```</action>
  <verify>bin/rails test test/controllers/settings/hostings_controller_test.rb passes</verify>
  <done>Controller tests for Anthropic settings passing</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Provider selection and settings UI tests</what-built>
  <how-to-verify>
    1. Start dev server: bin/dev
    2. Visit: /settings/hosting
    3. Verify:
       - Provider selector dropdown shows OpenAI and Anthropic options
       - Anthropic API key and model fields are visible
       - Can select Anthropic from dropdown
       - Can enter Anthropic API key
       - Can save settings
    4. After saving with Anthropic selected:
       - Verify settings persist on page reload
       - Try an AI feature (chat, categorization) to confirm Anthropic is used
    5. Switch back to OpenAI:
       - Change provider selector to OpenAI
       - Save settings
       - Verify AI features use OpenAI again
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</checkpoint>

<task type="auto">
  <name>Task 5: Add system test for provider switching end-to-end</name>
  <files>test/system/provider_switching_test.rb</files>
  <action>Create test/system/provider_switching_test.rb for end-to-end provider switching:
1. Test user can navigate to settings
2. Test user can select Anthropic provider
3. Test user can enter Anthropic API key and model
4. Test settings are saved and persist
5. Test user can switch back to OpenAI

Example system test:
```ruby
require "test_helper"

class ProviderSwitchingTest < ApplicationSystemTestCase
  setup do
    @user = users(:one)
    sign_in @user
  end

  test "user can switch from OpenAI to Anthropic provider" do
    visit settings_hosting_path

    # Select Anthropic provider
    select "Anthropic", from: "setting_llm_provider"
    fill_in "setting_anthropic_access_token", with: "test-anthropic-key"
    fill_in "setting_anthropic_model", with: "claude-sonnet-4-5-20250929"

    # Auto-submit happens on blur, or click save
    click_on "Save Settings"

    assert_text "Settings updated"
    assert_equal "anthropic", @user.family.setting.reload.llm_provider
    assert_equal "test-anthropic-key", @user.family.setting.anthropic_access_token
  end

  test "user can switch from Anthropic back to OpenAI" do
    @user.family.setting.update(llm_provider: "anthropic")

    visit settings_hosting_path

    select "OpenAI", from: "setting_llm_provider"
    click_on "Save Settings"

    assert_text "Settings updated"
    assert_equal "openai", @user.family.setting.reload.llm_provider
  end
end
```</action>
  <verify>bin/rails test:system TEST=test/system/provider_switching_test.rb passes</verify>
  <done>System test for provider switching passing</done>
</task>

<task type="auto">
  <name>Task 6: Create integration test for provider usage with real setting</name>
  <files>test/integration/provider_usage_integration_test.rb</files>
  <action>Create test/integration/provider_usage_integration_test.rb to verify the correct provider is used based on settings:
1. Test with llm_provider="openai" -> Provider::Registry returns OpenAI
2. Test with llm_provider="anthropic" -> Provider::Registry returns Anthropic
3. Test ENV fallback when Setting is nil

Example:
```ruby
require "test_helper"

class ProviderUsageIntegrationTest < ActionDispatch::IntegrationTest
  setup do
    @family = families(:one)
  end

  test "openai provider is used when llm_provider is openai" do
    @family.setting.update(llm_provider: "openai", openai_access_token: "test-token")

    registry = Provider::Registry.for_concept(:llm)
    provider = registry.providers.first

    assert_instance_of Provider::Openai, provider
  end

  test "anthropic provider is used when llm_provider is anthropic" do
    @family.setting.update(llm_provider: "anthropic", anthropic_access_token: "test-token")

    ClimateControl.modify ANTHROPIC_API_KEY: nil do
      registry = Provider::Registry.for_concept(:llm)
      providers = registry.providers.to_compact

      assert_includes providers.map { |p| p.class }, Provider::Anthropic
    end
  end
end
```</action>
  <verify>bin/rails test test/integration/provider_usage_integration_test.rb passes</verify>
  <done>Integration test for provider selection passing</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] bin/rails test test/models/setting_test.rb -n /llm_provider/ passes
- [ ] bin/rails test test/models/setting_test.rb -n /anthropic/ passes
- [ ] bin/rails test test/models/provider/registry_test.rb -n /llm/ passes
- [ ] bin/rails test test/controllers/settings/hostings_controller_test.rb passes
- [ ] bin/rails test:system TEST=test/system/provider_switching_test.rb passes
- [ ] bin/rails test test/integration/provider_usage_integration_test.rb passes
- [ ] Manual UI verification approved
</verification>

<success_criteria>

- Setting model tests for llm_provider and Anthropic fields passing
- Registry tests verify both providers are available
- Controller tests verify settings can be updated
- System test verifies end-to-end provider switching
- Integration test verifies correct provider is used based on settings
- Manual UI verification approved
  </success_criteria>

<output>
After completion, create `.planning/phases/08-validation-testing/08-03-SUMMARY.md`:

# Phase 8 Plan 3: Provider Switching and Settings UI Tests Summary

**Verified end-to-end provider switching and settings configuration**

## Accomplishments

- Added Setting model tests for llm_provider and Anthropic fields
- Added registry tests for provider selection
- Added controller tests for settings updates
- Created system test for provider switching UI
- Created integration test for provider usage based on settings
- Completed manual UI verification

## Files Created/Modified

- `test/models/setting_test.rb` - Added llm_provider and Anthropic field tests
- `test/models/provider/registry_test.rb` - Added provider selection tests
- `test/controllers/settings/hostings_controller_test.rb` - Added settings update tests
- `test/system/provider_switching_test.rb` - New system test
- `test/integration/provider_usage_integration_test.rb` - New integration test

## Commits

- [List commits produced]

## Next Step

Phase 8 complete! Ready for deployment.
</output>