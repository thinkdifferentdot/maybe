---
phase: 08-validation-testing
plan: 01
type: execute
domain: rails-testing
---

<objective>
Test all AI features with Anthropic provider to ensure implementation is correct and complete.

Purpose: Provide deployment confidence by verifying that all Anthropic functionality works as expected. This is the primary validation that our Anthropic integration is production-ready.

Output: Comprehensive test suite for Provider::Anthropic with VCR cassettes covering all code paths.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-validation-testing/08-CONTEXT.md

# Key files from prior phases (relevant to this phase):
@app/models/provider/anthropic.rb
@app/models/provider/anthropic/auto_categorizer.rb
@app/models/provider/anthropic/auto_merchant_detector.rb
@app/models/provider/anthropic/chat_config.rb
@app/models/provider/anthropic/chat_parser.rb
@app/models/provider/registry.rb
@app/models/llm_usage.rb

# Reference test file for patterns:
@test/models/provider/openai_test.rb
@test/test_helper.rb

**Tech stack available:**
- anthropic ~> 1.16.0 (official Anthropic Ruby SDK)
- Rails test framework: Minitest with fixtures (not RSpec, not factories)
- VCR for API call recording/replay
- mocha for mocking

**Established patterns:**
- LLMInterfaceTest module for shared LLM provider tests
- VCR cassettes in test/vcr_cassettes/{provider}/
- VCR sensitive data filtering via config.filter_sensitive_data
- Test fixtures in test/fixtures/*.yml
- Tests use ClimateControl for ENV override

**Constraining decisions:**
- Phase 1-02: DEFAULT_MODEL = "claude-sonnet-4-5-20250929" for testing
- Phase 2-02: Content extraction from response.content array (Anthropic-specific)
- Phase 3-01: Token field mapping (input/output_tokens -> prompt/completion_tokens)
- Phase 3-02: Anthropic uses "input_schema" not "parameters" for tools
- Phase 3-03: Tool_result blocks come FIRST in user message content array

**Issues being addressed:** None
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Provider::Anthropic test file structure</name>
  <files>test/models/provider/anthropic_test.rb</files>
  <action>Create test/models/provider/anthropic_test.rb following the exact structure of test/models/provider/openai_test.rb:
- Include LLMInterfaceTest module
- Setup @subject with Provider::Anthropic.new(ENV.fetch("ANTHROPIC_API_KEY", "test-token"))
- Set @subject_model to DEFAULT_MODEL (claude-sonnet-4-5-20250929)
- Add basic provider info tests (provider_name, supports_model?, supported_models_description)
- DO NOT add VCR tests yet - those come in next task

IMPORTANT: Use Minitest syntax (not RSpec), use fixtures (not factories), follow existing patterns exactly.</action>
  <verify>bin/rails test test/models/provider/anthropic_test.rb passes with basic tests</verify>
  <done>Test file created with structure matching OpenAI tests, basic provider info tests passing</done>
</task>

<task type="auto">
  <name>Task 2: Add VCR cassette configuration for Anthropic</name>
  <files>test/test_helper.rb</files>
  <action>Add VCR sensitive data filtering for Anthropic API key in test/test_helper.rb:
- Add: config.filter_sensitive_data("<ANTHROPIC_API_KEY>") { ENV["ANTHROPIC_API_KEY"] }
- Place it alongside the existing OPENAI_ACCESS_TOKEN filter
- This ensures API keys are redacted in recorded cassettes

DO NOT add other VCR configuration changes - only the filter line.</action>
  <verify>grep ANTHROPIC_API_KEY test/test_helper.rb shows the filter configuration</verify>
  <done>VCR configured to filter Anthropic API keys from cassettes</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Generate VCR cassettes for Anthropic API calls</action>
  <instructions>
    I've set up the test structure. Now I need VCR cassettes (recorded API responses) to run tests.

    To generate cassettes:
    1. Set ANTHROPIC_API_KEY environment variable with a real Anthropic API key
    2. Run tests with VCR recording: ANTHROPIC_API_KEY=sk-ant-xxx bin/rails test test/models/provider/anthropic_test.rb
    3. VCR will record actual API calls to test/vcr_cassettes/anthropic/

    Required cassettes (create by running each test once):
    - anthropic/auto_categorize.yml
    - anthropic/auto_detect_merchants.yml
    - anthropic/chat/basic_response.yml
    - anthropic/chat/function_calls.yml

    After recording, the cassettes can be committed and tests will run offline.
  </instructions>
  <verification>test/vcr_cassettes/anthropic/ directory exists with .yml cassette files</verification>
  <resume-signal>Type "done" when VCR cassettes have been recorded</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Add auto_categorize test with VCR</name>
  <files>test/models/provider/anthropic_test.rb</files>
  <action>Add test "auto categorizes transactions by various attributes" matching openai_test.rb line 20-59:
- Use VCR.use_cassette("anthropic/auto_categorize")
- Use same input_transactions and user_categories as OpenAI test
- Assert response.success?
- Assert correct category mappings for each transaction
- Anthropic may return slightly different category assignments (acceptable) but structure must match

Key assertions to maintain:
- response.data.size equals input_transactions.size
- Each result has transaction_id and category_name
- Uncertain transactions return null category</action>
  <verify>bin/rails test test/models/provider/anthropic_test.rb -n test_auto_categorizes_transactions passes</verify>
  <done>Auto-categorize test passing with VCR cassette</done>
</task>

<task type="auto">
  <name>Task 4: Add auto_detect_merchants test with VCR</name>
  <files>test/models/provider/anthropic_test.rb</files>
  <action>Add test "auto detects merchants" matching openai_test.rb line 61-115:
- Use VCR.use_cassette("anthropic/auto_detect_merchants")
- Use same input_transactions and user_merchants as OpenAI test
- Assert response.success?
- Assert correct merchant mappings (business_name, business_url)
- Both fields are nullable per Phase 2-03 decision

Key assertions to maintain:
- response.data.size equals input_transactions.size
- Known merchants (McDonalds, Walmart, Amazon, Shooters) detected
- Ambiguous/unknown merchants return nil
- Income transactions return nil</action>
  <verify>bin/rails test test/models/provider/anthropic_test.rb -n test_auto_detects_merchants passes</verify>
  <done>Merchant detection test passing with VCR cassette</done>
</task>

<task type="auto">
  <name>Task 5: Add basic chat_response test with VCR</name>
  <files>test/models/provider/anthropic_test.rb</files>
  <action>Add test "basic chat response" matching openai_test.rb line 117-128:
- Use VCR.use_cassette("anthropic/chat/basic_response")
- Simple prompt expecting "Yes" response
- Assert response.success?
- Assert single message in response.data.messages
- Assert output_text contains "Yes"

This tests the basic Messages API integration without tools.</action>
  <verify>bin/rails test test/models/provider/anthropic_test.rb -n test_basic_chat_response passes</verify>
  <done>Basic chat test passing with VCR cassette</done>
</task>

<task type="auto">
  <name>Task 6: Add chat with function calls test with VCR</name>
  <files>test/models/provider/anthropic_test.rb</files>
  <action>Add test "chat response with function calls" matching openai_test.rb line 155-195:
- Use VCR.use_cassette("anthropic/chat/function_calls")
- First call with functions array (get_net_worth)
- Assert function_request returned with call_id
- Second call with function_results
- Assert final response contains expected output

Key Anthropic differences from OpenAI:
- Anthropic's id is both message id and call_id (no separate call_id field)
- Tool results are passed via function_results parameter (not messages array)
- ChatConfig.build_input handles the Anthropic-specific message structure

DO NOT test streaming - deferred per Phase 3-04 decision.</action>
  <verify>bin/rails test test/models/provider/anthropic_test.rb -n test_chat_response_with_function_calls passes</verify>
  <done>Function calling test passing with VCR cassette</done>
</task>

<task type="auto">
  <name>Task 7: Add Anthropic error handling test</name>
  <files>test/models/provider/anthropic_test.rb</files>
  <action>Add test "anthropic errors are automatically raised" matching openai_test.rb line 11-18:
- Use VCR.use_cassette("anthropic/chat/error")
- Trigger error with invalid model or bad request
- Assert !response.success?
- Assert error.kind_of?(Provider::Anthropic::Error)
- Verifies with_provider_response wrapper catches and reports errors

NOTE: You may need to create a separate error cassette or mock for this if Anthropic's error responses differ from OpenAI.</action>
  <verify>bin/rails test test/models/provider/anthropic_test.rb -n test_anthropic_errors_are_automatically_raised passes</verify>
  <done>Error handling test passing</done>
</task>

<task type="auto">
  <name>Task 8: Add effective_model class method test</name>
  <files>test/models/provider/anthropic_test.rb</files>
  <action>Add test for Provider::Anthropic.effective_model class method:
- Test without ENV: returns DEFAULT_MODEL
- Test with ANTHROPIC_MODEL set: returns ENV value
- Tests the ENV fallback logic used in Provider::Registry

Example:
```ruby
test "effective_model returns DEFAULT_MODEL when ENV not set" do
  ClimateControl.modify ANTHROPIC_MODEL: nil do
    assert_equal "claude-sonnet-4-5-20250929", Provider::Anthropic.effective_model
  end
end

test "effective_model returns ENV value when set" do
  ClimateControl.modify ANTHROPIC_MODEL: "claude-opus-4-5" do
    assert_equal "claude-opus-4-5", Provider::Anthropic.effective_model
  end
end
```</action>
  <verify>bin/rails test test/models/provider/anthropic_test.rb -n test_effective_model passes for both cases</verify>
  <done>effective_model tests passing</done>
</task>

<task type="auto">
  <name>Task 9: Add Anthropic registry integration test</name>
  <files>test/models/provider/registry_test.rb</files>
  <action>Add tests to test/models/provider/registry_test.rb for Anthropic:
1. Test anthropic provider returns nil when not configured (no ENV/Setting)
2. Test anthropic provider returns Provider::Anthropic when configured
3. Test anthropic falls back to Setting when ENV is empty string
4. Test :anthropic is included in available_providers for :llm concept

Follow existing patterns from openai tests (lines 48-66).</action>
  <verify>bin/rails test test/models/provider/registry_test.rb -n /anthropic/ passes</verify>
  <done>Registry integration tests for Anthropic passing</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] bin/rails test test/models/provider/anthropic_test.rb passes all tests
- [ ] bin/rails test test/models/provider/registry_test.rb passes including new Anthropic tests
- [ ] VCR cassettes exist in test/vcr_cassettes/anthropic/
- [ ] No API keys in cassettes (all redacted to <ANTHROPIC_API_KEY>)
- [ ] All tests follow Minitest patterns (not RSpec)
</verification>

<success_criteria>

- All Anthropic tests passing
- VCR cassettes recorded and committed
- Test coverage matches OpenAI test patterns
- Error handling verified
- Registry integration verified
  </success_criteria>

<output>
After completion, create `.planning/phases/08-validation-testing/08-01-SUMMARY.md`:

# Phase 8 Plan 1: Anthropic Provider Tests Summary

**Comprehensive test suite for Provider::Anthropic with VCR cassettes**

## Accomplishments

- Created test/models/provider/anthropic_test.rb with full coverage
- Recorded VCR cassettes for all Anthropic API interactions
- Added VCR sensitive data filtering for ANTHROPIC_API_KEY
- Added Anthropic registry integration tests

## Files Created/Modified

- `test/models/provider/anthropic_test.rb` - New test file with full Anthropic coverage
- `test/models/provider/registry_test.rb` - Added Anthropic registry tests
- `test/test_helper.rb` - Added ANTHROPIC_API_KEY VCR filter
- `test/vcr_cassettes/anthropic/` - New VCR cassettes directory

## Tests Added

- Basic provider info (provider_name, supports_model?, supported_models_description)
- auto_categorize with VCR
- auto_detect_merchants with VCR
- Basic chat_response with VCR
- Chat with function calls with VCR
- Error handling
- effective_model class method
- Registry integration

## Commits

- [List commits produced]

## Next Step

Ready for 08-02-PLAN.md (OpenAI regression tests)
</output>