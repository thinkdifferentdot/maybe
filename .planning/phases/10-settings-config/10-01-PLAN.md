---
phase: 10-settings-config
plan: 01
type: execute
domain: rails
---

<objective>
Add user-configurable toggles for AI auto-categorization triggers (CSV import, sync jobs, and manual UI actions).

Purpose: Give users granular, opt-in control over when AI auto-categorization runs. This prevents unexpected AI costs and allows users to choose which trigger contexts they want enabled.
Output: A new "Auto-Categorization" settings page with three independent boolean toggles, accessible from the settings navigation.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-settings-config/10-CONTEXT.md
@.planning/phases/10-settings-config/10-RESEARCH.md

# Relevant prior phases (from dependency graph):
@.planning/phases/05-settings-model/05-SUMMARY.md
@.planning/phases/06-settings-ui/06-02-SUMMARY.md
@.planning/phases/06-settings-ui/06-03-SUMMARY.md

# Key files from prior work:
@app/models/setting.rb
@app/helpers/styled_form_builder.rb
@app/controllers/settings/hostings_controller.rb
@app/views/settings/_settings_nav.html.erb
@config/routes.rb

**Tech stack available:**
- rails-settings-cached 2.9.6 (boolean field support with default: false)
- DS::Toggle component (from design system)
- StyledFormBuilder with toggle method
- Hotwire/Turbo for form handling

**Established patterns (from Phase 5-6):**
- Boolean fields: `field :name, type: :boolean, default: false`
- Settings controllers: inherit from ApplicationController, use `layout "settings"`, `before_action :ensure_admin`
- Form updates: Check `key?` presence before assigning, use permit for params
- Toggle UI: `form.toggle :field_name, label: "Label", checked: Setting.field_name?`
- Nav structure: Add item to appropriate section hash with label/path/icon

**Constraining decisions (from prior phases):**
- Phase 5: Use rails-settings-cached built-in boolean type conversion
- Phase 5: Settings use ENV variable fallbacks
- Phase 6: Admin-only access for settings changes (ensure_admin before_action)
- Phase 6: Use styled_form_with helper for all settings forms

**Issues being addressed:** None

**Research findings applied:**
- Route naming: Use `auto_categorization` (not `ai_categorization`) for clarity
- Admin-only: Family-wide settings since AI costs affect everyone
- Navigation: Place in Transactions section (transaction-related functionality)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add boolean settings fields and route</name>
  <files>app/models/setting.rb, config/routes.rb</files>
  <action>
    In app/models/setting.rb, add three boolean fields after the existing boolean fields (after require_email_confirmation on line 36):
    - field :ai_categorize_on_import, type: :boolean, default: false
    - field :ai_categorize_on_sync, type: :boolean, default: false
    - field :ai_categorize_on_ui_action, type: :boolean, default: false

    In config/routes.rb, add the route inside the namespace :settings block (after line 108):
    - resource :auto_categorization, only: %i[show update], controller: "auto_categorization"

    Do NOT add ENV variable defaults for these fields - they are opt-in user preferences, not system configuration.
  </action>
  <verify>
    bin/rails runner "puts Setting.ai_categorize_on_import" outputs "false"
    bin/rails routes | grep auto_categorization shows settings_auto_categorization GET/PATCH paths
  </verify>
  <done>
    Three new boolean fields exist in Setting model with default: false
    Route exists for settings_auto_categorization resource with show and update actions
  </done>
</task>

<task type="auto">
  <name>Task 2: Create controller and settings view</name>
  <files>app/controllers/settings/auto_categorization_controller.rb, app/views/settings/auto_categorization/show.html.erb</files>
  <action>
    Create app/controllers/settings/auto_categorization_controller.rb following the HostingsController pattern:
    - Inherit from ApplicationController
    - Use layout "settings"
    - Add before_action :ensure_admin (all changes require admin)
    - Define show action with @breadcrumbs = [["Home", root_path], ["Auto-Categorization", nil]]
    - Define update action that:
      - Checks if params.key?(:ai_categorize_on_import) then assigns Setting.ai_categorize_on_import = params[:setting][:ai_categorize_on_import]
      - Checks if params.key?(:ai_categorize_on_sync) then assigns Setting.ai_categorize_on_sync = params[:setting][:ai_categorize_on_sync]
      - Checks if params.key?(:ai_categorize_on_ui_action) then assigns Setting.ai_categorize_on_ui_action = params[:setting][:ai_categorize_on_ui_action]
      - Redirects to settings_auto_categorization_path with notice: t(".success")
    - Private method auto_categorization_params permits the three boolean fields
    - Private method ensure_admin redirects if not Current.user.admin?

    Create app/views/settings/auto_categorization/show.html.erb:
    - Page title and subtitle using t(".page_title") and t(".page_subtitle")
    - styled_form_with helper: model: Setting.new, url: settings_auto_categorization_path, method: :patch
    - Three form.toggle calls for each setting with label and checked: Setting.field_name?
    - form.submit with t(".save_button")
  </action>
  <verify>
    bin/rails test test/controllers/settings/auto_categorization_controller_test.rb (create basic test) passes
    Visit /settings/auto_categorization shows page with three toggles
    Toggling and submitting updates settings values
  </verify>
  <done>
    Controller exists with show/update actions and admin protection
    View renders with three toggle switches using styled_form_with
    Form submission updates Setting values correctly
  </done>
</task>

<task type="auto">
  <name>Task 3: Add navigation item and locales</name>
  <files>app/views/settings/_settings_nav.html.erb, config/locales/views/settings/auto_categorization/en.yml, config/locales/views/settings/en.yml</files>
  <action>
    In app/views/settings/_settings_nav.html.erb, add nav item to the transactions_section items array (after merchants_label on line 20):
    { label: t(".auto_categorization_label"), path: settings_auto_categorization_path, icon: "sparkles" }

    Create config/locales/views/settings/auto_categorization/en.yml with all locale keys:
    - page_title: "Auto-Categorization"
    - page_subtitle: "Choose when AI should automatically categorize your transactions"
    - import_label: "Categorize on CSV import"
    - sync_label: "Categorize on account sync"
    - ui_action_label: "Categorize on manual action"
    - save_button: "Save Changes"
    - success: "Auto-categorization settings updated"
    - not_authorized: "You don't have permission to change settings"

    In config/locales/views/settings/en.yml, add the nav item key under settings_nav:
    - auto_categorization_label: "Auto-Categorization"
  </action>
  <verify>
    Settings nav shows "Auto-Categorization" with sparkles icon in Transactions section
    Clicking nav item navigates to /settings/auto_categorization
    All page text displays correctly (no missing translation keys)
  </verify>
  <done>
    Nav item added to transactions section with sparkles icon
    Locale file created with all required keys
    Nav item locale key added to settings/en.yml
    No missing translation warnings on page load
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Visit /settings/auto_categorization loads without errors
- [ ] Three toggle switches render correctly (all off by default)
- [ ] Toggling switches and submitting updates Setting values
- [ ] Non-admin users are redirected when attempting to access
- [ ] Nav item appears in Transactions section
- [ ] No translation missing warnings
</verification>

<success_criteria>

- All three boolean settings fields exist with default: false
- Auto-categorization settings page accessible from settings nav
- Admin-only access enforced
- All toggles functional and persist across page loads
- No translation keys missing
  </success_criteria>

<output>
After completion, create `.planning/phases/10-settings-config/10-01-SUMMARY.md`:

# Phase 10 Plan 1: Settings & Config Summary

**Added Auto-Categorization settings page with three opt-in toggles for AI categorization triggers**

## Accomplishments

- Added three boolean settings fields (ai_categorize_on_import, ai_categorize_on_sync, ai_categorize_on_ui_action) with default: false
- Created Settings::AutoCategorizationController with admin-only access
- Added settings view with three toggle switches using DS::Toggle component
- Added navigation item in Transactions section with sparkles icon
- Created locale file with all user-facing strings

## Files Created/Modified

- `app/models/setting.rb` - Added three boolean fields
- `config/routes.rb` - Added auto_categorization resource route
- `app/controllers/settings/auto_categorization_controller.rb` - New controller
- `app/views/settings/auto_categorization/show.html.erb` - New settings view
- `app/views/settings/_settings_nav.html.erb` - Added nav item
- `config/locales/views/settings/auto_categorization/en.yml` - New locale file
- `config/locales/views/settings/en.yml` - Added nav locale key

## Decisions Made

- Used `auto_categorization` route name for clarity (not `ai_categorization`)
- Admin-only access (family-wide setting since AI costs affect everyone)
- Placed in Transactions section of settings nav (transaction-related)
- No ENV defaults for these fields (opt-in user preferences, not system config)
- All defaults are OFF (opt-in pattern to avoid surprise AI costs)

## Issues Encountered

None

## Next Phase Readiness

Phase 10 complete. Ready for Phase 11 (Import Triggers) or Phase 12 (Transaction UI Actions). The settings toggles are now available for Phases 11-12 to check before running AI categorization.
</output>