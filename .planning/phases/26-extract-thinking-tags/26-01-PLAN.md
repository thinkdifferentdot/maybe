---
phase: 26-extract-thinking-tags
plan: 01
type: execute
---

<objective>
Complete the JsonParser concern refactoring — remove all duplicated parse_json_flexibly and strip_thinking_tags methods from 4 provider files.

Purpose: Phase 25 created the shared Provider::Concerns::JsonParser module with both methods, but the provider classes were never refactored to use it. This phase completes that refactoring, eliminating ~340 lines of duplicate code.

Output: All 4 provider classes (Anthropic::AutoCategorizer, Anthropic::AutoMerchantDetector, OpenAI::AutoCategorizer, OpenAI::AutoMerchantDetector) include the shared concern, all duplicate methods removed, all tests passing.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONCERNS.md
@.planning/phases/20-extract-usage-recorder-concern/20-01-SUMMARY.md
@.planning/phases/25-extract-json-parser/25-01-PLAN.md
@app/models/provider/concerns/json_parser.rb
@app/models/provider/concerns/usage_recorder.rb
@app/models/provider/anthropic/auto_categorizer.rb
@app/models/provider/anthropic/auto_merchant_detector.rb
@app/models/provider/openai/auto_categorizer.rb
@app/models/provider/openai/auto_merchant_detector.rb

**Tech stack available:** Rails concerns pattern for shared behavior (established in Phase 20)
**Established patterns:**
- Shared concern modules at Provider::Concerns namespace
- include statements after attr_reader in provider classes
- Format detection via respond_to? for provider-agnostic handling
**Constraining decisions:**
- Phase 20: Used top-level Provider::Concerns namespace for maximum portability
- Phase 20: Duck-typing via respond_to? for provider-agnostic handling
**Issues being addressed:** None - this is tech debt cleanup
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor Anthropic::AutoCategorizer to use shared JsonParser</name>
  <files>app/models/provider/anthropic/auto_categorizer.rb</files>
  <action>1. Add `include Provider::Concerns::JsonParser` at the top of the class after existing includes (around line 14, after the UsageRecorder include)

2. Delete the entire `parse_json_flexibly` method (search for "def parse_json_flexibly" and delete through its end)

3. Delete the entire `strip_thinking_tags` method (search for "def strip_thinking_tags" and delete through its end)

Do NOT modify any other parts of the class. The existing calls to `parse_json_flexibly` will automatically use the included concern's method.</action>
  <verify>grep -q "include Provider::Concerns::JsonParser" app/models/provider/anthropic/auto_categorizer.rb returns true, and grep -q "def parse_json_flexibly" app/models/provider/anthropic/auto_categorizer.rb returns false, and grep -q "def strip_thinking_tags" app/models/provider/anthropic/auto_categorizer.rb returns false</verify>
  <done>AutoCategorizer includes shared JsonParser concern, both duplicate methods removed (~107 lines eliminated)</done>
</task>

<task type="auto">
  <name>Task 2: Refactor Anthropic::AutoMerchantDetector to use shared JsonParser</name>
  <files>app/models/provider/anthropic/auto_merchant_detector.rb</files>
  <action>1. Add `include Provider::Concerns::JsonParser` at the top of the class after existing includes

2. Delete the entire `parse_json_flexibly` method (search for "def parse_json_flexibly" and delete through its end)

3. Delete the entire `strip_thinking_tags` method (search for "def strip_thinking_tags" and delete through its end)

Do NOT modify any other parts of the class.</action>
  <verify>grep -q "include Provider::Concerns::JsonParser" app/models/provider/anthropic/auto_merchant_detector.rb returns true, and grep -q "def parse_json_flexibly" app/models/provider/anthropic/auto_merchant_detector.rb returns false, and grep -q "def strip_thinking_tags" app/models/provider/anthropic/auto_merchant_detector.rb returns false</verify>
  <done>AutoMerchantDetector includes shared JsonParser concern, both duplicate methods removed (~107 lines eliminated)</done>
</task>

<task type="auto">
  <name>Task 3: Refactor OpenAI::AutoCategorizer to use shared JsonParser</name>
  <files>app/models/provider/openai/auto_categorizer.rb</files>
  <action>1. Add `include Provider::Concerns::JsonParser` at the top of the class after existing includes (around line 7, after the UsageRecorder include)

2. Delete the entire `parse_json_flexibly` method (search for "def parse_json_flexibly" and delete through its end)

3. Delete the entire `strip_thinking_tags` method (search for "def strip_thinking_tags" and delete through its end)

NOTE: The OpenAI version uses slightly different tag names (<think> vs <thinking>). The shared concern handles both formats, so this is safe.

Do NOT modify any other parts of the class.</action>
  <verify>grep -q "include Provider::Concerns::JsonParser" app/models/provider/openai/auto_categorizer.rb returns true, and grep -q "def parse_json_flexibly" app/models/provider/openai/auto_categorizer.rb returns false, and grep -q "def strip_thinking_tags" app/models/provider/openai/auto_categorizer.rb returns false</verify>
  <done>AutoCategorizer includes shared JsonParser concern, both duplicate methods removed (~89 lines eliminated)</done>
</task>

<task type="auto">
  <name>Task 4: Refactor OpenAI::AutoMerchantDetector to use shared JsonParser</name>
  <files>app/models/provider/openai/auto_merchant_detector.rb</files>
  <action>1. Add `include Provider::Concerns::JsonParser` at the top of the class after existing includes

2. Delete the entire `parse_json_flexibly` method (search for "def parse_json_flexibly" and delete through its end)

3. Delete the entire `strip_thinking_tags` method (search for "def strip_thinking_tags" and delete through its end)

Do NOT modify any other parts of the class.</action>
  <verify>grep -q "include Provider::Concerns::JsonParser" app/models/provider/openai/auto_merchant_detector.rb returns true, and grep -q "def parse_json_flexibly" app/models/provider/openai/auto_merchant_detector.rb returns false, and grep -q "def strip_thinking_tags" app/models/provider/openai/auto_merchant_detector.rb returns false</verify>
  <done>AutoMerchantDetector includes shared JsonParser concern, both duplicate methods removed (~89 lines eliminated)</done>
</task>

<task type="auto">
  <name>Task 5: Run tests and verify no regressions</name>
  <files>test/models/provider/anthropic_test.rb, test/models/provider/openai_test.rb</files>
  <action>Run the full test suite to verify refactoring didn't break anything:

1. Run Anthropic tests: bin/rails test test/models/provider/anthropic_test.rb
2. Run OpenAI tests: bin/rails test test/models/provider/openai_test.rb
3. Run full provider tests: bin/rails test test/models/provider/

If any tests fail, investigate — likely issues would be:
- Method signature difference between providers (unlikely since they're identical)
- Error class mismatch (OpenAI classes may not expect Provider::Anthropic::Error)
- Missing include in one of the classes

All tests should pass since we're only moving code around, not changing behavior.

NOTE: If tests fail due to Provider::Anthropic::Error being raised in OpenAI classes, we may need to make the error class more generic. For now, proceed with the current approach and adjust if needed.</action>
  <verify>All tests pass (anthropic_test.rb, openai_test.rb, and any JSON parsing-related tests)</verify>
  <done>All Anthropic and OpenAI tests passing, no regressions introduced, ~392 lines of duplicate code eliminated across 4 files</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `bin/rails test test/models/provider/anthropic_test.rb` passes
- [ ] `bin/rails test test/models/provider/openai_test.rb` passes
- [ ] Shared concern exists at app/models/provider/concerns/json_parser.rb
- [ ] All 4 provider classes include the shared concern
- [ ] Duplicate parse_json_flexibly methods removed from all 4 classes
- [ ] Duplicate strip_thinking_tags methods removed from all 4 classes
</verification>

<success_criteria>

- All 4 provider classes include Provider::Concerns::JsonParser
- All existing tests pass (no behavior changes)
- ~392 lines of duplicate code eliminated
- Code is more DRY and maintainable
- Phase 26 essentially completes the work started in Phase 25
</success_criteria>

<output>
After completion, create `.planning/phases/26-extract-thinking-tags/26-01-SUMMARY.md`:

# Phase 26 Plan 1: Complete JsonParser Refactoring Summary

**Completed the JsonParser concern refactoring that started in Phase 25 — removed all duplicate parse_json_flexibly and strip_thinking_tags methods from 4 provider classes.**

## Accomplishments

- All 4 provider classes now include Provider::Concerns::JsonParser
- Removed duplicate parse_json_flexibly and strip_thinking_tags from:
  - Provider::Anthropic::AutoCategorizer
  - Provider::Anthropic::AutoMerchantDetector
  - Provider::Openai::AutoCategorizer
  - Provider::Openai::AutoMerchantDetector
- All tests passing with no behavior changes

## Files Created/Modified

- `app/models/provider/concerns/json_parser.rb` - Already existed from Phase 25
- `app/models/provider/anthropic/auto_categorizer.rb` - MODIFIED: Added include, removed ~107 lines
- `app/models/provider/anthropic/auto_merchant_detector.rb` - MODIFIED: Added include, removed ~107 lines
- `app/models/provider/openai/auto_categorizer.rb` - MODIFIED: Added include, removed ~89 lines
- `app/models/provider/openai/auto_merchant_detector.rb` - MODIFIED: Added include, removed ~89 lines

## Decisions Made

- Reused existing Provider::Concerns::JsonParser (created in Phase 25)
- Both <thinking> and <think> tag formats handled in single strip_thinking_tags method

## Issues Encountered

[None expected - straightforward refactoring following existing UsageRecorder pattern]

## Next Step

Phase 26 complete — ready for Phase 27: Simplify JSON Parsing
</output>
