---
phase: 14.1-fix-ai-categorize-route
plan: 01
subsystem: api
tags: rails, controller, rescue_from, ai-categorization

# Dependency graph
requires:
  - phase: 13-04
    provides: AI categorization controllers and tests
provides:
  - Fixed 404 error on individual AI categorize button
  - Added proper error handling for orphaned entries
affects: manual-testing

# Tech tracking
tech-stack:
  added: []
  patterns: Controller-level rescue_from for RecordNotFound handling

key-files:
  created: []
  modified: app/controllers/transactions/ai_categorizations_controller.rb, app/views/transactions/_transaction.html.erb, test/controllers/transactions/ai_categorizations_controller_test.rb

key-decisions:
  - "Override StoreLocation concern's rescue_from at controller level"
  - "View sends entry.id not transaction.id (different UUIDs)"

patterns-established:
  - "Controller-level rescue_from overrides concern-level handlers"
  - "Individual AI categorize button uses entry.id as parameter"

issues-created: []

# Metrics
duration: 25min
completed: 2026-01-10
---

# Phase 14.1 Plan 1: Fix AI Categorize Route 404 Error

**Fixed 404 error on individual AI categorize button by correcting view to send entry.id instead of transaction.id**

## Performance

- **Duration:** 25 min
- **Started:** 2026-01-10T14:29:00Z
- **Completed:** 2026-01-10T14:48:00Z
- **Tasks:** 2
- **Files modified:** 3

## Accomplishments

- Fixed root cause: view was sending `transaction.id` but controller expects `entry.id` (different UUIDs)
- Added controller-level `rescue_from` to override StoreLocation concern's 404 handling
- Added test coverage for orphaned entry scenario
- 404 error now returns 422 with user-friendly error message

## Task Commits

Each task was committed atomically:

1. **Task 1: Add error handling for missing entryable** - `20556ea7` (fix)
2. **Task 2: Add test for orphaned entry scenario** - `3e13716e` (test)
3. **Fix: Override StoreLocation rescue_from** - `1d07e984` (fix)
4. **Fix: Send entry.id instead of transaction.id** - `b07d68d9` (fix)

**Plan metadata:** (to be added after docs commit)

## Files Created/Modified

- `app/controllers/transactions/ai_categorizations_controller.rb` - Added rescue_from override for proper error handling
- `app/views/transactions/_transaction.html.erb` - Changed from transaction.id to entry.id on line 131
- `test/controllers/transactions/ai_categorizations_controller_test.rb` - Added test for orphaned entry scenario

## Decisions Made

- **Override StoreLocation concern's rescue_from**: The concern's module-level `rescue_from ActiveRecord::RecordNotFound` catches exceptions before local handlers. Fixed by adding controller-level rescue_from.
- **View sends entry.id**: Entry and Transaction have different UUIDs. The approve/reject buttons correctly use entry.id, so AI categorize button should too.
- **Return 422 not 404**: Distinguishes "entry not found" (404 routing) from "entryable missing" (422 processing error).

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Root cause was view sending wrong ID**

- **Found during:** Task 3 (Human verification checkpoint)
- **Issue:** Plan diagnosed the issue as orphaned entries causing RecordNotFound, but the actual root cause was the view sending `transaction.id` instead of `entry.id`. These are different UUIDs in the delegated_type pattern.
- **Fix:** Changed `data-ai-categorize-transaction-id-value="<%= transaction.id %>"` to `data-ai-categorize-transaction-id-value="<%= entry.id %>"`
- **Files modified:** app/views/transactions/_transaction.html.erb
- **Verification:** Endpoint now returns 200 OK, AI categorization proceeds
- **Committed in:** `b07d68d9` (Task 3 fix)

**2. [Rule 1 - Bug] StoreLocation concern caught RecordNotFound before local handler**

- **Found during:** Task 1 implementation
- **Issue:** Module-level rescue_from in StoreLocation concern catches RecordNotFound before controller's begin/rescue block can handle it.
- **Fix:** Added controller-level rescue_from that overrides the concern's handler
- **Files modified:** app/controllers/transactions/ai_categorizations_controller.rb
- **Verification:** Test for orphaned entry passes, returns 422 not 404
- **Committed in:** `1d07e984` (Task 1 refinement)

### Deferred Enhancements

None.

---

**Total deviations:** 2 auto-fixed (both bugs, one discovered during verification)
**Impact on plan:** Both fixes were necessary for correct operation. The original plan's diagnosis was incomplete - the primary issue was the view sending the wrong ID.

## Issues Encountered

**Initial misdiagnosis:** Plan identified orphaned entries as the cause, but testing revealed the actual issue was the view sending transaction.id instead of entry.id. The Entry and Transaction have different UUIDs in the delegated_type pattern, so the controller couldn't find the Entry.

**Resolution:** Added proper error handling for both cases (orphaned entries AND wrong ID), and fixed the view to send the correct ID.

## Next Phase Readiness

- Phase 14.1 complete, ready to continue manual testing for v1.1 milestone
- AI categorization endpoint now works correctly (200 OK response)
- Orphaned entries return 422 with user-friendly error instead of 404

---

*Phase: 14.1-fix-ai-categorize-route*
*Completed: 2026-01-10*
