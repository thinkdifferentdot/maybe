---
phase: 14.1-fix-ai-categorize-route
type: execute
domain: rails
---

<objective>
Fix 404 error when clicking individual AI categorize button on transactions.

Purpose: The AI categorize button returns 404 because when `@entry.entryable` is accessed, if the Transaction record doesn't exist (orphaned entry), it raises `ActiveRecord::RecordNotFound`. This is caught by the `StoreLocation` concern's `rescue_from` block which returns 404.

Output: AI categorize button works correctly for all transactions, with proper error handling for edge cases.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key files:
@app/controllers/transactions/ai_categorizations_controller.rb
@app/models/family/auto_categorizer.rb
@app/models/entry.rb
@config/routes.rb

# Root cause analysis:
The route `/transactions/ai_categorization` exists and is correctly defined. The controller is being invoked. The Entry is successfully loaded from the database (confirmed by logs). However, when the controller accesses `@entry.entryable` to get the Transaction, if the Transaction record doesn't exist (orphaned entry with missing entryable), Rails raises `ActiveRecord::RecordNotFound`.

This exception is caught by the `StoreLocation` concern's `rescue_from ActiveRecord::RecordNotFound` handler, which calls `handle_not_found`, which does `head :not_found` (404).

# The fix:
Add proper error handling in the controller to catch the case where the entryable (Transaction) doesn't exist, and return a user-friendly error instead of a 404.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add error handling for missing entryable in AiCategorizationsController</name>
  <files>app/controllers/transactions/ai_categorizations_controller.rb</files>
  <action>Add a check after loading @entry to verify the entryable (Transaction) exists. If entryable is nil, render a user-friendly error response with turbo_stream format. Also wrap the entryable access in a begin/rescue block to catch ActiveRecord::RecordNotFound specifically.

The fix should:
1. Check if @entry.entryable exists and is a Transaction
2. If nil or not found, respond with flash error and unprocessable_entity status
3. Use specific exception handling (RecordNotFound) rather than broad rescue</action>
  <verify>bin/rails test test/controllers/transactions/ai_categorizations_controller_test.rb passes</verify>
  <done>Entry with missing entryable returns 422 with error message, not 404</done>
</task>

<task type="auto">
  <name>Task 2: Add test for orphaned entry scenario</name>
  <files>test/controllers/transactions/ai_categorizations_controller_test.rb</files>
  <action>Add a test case that simulates an orphaned entry (Entry exists but Transaction was deleted). The test should:
1. Create an entry with a transaction
2. Delete the transaction directly (via SQL) to create orphaned entry
3. POST to ai_categorization endpoint with the orphaned entry_id
4. Expect response to be 422 (unprocessable_entity) not 404
5. Expect flash error message to be set

This ensures the fix handles the edge case properly and prevents regression.</action>
  <verify>bin/rails test test/controllers/transactions/ai_categorizations_controller_test.rb -n test_handles_orphaned_entry passes</verify>
  <done>Test confirms orphaned entries return 422 not 404</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Fixed 404 error on AI categorize button with proper error handling for orphaned entries</what-built>
  <how-to-verify>
    1. Start dev server: bin/dev
    2. Navigate to http://localhost:3000/transactions
    3. Click the AI categorize (sparkles) button on a transaction
    4. Verify: The categorization works and category is updated
    5. Verify: Confidence badge appears after categorization
    6. Verify: No 404 error in browser console
    7. Verify: No error in Rails logs about 404

    (Optional - for orphaned entry test):
    1. In Rails console, create an orphaned entry by deleting a transaction directly
    2. Try clicking AI categorize on that transaction in UI
    3. Verify: User sees error message, not 404
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `bin/rails test test/controllers/transactions/ai_categorizations_controller_test.rb` passes
- [ ] `bin/rails test test/controllers/transactions/bulk_ai_categorizations_controller_test.rb` passes (no regressions)
- [ ] AI categorize button works in browser without 404 error
- [ ] Orphaned entry scenario returns 422 not 404
</verification>

<success_criteria>

- All tasks completed
- AI categorize button works for normal transactions
- Orphaned entries (missing entryable) return 422 with error message, not 404
- No regressions in existing AI categorization tests
  </success_criteria>

<output>
After completion, create `.planning/phases/14.1-fix-ai-categorize-route/14.1-01-SUMMARY.md`:

# Phase 14.1 Plan 1: Fix AI Categorize Route 404 Error

**Fixed 404 error on individual AI categorize button by adding proper error handling for orphaned entries**

## Accomplishments

- Added error handling for missing entryable in AiCategorizationsController
- Added test coverage for orphaned entry scenario
- 404 error now returns 422 with user-friendly error message

## Files Created/Modified

- `app/controllers/transactions/ai_categorizations_controller.rb` - Added entryable existence check and RecordNotFound handling
- `test/controllers/transactions/ai_categorizations_controller_test.rb` - Added test for orphaned entry scenario

## Decisions Made

- Catch RecordNotFound specifically rather than broad rescue
- Return 422 (unprocessable_entity) for missing entryable to distinguish from routing 404
- Include user-friendly error message in flash

## Issues Encountered

Orphaned entries (Entry exists but Transaction was deleted) were causing 404 due to StoreLocation concern catching RecordNotFound. Fixed by handling this case explicitly in the controller.

## Next Step

Phase 14.1 complete, ready to continue manual testing for v1.1 milestone.
</output>
