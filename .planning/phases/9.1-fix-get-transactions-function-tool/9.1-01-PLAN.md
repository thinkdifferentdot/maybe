---
phase: 9.1-fix-get-transactions-function-tool
plan: 01
type: execute
domain: rails
---

<objective>
Fix get_transactions function tool to handle Anthropic's symbol-keyed arguments.

**Problem:** Anthropic Claude passes function arguments with symbol keys (e.g., `{page: 1, order: "desc"}`), but `GetTransactions#call` uses `params.except("order", "page")` which only removes string keys. This causes `Transaction::Search.new` to receive unknown attributes and raise `"unknown attribute 'page' for Transaction::Search"`.

**Root Cause:** The Anthropic Ruby SDK symbolizes JSON response keys, so `block[:input]` returns a Hash with symbol keys. OpenAI's SDK returns string keys. The `except` call in GetTransactions uses string arguments, so it fails to filter out symbol-keyed parameters.

**Solution:** Update `GetTransactions#call` to exclude both string and symbol keys for `page` and `order` parameters.

Purpose: Enable AI chat with function calling to work correctly when using Anthropic provider.

Output: Working get_transactions function for both OpenAI (string keys) and Anthropic (symbol keys).
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key files for this bug fix:
@app/models/assistant/function/get_transactions.rb
@app/models/transaction/search.rb
@app/models/provider/anthropic/chat_parser.rb
@app/models/provider/openai/chat_parser.rb

# Tech stack available:
- Ruby on Rails 7.x
- ActiveModel::Attributes for Transaction::Search
- anthropic gem with symbolized keys
- ruby-openai gem with string keys

# Established patterns:
- Function params are passed via FunctionToolCaller#parse_function_args which handles both Hash and JSON string
- Anthropic passes Hash with symbol keys; OpenAI passes parsed JSON with string keys
- Use Hash#except with both string and symbol keys for compatibility

# Relevant prior decisions:
- Phase 3-03: Anthropic's input is already a Hash (not JSON string like OpenAI)
- Phase 8-01: Fixed ChatParser to use symbol keys (:id, :content, :type) - Anthropic SDK returns BaseModel with symbolized keys from to_h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix GetTransactions#call to handle symbol-keyed params from Anthropic</name>
  <files>app/models/assistant/function/get_transactions.rb</files>
  <action>Update the `call` method to exclude both string and symbol versions of "page" and "order" keys from params before passing to Transaction::Search. Change:

```ruby
search_params = params.except("order", "page")
```

To handle both string and symbol keys:

```ruby
search_params = params.except("order", "page", :order, :page)
```

This ensures compatibility with both OpenAI (string keys) and Anthropic (symbol keys) providers. No other changes needed - Transaction::Search already correctly handles the filtered parameters.</action>
  <verify>Run `bin/rails test test/models/provider/anthropic_test.rb` to ensure existing tests still pass. If function calling tests exist, verify they pass with symbol-keyed params.</verify>
  <done>GetTransactions#call correctly filters out both string and symbol keys for order and page before passing to Transaction::Search</done>
</task>

<task type="auto">
  <name>Task 2: Test the fix manually with Anthropic chat to verify function calling works</name>
  <files>app/models/assistant/function/get_transactions.rb</files>
  <action>Create a simple verification by checking that params.except with both string and symbol keys works correctly. In Rails console or test:

```ruby
params = {page: 1, order: "desc", search: "mcdonalds"}
search_params = params.except("order", "page", :order, :page)
# Expected: {search: "mcdonaldds"}

params2 = {"page" => 1, "order" => "desc", "search" => "mcdonalds"}
search_params2 = params2.except("order", "page", :order, :page)
# Expected: {"search" => "mcdonalds"}
```

Also verify Transaction::Search.new doesn't raise error with symbol-keyed params after filtering.</action>
  <verify>Run `bin/rails test` to ensure no regressions. The fix should be trivial but verify all existing assistant/function tests pass.</verify>
  <done>Both string-keyed and symbol-keyed params are correctly filtered before passing to Transaction::Search</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Fix for get_transactions function tool to handle Anthropic's symbol-keyed arguments</what-built>
  <how-to-verify>
    1. Run: `bin/rails test` - all tests should pass
    2. (Optional but ideal) Test AI chat with Anthropic provider:
       - Set llm_provider to "anthropic" in settings
       - Add valid ANTHROPIC_API_KEY
       - Open AI chat and ask: "Show me my transactions from the last 30 days"
       - Verify: get_transactions function is called successfully without errors
    3. Verify OpenAI provider still works (if available)
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `bin/rails test` passes all tests
- [ ] params.except correctly removes both string and symbol keys
- [ ] Transaction::Search.new receives only valid attributes
- [ ] No regression to OpenAI provider functionality
</verification>

<success_criteria>

- GetTransactions#call handles both string-keyed (OpenAI) and symbol-keyed (Anthropic) params
- AI chat with function calling works with Anthropic provider
- No regressions to OpenAI provider
- All existing tests pass
  </success_criteria>

<output>
After completion, create `.planning/phases/9.1-fix-get-transactions-function-tool/9.1-01-SUMMARY.md`:

# Phase 9.1 Plan 1: Fix get_transactions Function Tool Summary

**Fixed get_transactions to handle Anthropic's symbol-keyed function arguments**

## Accomplishments

- Updated GetTransactions#call to exclude both string and symbol keys for order and page
- Verified compatibility with both OpenAI (string keys) and Anthropic (symbol keys) providers
- Transaction::Search now receives only valid attributes regardless of provider

## Files Created/Modified

- `app/models/assistant/function/get_transactions.rb` - Updated params.except to handle both string and symbol keys

## Decisions Made

**Decision 1: Use Hash#except with both string and symbol keys**
- Context: Anthropic SDK symbolizes JSON keys, OpenAI uses string keys
- Rationale: Adding both key types to except() ensures compatibility without requiring key conversion
- Impact: Single-line change, minimal risk, works for both providers

## Issues Encountered

None expected - straightforward fix for key type mismatch

## Deviations from Plan

None expected

## Next Step

Phase 9.1 complete. Ready to continue with remaining work (Phase 10 - Settings & Config for v1.1 milestone, or return to Phase 8-03 if provider switching tests need verification).
</output>
