---
phase: 28-standardize-error-handling
plan: 01
type: execute
domain: rails
---

<objective>
Standardize error handling across AI provider auto-categorizer and auto-merchant-detector classes.

Purpose: Ensure consistent error handling patterns, improve debugging with specific error messages, and reduce code duplication.

Output: Shared Provider::Concerns::ErrorHandler module with standardized error handling for all 4 provider classes (Anthropic::AutoCategorizer, Anthropic::AutoMerchantDetector, OpenAI::AutoCategorizer, OpenAI::AutoMerchantDetector).
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Codebase context for error handling patterns:
@app/models/provider/anthropic/auto_categorizer.rb
@app/models/provider/anthropic/auto_merchant_detector.rb
@app/models/provider/openai/auto_categorizer.rb
@app/models/provider/openai/auto_merchant_detector.rb
@app/models/provider/anthropic.rb
@app/models/provider/openai.rb
@app/models/provider/concerns/usage_recorder.rb
@app/models/provider/concerns/json_parser.rb

# Prior phase context (Provider::Concerns pattern established):
@.planning/phases/25-extract-json-parser/25-01-SUMMARY.md
@.planning/phases/20-extract-usage-recorder-concern/20-01-SUMMARY.md

**Tech stack available:**
- Provider::Concerns namespace pattern (established in Phase 20, 25)
- ActiveSupport::Concern for module inclusion
- Provider::Anthropic::Error and Provider::Openai::Error classes
- Langfuse span integration for error logging
- Anthropic SDK error classes: Anthropic::Errors::APIConnectionError, APITimeoutError, RateLimitError, AuthenticationError, APIStatusError
- Faraday error classes: Faraday::BadRequestError (used by OpenAI classes for HTTP 400 fallback)
- JSON::ParserError for JSON parsing failures

**Established patterns:**
- Extract duplicated methods to Provider::Concerns namespace
- Use include Provider::Concerns::* in provider classes
- Private methods for implementation details
- Proper span&.end(output: { error: ... }, level: "ERROR") for Langfuse tracing

**Key decisions affecting this phase:**
- Phase 25 decision: Use Provider::Anthropic::Error for JSON parsing failures in shared concern - OpenAI classes rescue and re-raise as their own error type if needed
- OpenAI classes use Faraday::BadRequestError for strict JSON mode fallback logic (lines 169-178 in auto_categorizer, 182-191 in auto_merchant_detector)

**Key files:**
- app/models/provider/concerns/json_parser.rb - Reference for concern structure
- app/models/provider/concerns/usage_recorder.rb - Reference for concern structure
- app/models/provider/anthropic/auto_merchant_detector.rb - Lines 55-76: Comprehensive error handling pattern to replicate
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Provider::Concerns::ErrorHandler module</name>
  <files>app/models/provider/concerns/error_handler.rb</files>
  <action>Create shared error handling concern following the pattern established in JsonParser and UsageRecorder. Include:

1. Module definition with ActiveSupport::Concern
2. rescue_with_handler method that wraps API calls with standardized error handling
3. Provider-specific error translation methods:
   - handle_anthropic_error(e, span:) - converts Anthropic SDK errors to Provider::Anthropic::Error with descriptive messages
   - handle_openai_error(e, span:) - converts Faraday/OpenAI errors to Provider::Openai::Error
4. Generic fallback handler for unexpected errors
5. Proper span&.end(output: { error: ... }, level: "ERROR") for all error paths

Error categories to handle for Anthropic:
- Anthropic::Errors::APIConnectionError → "Failed to connect to Anthropic API"
- Anthropic::Errors::APITimeoutError → "Anthropic API request timed out"
- Anthropic::Errors::RateLimitError → "Anthropic API rate limit exceeded"
- Anthropic::Errors::AuthenticationError → "Anthropic API authentication failed"
- Anthropic::Errors::APIStatusError → "Anthropic API error (status)"
- JSON::ParserError → "Invalid JSON response from Anthropic"
- Generic → "Unexpected error during [operation]"

Error categories to handle for OpenAI:
- Faraday::BadRequestError → Special handling for JSON mode fallback (caller should handle)
- Faraday::ConnectionError → "Failed to connect to OpenAI API"
- JSON::ParserError → "Invalid JSON response from OpenAI"
- Generic → "Unexpected error during [operation]"

Do NOT implement Faraday::BadRequestError fallback logic in the concern - that's specific to the auto_categorize_openai_generic methods and should remain inline.</action>
  <verify>File exists at app/models/provider/concerns/error_handler.rb with all required methods. Module follows same structure as json_parser.rb and usage_recorder.rb.</verify>
  <done>ErrorHandler concern created with provider-specific error translation methods and span integration</done>
</task>

<task type="auto">
  <name>Task 2: Refactor Anthropic::AutoCategorizer to use shared ErrorHandler</name>
  <files>app/models/provider/anthropic/auto_categorizer.rb</files>
  <action>Update Anthropic::AutoCategorizer:
1. Add "include Provider::Concerns::ErrorHandler" after the existing includes
2. Replace current generic rescue block (lines 56-59) with specific error handling using the concern
3. Wrap the auto_categorize method body with rescue_with_handler for Anthropic errors
4. Ensure all error types from Anthropic SDK are properly caught and translated
5. Keep span logging for errors

Current rescue block is too generic - should catch specific Anthropic SDK errors like AutoMerchantDetector does.

Use pattern:
```ruby
rescue_with_handler(:anthropic, span: span, operation: "auto_categorize") do
  # ... existing API call code ...
end
```

Or implement specific rescues that call concern methods:
```ruby
rescue Anthropic::Errors::APIConnectionError => e
  handle_anthropic_connection_error(e, span:)
  raise Provider::Anthropic::Error, "Failed to connect to Anthropic API: #{e.message}"
rescue Anthropic::Errors::APITimeoutError => e
  # ... etc
```

The concern should provide a with_anthropic_error_handler(span:, operation:) method that yields the block and handles all Anthropic-specific errors.</action>
  <verify>Anthropic::AutoCategorizer has comprehensive error handling matching AutoMerchantDetector pattern. All specific Anthropic SDK errors are caught. No regressions in test suite.</verify>
  <done>Anthropic::AutoCategorizer uses shared ErrorHandler with comprehensive error handling for all Anthropic SDK error types</done>
</task>

<task type="auto">
  <name>Task 3: Update Anthropic::AutoMerchantDetector to use shared ErrorHandler</name>
  <files>app/models/provider/anthropic/auto_merchant_detector.rb</files>
  <action>Update Anthropic::AutoMerchantDetector to use the shared ErrorHandler concern:
1. Add "include Provider::Concerns::ErrorHandler"
2. Replace the comprehensive rescue block (lines 55-76) with calls to concern methods
3. Ensure all error handling behavior is preserved (same error messages, span logging)
4. This is the reference implementation - verify the concern produces identical results

The rescue block should become simpler, using concern methods like:
```ruby
rescue Anthropic::Errors::APIConnectionError => e
  handle_anthropic_connection_error(e, span:)
  raise Provider::Anthropic::Error, "Failed to connect to Anthropic API: #{e.message}"
```

But extracted into the concern so the class doesn't need to know all the specific error types.</action>
  <verify>Anthropic::AutoMerchantDetector uses shared ErrorHandler. Error handling behavior is identical to before (same error messages, same span logging). All tests pass.</verify>
  <done>Anthropic::AutoMerchantDetector refactored to use shared ErrorHandler while preserving all error handling behavior</done>
</task>

<task type="auto">
  <name>Task 4: Refactor OpenAI::AutoCategorizer to use shared ErrorHandler</name>
  <files>app/models/provider/openai/auto_categorizer.rb</files>
  <action>Update OpenAI::AutoCategorizer:
1. Add "include Provider::Concerns::ErrorHandler"
2. Replace generic rescue blocks with concern methods
3. Keep the Faraday::BadRequestError fallback logic inline (it's specific to JSON mode retry logic)
4. Ensure OpenAI-specific error types are caught: ConnectionError, JSON::ParserError
5. Translate errors to Provider::Openai::Error

Note: The Faraday::BadRequestError rescue at lines 169-178 is part of the JSON mode fallback logic and should remain as-is. Only replace the generic rescue => e blocks.

Generic rescues (lines 158-161, 258-261) should use the concern's handle_openai_error method.</action>
  <verify>OpenAI::AutoCategorizer uses shared ErrorHandler for generic errors. Faraday::BadRequestError fallback logic is preserved. All tests pass.</verify>
  <done>OpenAI::AutoCategorizer uses shared ErrorHandler while preserving JSON mode fallback logic</done>
</task>

<task type="auto">
  <name>Task 5: Refactor OpenAI::AutoMerchantDetector to use shared ErrorHandler</name>
  <files>app/models/provider/openai/auto_merchant_detector.rb</files>
  <action>Update OpenAI::AutoMerchantDetector:
1. Add "include Provider::Concerns::ErrorHandler"
2. Replace generic rescue blocks with concern methods
3. Keep the Faraday::BadRequestError fallback logic inline
4. Ensure OpenAI-specific error types are caught
5. Translate errors to Provider::Openai::Error

Same pattern as AutoCategorizer - preserve the Faraday::BadRequestError fallback but use concern for generic error handling.</action>
  <verify>OpenAI::AutoMerchantDetector uses shared ErrorHandler. Faraday::BadRequestError fallback logic is preserved. All tests pass.</verify>
  <done>OpenAI::AutoMerchantDetector uses shared ErrorHandler while preserving JSON mode fallback logic</done>
</task>

<task type="auto">
  <name>Task 6: Run tests and verify no regressions</name>
  <files></files>
  <action>Run full provider test suite to verify:
1. All existing error handling behavior is preserved
2. No regressions in auto-categorization or merchant detection
3. Error messages are still descriptive and helpful
4. Langfuse span error logging still works correctly

Command: bin/rails test test/models/provider/

Check that all provider tests pass (expected ~174 tests based on Phase 25 results).</action>
  <verify>bin/rails test test/models/provider/ passes with all tests. No new errors or warnings introduced.</verify>
  <done>All provider tests passing. Error handling behavior verified to be identical to pre-refactoring state.</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] bin/rails test test/models/provider/ passes (all ~174 tests)
- [ ] All 4 provider classes include Provider::Concerns::ErrorHandler
- [ ] Error messages are descriptive and include context
- [ ] Langfuse span error logging works for all error types
- [ ] No code duplication in error handling across provider classes
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Error handling is consistent across all 4 provider classes
- Shared ErrorHandler concern follows established patterns
</success_criteria>

<output>
After completion, create `.planning/phases/28-standardize-error-handling/28-01-SUMMARY.md`:

# Phase 28 Plan 1: Standardize Error Handling Summary

**Created shared Provider::Concerns::ErrorHandler module and refactored all 4 provider classes to use consistent error handling patterns.**

## Accomplishments

- Created shared Provider::Concerns::ErrorHandler with provider-specific error translation
- Refactored Anthropic::AutoCategorizer, Anthropic::AutoMerchantDetector, OpenAI::AutoCategorizer, OpenAI::AutoMerchantDetector to use shared concern
- Eliminated ~[X] lines of duplicate error handling code
- Comprehensive error handling for all SDK-specific error types
- All [X] provider tests passing with no regressions

## Files Created/Modified

- `app/models/provider/concerns/error_handler.rb` - NEW: Shared concern with standardized error handling
- `app/models/provider/anthropic/auto_categorizer.rb` - MODIFIED: Uses ErrorHandler, improved error specificity
- `app/models/provider/anthropic/auto_merchant_detector.rb` - MODIFIED: Refactored to use ErrorHandler
- `app/models/provider/openai/auto_categorizer.rb` - MODIFIED: Uses ErrorHandler
- `app/models/provider/openai/auto_merchant_detector.rb` - MODIFIED: Uses ErrorHandler

## Decisions Made

- ErrorHandler provides with_anthropic_error_handler and with_openai_error_handler methods
- OpenAI Faraday::BadRequestError fallback logic remains inline (specific to JSON mode retry)
- Error messages are descriptive and include original error context
- All errors are logged to Langfuse spans with level: "ERROR"

## Issues Encountered

[Document any issues found during implementation]

## Next Phase Readiness

Phase 28 complete - ready for Phase 29: Improve Categorization Prompts.

Error handling is now consistent across all AI provider classes. The ErrorHandler concern follows the established pattern from JsonParser and UsageRecorder.
</output>
