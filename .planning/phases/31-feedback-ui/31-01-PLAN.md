---
phase: 31-feedback-ui
type: execute
---

<objective>
Add user feedback interface for AI categorization results with checkmark/X approval buttons.

Purpose: Enable explicit user feedback on AI categorizations to create clean training data for pattern learning and future accuracy tracking.

Output: Working feedback UI in two contexts (transaction detail page, review screen) that creates/updates LearnedPattern records on approval.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-feedback-ui/31-CONTEXT.md
@.planning/phases/30-learned-pattern-integration/30-01-SUMMARY.md

# Key files from prior phases:
@app/models/learned_pattern.rb
@app/models/family/auto_categorizer.rb
@app/controllers/transactions/ai_categorizations_controller.rb
@app/views/transactions/_confidence_badge.html.erb
@app/views/transactions/_transaction_category.html.erb
@app/views/transactions/show.html.erb
@app/javascript/controllers/ai_categorize_controller.js

# Conventions to follow:
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/STRUCTURE.md
@.planning/codebase/TESTING.md

# Locale file for i18n keys:
@config/locales/views/transactions/en.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AI feedback controller with approve/reject actions</name>
  <files>app/controllers/transactions/ai_feedbacks_controller.rb, config/routes.rb</files>

  <action>Create Transactions::AifeedbacksController with two actions (approve, reject):

**Approve action:**
- Finds transaction by params[:transaction_id]
- Creates LearnedPattern record from transaction's merchant and category
- Sets pattern manually_confirmed = true if adding field (optional, can defer)
- Returns Turbo Stream replacing feedback UI with "Approved" state
- Use i18n key "transactions.approval_success" for flash message

**Reject action:**
- Finds transaction by params[:transaction_id]
- Removes category (sets category_id to nil)
- Clears ai_categorization_confidence from extra metadata
- Returns Turbo Stream replacing feedback UI with "Rejected" state
- Use i18n key "transactions.rejection_success" for flash message

**Routes:**
- Add nested resource: `resource :ai_feedback, only: [], controller: :ai_feedbacks do { post :approve; post :reject } end` under transactions namespace

**Error handling:**
- Rescue from ActiveRecord::RecordNotFound with head :unprocessable_entity
- Validate transaction has AI-categorized category (extra has ai_categorization_confidence)
- Use before_action to authenticate family

**Why this structure:** Follows existing ai_categorizations_controller pattern. Controller handles both business logic (LearnedPattern creation) and UI updates (Turbo Stream).</action>

  <verify>bin/rails routes | grep ai_feedback shows approve/reject routes nested under transactions</verify>

  <done>Controller created with approve/reject actions, routes added, both return Turbo Stream responses</done>
</task>

<task type="auto">
  <name>Task 2: Create feedback buttons Stimulus controller</name>
  <files>app/javascript/controllers/ai_feedback_controller.js</files>

  <action>Create Stimulus controller ai_feedback_controller.js:

**Targets:** button, icon, container

**Values:** transactionId (String), feedbackType (String, "approve" or "reject")

**Actions:**
- send(event) - POSTs to approve/reject endpoint with CSRF token
- Accepts text/vnd.turbo-stream.html response
- Handles loading state (spinner during request)
- Handles errors (shows flash notification)

**Loading state:**
- Disable both buttons in container
- Show spinner icon in clicked button
- Set aria-busy="true"

**Success behavior:**
- Turbo replaces content with stream response
- No manual DOM manipulation needed

**Error handling:**
- Re-enable buttons on error
- Dispatch flash:show event with error message
- Log to console with "[AI Feedback]" prefix

**Pattern to follow:** Copy structure from ai_categorize_controller.js, adapted for feedback (approve/reject) instead of categorization</action>

  <verify>File exists at app/javascript/controllers/ai_feedback_controller.js with send action and error handling</verify>

  <done>Controller sends POST to feedback endpoint, handles loading state and errors, integrates with Turbo Streams</done>
</task>

<task type="auto">
  <name>Task 3: Create feedback buttons partial for transaction detail page</name>
  <files>app/views/transactions/_ai_feedback_buttons.html.erb, app/views/transactions/_transaction_category.html.erb</files>

  <action>Create _ai_feedback_buttons.html.erb partial:

**Accepts locals:** transaction (required)

**Structure:**
```erb
<div data-controller="ai_feedback" data-ai-feedback-transaction-id-value="<%= transaction.id %>">
  <% if transaction.ai_categorized? %>
    <%= button_to approve_transaction_ai_feedback_path(transaction),
          method: :post,
          data: { ai_feedback_target: "button", turbo_stream: true },
          class: "..." do %>
      <%= icon "check", size: "sm", color: "success" %>
    <% end %>

    <%= button_to reject_transaction_ai_feedback_path(transaction),
          method: :post,
          data: { ai_feedback_target: "button", turbo_stream: true },
          class: "..." do %>
      <%= icon "x", size: "sm", color: "destructive" %>
    <% end %>

    <!-- Already given feedback state -->
    <% if transaction.extra["ai_feedback_given"] %>
      <span class="text-xs text-secondary">Feedback recorded</span>
    <% end %>
  <% end %>
</div>
```

**Helper method needed:** Add `ai_categorized?` to Transaction model or use existing logic (extra has ai_categorization_confidence)

**Styling:**
- Use design system colors (success for check, destructive for X)
- Small, unobtrusive buttons next to confidence badge
- Hide after feedback given (show "recorded" message)

**Integration:**
- Update _transaction_category.html.erb to include feedback buttons after confidence badge
- Only show when transaction was AI-categorized (has confidence in extra)</action>

  <verify>Partial renders checkmark/X buttons next to category, buttons POST to approve/reject routes</verify>

  <done>Partial created and integrated into transaction category display, buttons only show for AI-categorized transactions</done>
</task>

<task type="auto">
  <name>Task 4: Add feedback state tracking and update AutoCategorizer</name>
  <files>app/models/transaction.rb, app/models/learned_pattern.rb, app/controllers/transactions/ai_feedbacks_controller.rb</files>

  <action>Update models and controller:

**Transaction model:**
- Add `ai_categorized?` instance method: `extra["ai_categorization_confidence"].present?`
- Add `ai_feedback_given?` instance method: `extra["ai_feedback_given"].present?`

**LearnedPattern model (optional enhancement):**
- Consider adding `manually_confirmed` boolean column (future work, defer for now)
- For this phase: use creation timestamp as implicit confirmation signal

**Controller updates:**
- In approve action: After creating LearnedPattern, update transaction.extra with `ai_feedback_given: true`
- In reject action: After removing category, update transaction.extra with `ai_feedback_given: true, ai_feedback: "rejected"`
- Use `update_column(:extra, ...)` to skip validations and callbacks

**Why update_column:** Extra is a JSON column, we want to update it without triggering full model validation</action>

  <verify>Transaction#ai_categorized? returns true for transactions with confidence in extra metadata</verify>

  <done>Helper methods added, feedback state tracked in transaction.extra, controller updates state after approve/reject</done>
</task>

<task type="auto">
  <name>Task 5: Create review screen for recent AI categorizations</name>
  <files>app/controllers/transactions/reviews_controller.rb, app/views/transactions/reviews/index.html.erb, config/routes.rb</files>

  <action>Create review screen for batch feedback on recent AI categorizations:

**Controller (Transactions::ReviewsController#index):**
- Fetch transactions with ai_categorization_confidence present
- Exclude those with ai_feedback_given already
- Order by updated_at DESC (most recent first)
- Limit to 50 transactions (manageable batch)
- Paginate if needed (use Kaminari or will_paginate if available, else simple limit/offset)

**Routes:**
- Add `resources :reviews, only: :index, controller: :reviews` under transactions namespace
- Route: /transactions/reviews

**View (reviews/index.html.erb):**
- Page title: "Review AI Categorizations"
- Table layout: Transaction name | Merchant | Suggested Category | Confidence | Actions
- Each row renders _ai_feedback_buttons partial
- Use DS::Table or similar pattern if exists
- Empty state: "No recent AI categorizations to review"

**Styling:**
- Follow existing transactions index layout
- Show confidence badge (reuse _confidence_badge partial)
- Show category badge (reuse _category_badge partial)

**Why separate screen:** Dedicated space for focused feedback review, separate from main transactions list</action>

  <verify>GET /transactions/reviews returns page with table of AI-categorized transactions</verify>

  <done>Review screen created showing recent AI categorizations with approve/reject buttons for each</done>
</task>

<task type="auto">
  <name>Task 6: Update Turbo Stream responses for feedback states</name>
  <files>app/controllers/transactions/ai_feedbacks_controller.rb, app/views/transactions/ai_feedbacks/_approve.turbo_stream.erb, app/views/transactions/ai_feedbacks/_reject.turbo_stream.erb</files>

  <action>Create Turbo Stream templates for feedback responses:

**_approve.turbo_stream.erb:**
```erb
<%# Replace feedback buttons with "Approved" state %>
<%= turbo_stream.replace dom_id(@transaction, "ai_feedback") do %>
  <span class="inline-flex items-center gap-1 text-xs text-success">
    <%= icon "check-circle", size: "xs", color: "success" %>
    <%= t("transactions.feedback_approved") %>
  </span>
<% end %>

<%# Update confidence badge to show "confirmed" %>
<%= turbo_stream.replace "#{dom_id(@transaction, "confidence_badge")}" do %>
  <%= render "transactions/confidence_badge", transaction: @transaction, confirmed: true %>
<% end %>

<%# Show flash message %>
<%= turbo_stream.append "flash" do %>
  <%= render "flash", type: :success, message: t("transactions.approval_success") %>
<% end %>
```

**_reject.turbo_stream.erb:**
```erb
<%# Replace feedback buttons with "Rejected" state %>
<%= turbo_stream.replace dom_id(@transaction, "ai_feedback") do %>
  <span class="inline-flex items-center gap-1 text-xs text-destructive">
    <%= icon "x-circle", size: "xs", color: "destructive" %>
    <%= t("transactions.feedback_rejected") %>
  </span>
<% end %>

<%# Update category menu to show uncategorized %>
<%= turbo_stream.replace "#{dom_id(@transaction, "category_menu")}" do %>
  <%= render "transactions/transaction_category", transaction: @transaction.reload %>
<% end %>

<%# Show flash message %>
<%= turbo_stream.append "flash" do %>
  <%= render "flash", type: :success, message: t("transactions.rejection_success") %>
<% end %>
```

**i18n keys to add:**
- transactions.feedback_approved: "Approved"
- transactions.feedback_rejected: "Rejected"

**Controller updates:**
- Change respond_to block to render these templates instead of inline streams
- Set @transaction instance variable for template access</action>

  <verify>Turbo Stream templates exist and render correct replacements for feedback state</verify>

  <done>Stream templates created, controller renders them, feedback state updates without page reload</done>
</task>

<task type="auto">
  <name>Task 7: Add i18n keys for feedback UI</name>
  <files>config/locales/views/transactions/en.yml</files>

  <action>Add localization keys for feedback UI:

```yaml
feedback:
  title: Review AI Categorizations
  empty_state: No recent AI categorizations to review
  transaction: Transaction
  merchant: Merchant
  suggested_category: Suggested Category
  confidence: Confidence
  actions: Actions
  feedback_approved: Approved
  feedback_rejected: Rejected
  approve_button: Approve
  reject_button: Reject
  approve_title: Approve this categorization and create a learned pattern
  reject_title: Reject this categorization and remove the category
```

**Note:** Some keys already exist (approve_ai, reject_ai, approval_success, rejection_success) â€” add only new ones needed.

**Follow existing pattern:** Use hierarchical keys under transactions.feedback.*</action>

  <verify>config/locales/views/transactions/en.yml has feedback.* keys defined</verify>

  <done>All i18n keys added, feedback UI uses localized strings</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete feedback UI for AI categorization with approve/reject buttons in two contexts</what-built>

  <how-to-verify>
    1. Run: bin/dev
    2. Visit: http://localhost:3000/transactions
    3. Click "AI Categorize" on an uncategorized transaction
    4. Verify: Confidence badge appears next to category
    5. Verify: Checkmark/X buttons appear next to confidence badge
    6. Click: Checkmark button to approve
    7. Verify: Buttons replace with "Approved" state
    8. Verify: Flash message shows "Pattern learned!"
    9. Verify: LearnedPattern record created in database
    10. Visit: http://localhost:3000/transactions/reviews
    11. Verify: Review screen shows recent AI categorizations
    12. Test: Reject flow (X button removes category)
    13. Verify: Transaction becomes uncategorized after rejection
  </how-to-verify>

  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] bin/rails test test/controllers/transactions/ai_feedbacks_controller_test.rb passes
- [ ] bin/rails test test/controllers/transactions/reviews_controller_test.rb passes
- [ ] bin/rails test test/javascript/controllers/ai_feedback_controller_test.js passes (if JS tests exist)
- [ ] All existing tests still pass (bin/rails test)
- [ ] Manual verification confirms feedback UI works in both contexts
- [ ] i18n keys exist for all user-facing strings
</verification>

<success_criteria>

- Feedback buttons appear for AI-categorized transactions
- Approve action creates LearnedPattern record
- Reject action removes category and updates metadata
- Review screen displays recent AI categorizations
- Turbo Stream updates UI without page reload
- All user-facing strings are internationalized
- No regressions in existing AI categorization flow
  </success_criteria>

<output>
After completion, create `.planning/phases/31-feedback-ui/31-01-SUMMARY.md`:

# Phase 31 Plan 1: Feedback UI Summary

**[One-liner describing what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `app/controllers/transactions/ai_feedbacks_controller.rb` - NEW
- `app/controllers/transactions/reviews_controller.rb` - NEW
- `app/views/transactions/_ai_feedback_buttons.html.erb` - NEW
- `app/views/transactions/ai_feedbacks/_approve.turbo_stream.erb` - NEW
- `app/views/transactions/ai_feedbacks/_reject.turbo_stream.erb` - NEW
- `app/views/transactions/reviews/index.html.erb` - NEW
- `app/javascript/controllers/ai_feedback_controller.js` - NEW
- `app/models/transaction.rb` - Added ai_categorized?, ai_feedback_given? methods
- `config/routes.rb` - Added ai_feedback and reviews routes
- `config/locales/views/transactions/en.yml` - Added feedback i18n keys

## Decisions Made

- Feedback state tracked in transaction.extra (no new DB columns)
- Review screen limited to 50 recent transactions (manageable batch)
- Used existing LearnedPattern model (no schema changes)
- Followed existing ai_categorizations_controller pattern for consistency

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for Phase 32: Accuracy Metrics - track and display categorization accuracy metrics over time using feedback data
</output>
