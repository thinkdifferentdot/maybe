---
phase: 30-learned-pattern-integration
plan: 01
type: execute
---

<objective>
Enhance the FewShotExamples concern to use relevance-based LearnedPattern selection instead of random sampling.

Purpose: Improve AI categorization accuracy by presenting the user's actual merchant patterns as "strong hints" rather than generic examples.
Output: FewShotExamples concern that selects relevant LearnedPatterns by merchant matching and presents them in a separate prompt section.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-learned-pattern-integration/30-CONTEXT.md

# Key files from Phase 29:
@app/models/provider/concerns/few_shot_examples.rb
@app/models/learned_pattern.rb
@app/models/learned_pattern_matcher.rb
@app/models/provider/anthropic/auto_categorizer.rb
@app/models/provider/openai/auto_categorizer.rb
@test/models/provider/concerns/few_shot_examples_test.rb

# Tech stack available (from Phase 29):
- LearnedPattern model with merchant_name, normalized_merchant, category_id
- LearnedPatternMatcher service with substring matching logic
- FewShotExamples concern with static_examples and dynamic_examples
- Fuzzy matching via fuzzy_name_match? in Provider::Anthropic::AutoCategorizer

# Established patterns (from Phase 29):
- Two-tier few-shot examples: static baseline + dynamic user patterns
- dynamic_examples uses `.sample(3)` for random selection (needs replacement)
- Format: "Transaction: {description} → Category: {category}"

# Constraining decisions:
- UI features are out of scope (Phase 31)
- No schema changes for "manually confirmed" flag (would need migration)
- Merchant-only matching (category matching is future work)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add relevant_patterns method with fuzzy merchant matching</name>
  <files>app/models/provider/concerns/few_shot_examples.rb</files>
  <action>
Add a new private method `relevant_patterns(transaction_merchant)` that:

1. Normalizes the input merchant name (same approach as LearnedPatternMatcher)
2. Finds patterns by exact match on normalized_merchant first
3. Falls back to substring matching (input contains pattern OR pattern contains input)
4. Returns patterns sorted by relevance:
   - Exact matches first
   - Then by similarity (longer substring match = higher relevance)
5. Limits to top 3 most relevant patterns

Reuse the normalization logic from LearnedPatternMatcher (downcase, remove special chars, squeeze whitespace). The method should handle nil/blank merchant input gracefully.

IMPORTANT: This is a query method only. It does not modify state. It returns an array of LearnedPattern records.
  </action>
  <verify>
Run `bin/rails test test/models/provider/concerns/few_shot_examples_test.rb` after adding the method to ensure no regressions.
  </verify>
  <done>
relevant_patterns method returns array of LearnedPattern records sorted by relevance (exact matches first, then by substring similarity), max 3 results
</done>
</task>

<task type="auto">
  <name>Task 2: Update dynamic_examples to use relevance-based selection with quality threshold</name>
  <files>app/models/provider/concerns/few_shot_examples.rb</files>
  <action>
Replace the current `dynamic_examples` method implementation:

CURRENT (random sampling):
- Groups patterns by category
- Samples 3 categories randomly
- Takes first pattern from each

NEW (relevance-based):
- Uses `relevant_patterns(@transaction_merchant)` to find matching patterns
- IMPORTANT: The FewShotExamples concern is included in AutoCategorizer classes, which have access to the transaction data through the `auto_categorize` method parameters
- The method needs context of which transactions are being categorized to find relevant patterns
- Quality threshold: Only include patterns that meet minimum relevance (exact match OR substring match with length >= 3)
- Returns up to 3 patterns (could be fewer if not enough relevant matches)
- Falls back to empty array if no relevant patterns found

CHALLENGE: The current concern doesn't have access to individual transaction merchant names during few-shot building. The few-shot examples are built once per categorization batch, not per transaction.

SOLUTION APPROACH: Since few-shot examples are shared across all transactions in a batch, find patterns that are generally relevant (most common merchants across the batch) OR pass the first transaction's merchant as a signal. For this phase, use a simplified approach:
- If the concern has access to transaction data via instance variables, use the first transaction's merchant
- Otherwise, fall back to most recent patterns (by created_at) as a proxy for relevance

Update the method to return an array of hashes matching the existing format: { description: merchant_name, category: category.name }
  </action>
  <verify>
Run `bin/rails test test/models/provider/concerns/few_shot_examples_test.rb` and verify:
- dynamic_examples returns merchant-relevant patterns when matches exist
- dynamic_examples returns empty array when no relevant patterns found
- dynamic_examples returns max 3 patterns even if more matches exist
  </verify>
  <done>
dynamic_examples uses merchant relevance matching instead of random sampling, with quality threshold ensuring only meaningful matches are included
</done>
</task>

<task type="auto">
  <name>Task 3: Separate user patterns into distinct prompt section</name>
  <files>app/models/provider/concerns/few_shot_examples.rb</files>
  <action>
Modify `build_few_shot_examples_text` to create two separate sections:

CURRENT format:
```
EXAMPLES:
Transaction: WHOLE FOODS MARKET → Category: Groceries
Transaction: SHELL SERVICE STATION → Category: Gas & Fuel
...
```

NEW format (when user patterns exist):
```
EXAMPLES:
Transaction: WHOLE FOODS MARKET → Category: Groceries
Transaction: SHELL SERVICE STATION → Category: Gas & Fuel

USER'S PATTERNS (how this user categorizes):
Transaction: STARBUCKS → Category: Coffee Shops
Transaction: TRADER JOE'S → Category: Groceries
```

Changes needed:
1. Build static examples text first (if any)
2. Append user patterns section ONLY if dynamic_examples returns results
3. Add section header "USER'S PATTERNS (how this user categorizes):" to emphasize these are user-specific
4. Maintain backward compatibility: if no user patterns, return only static examples section

Update `format_few_shot_examples` to accept an optional `section_header` parameter, or create a separate formatter for user patterns.

The key behavioral change: user patterns are visually distinct from generic examples, signaling to the AI that these carry more weight for THIS specific user.
  </action>
  <verify>
Run `bin/rails test test/models/provider/concerns/few_shot_examples_test.rb` and verify:
- When no user patterns exist, only static examples section appears
- When user patterns exist, both sections appear with distinct headers
- The "USER'S PATTERNS" section is clearly separated from generic examples
  </verify>
  <done>
User patterns appear in separate "USER'S PATTERNS" section with distinct labeling, visually separated from generic examples
</done>
</task>

<task type="auto">
  <name>Task 4: Add tests for relevance-based pattern selection</name>
  <files>test/models/provider/concerns/few_shot_examples_test.rb</files>
  <action>
Add comprehensive test coverage for the new behavior:

1. `test "relevant_patterns returns exact match first"` - Verify exact match on normalized_merchant takes priority
2. `test "relevant_patterns returns substring matches sorted by similarity"` - Verify longer substring matches rank higher
3. `test "relevant_patterns handles blank merchant input"` - Verify graceful handling of nil/empty merchant
4. `test "relevant_patterns limits to 3 patterns"` - Verify max 3 results even with more matches
5. `test "dynamic_examples uses merchant relevance"` - Verify dynamic_examples calls relevant_patterns
6. `test "dynamic_examples returns empty when no relevant patterns"` - Verify quality threshold behavior
7. `test "build_few_shot_examples_text separates user patterns"` - Verify two-section format when patterns exist
8. `test "build_few_shot_examples_text shows only examples when no user patterns"` - Verify backward compatibility

Use existing test patterns from few_shot_examples_test.rb as reference. Create fixtures with:
- Multiple patterns with varying merchant similarity (exact, partial, unrelated)
- Patterns for different categories
- Blank/null merchant cases

Ensure all existing tests still pass (no regressions in static examples or baseline behavior).
  </action>
  <verify>
Run `bin/rails test test/models/provider/concerns/few_shot_examples_test.rb` - all tests should pass including new tests and existing regression tests
  </verify>
  <done>
All 8 new tests pass, all existing tests still pass (no regressions), coverage includes relevance matching, quality threshold, and prompt section separation
</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `bin/rails test test/models/provider/concerns/few_shot_examples_test.rb` passes
- [ ] `bin/rails test test/models/provider/concerns/` (all provider concern tests pass)
- [ ] `bin/rails test test/models/provider/anthropic/` (Anthropic tests still pass)
- [ ] `bin/rails test test/models/provider/openai/` (OpenAI tests still pass)
- [ ] Verify prompt output includes separate "USER'S PATTERNS" section when relevant patterns exist
</verification>

<success_criteria>

- relevant_patterns method implements fuzzy merchant matching with relevance sorting
- dynamic_examples uses relevance-based selection instead of random sampling
- Quality threshold excludes weak/noisy matches
- User patterns appear in separate prompt section with distinct labeling
- All existing tests pass (no regressions)
- New test coverage validates the relevance-based behavior
  </success_criteria>

<output>
After completion, create `.planning/phases/30-learned-pattern-integration/30-01-SUMMARY.md`:

# Phase 30 Plan 1: LearnedPattern Integration Summary

**Enhanced FewShotExamples concern to use relevance-based merchant matching instead of random sampling, improving AI categorization accuracy through personalized user patterns.**

## Accomplishments

- Added `relevant_patterns` method with fuzzy merchant matching (exact match first, then substring similarity)
- Replaced random `.sample(3)` with relevance-based selection in `dynamic_examples`
- Implemented quality threshold to exclude weak matches (only exact or meaningful substring matches)
- Created separate "USER'S PATTERNS" prompt section to emphasize user-specific behavior
- Added comprehensive test coverage for relevance matching, quality threshold, and prompt formatting

## Files Created/Modified

- `app/models/provider/concerns/few_shot_examples.rb` - Added relevant_patterns, updated dynamic_examples and build_few_shot_examples_text
- `test/models/provider/concerns/few_shot_examples_test.rb` - Added 8 new tests for relevance-based selection

## Decisions Made

- Used merchant-only matching (category matching deferred as future work)
- Reused existing normalization logic from LearnedPatternMatcher for consistency
- Quality threshold based on substring length (>= 3 chars) to exclude weak matches
- No schema changes for "manually confirmed" flag (would require migration, out of scope)

## Issues Encountered

[None expected - work follows established patterns from Phase 29]

## Next Step

Ready for Phase 31: Feedback UI - add user interface for showing which patterns influenced AI categorization
</output>
