---
phase: 15-anthropic-model-autopopulate
type: execute
domain: rails
---

<objective>
Convert Anthropic model field from text input to select dropdown that fetches available models from Anthropic API.

Purpose: Improve UX by providing a curated list of available Anthropic models instead of requiring users to manually type model names. Reduces errors from typos and eliminates need to lookup model names.

Output: Select dropdown populated with Anthropic models fetched via backend proxy to Anthropic's /v1/models API endpoint, with fallback to text input for custom models.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key files from prior phases:
@app/models/setting.rb
@app/models/provider/anthropic.rb
@app/controllers/settings/hostings_controller.rb
@app/views/settings/hostings/_anthropic_settings.html.erb
@app/javascript/controllers/lunchflow_preload_controller.js
@app/javascript/controllers/auto_submit_form_controller.js
@config/locales/views/settings/hostings/en.yml

# Tech stack available (from v1.0 milestone):
- anthropic gem v1.16.3 for Anthropic API access
- Rails 7.2 with Hotwire (Stimulus + Turbo)
- RailsSettings for configuration management with ENV fallbacks

# Established patterns (from v1.0):
- Stimulus controllers use fetch with CSRF token for API calls (see lunchflow_preload_controller)
- Settings forms use styled_form_with with auto-submit-form controller
- Select dropdowns use form.select with options_for_select
- ENV-based field locking (disabled when ENV variable set)
- Backend proxy pattern for external API calls

# Constraining decisions (from STATE.md):
- Default provider is "openai" - Anthropic is opt-in
- Anthropic model names must start with "claude-" prefix (validated in Setting.validate_anthropic_config!)
- Use Setting.anthropic_model for user-configured value with ENV["ANTHROPIC_MODEL"] fallback
- All settings changes require admin permission (ensure_admin in hostings_controller)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create backend endpoint for Anthropic models</name>
  <files>config/routes.rb, app/controllers/settings/hostings_controller.rb</files>
  <action>Add a GET endpoint /settings/hosting/anthropic_models that returns available Anthropic models as JSON. Use the anthropic gem to fetch models from Anthropic's /v1/models API. Return JSON with {models: [{id: "claude-sonnet-4-5-20250929", display_name: "Claude Sonnet 4.5"}, ...]}. Handle errors gracefully (invalid API key, network issues) - return {models: [], error: "message"} in error cases. Require admin authentication (same as other settings actions). Use Setting.anthropic_access_token for authentication, with fallback to ENV["ANTHROPIC_API_KEY"].</action>
  <verify>curl /settings/hosting/anthropic_models returns JSON with models array when valid API key configured; returns empty array with error message when API key missing/invalid</verify>
  <done>Endpoint returns valid JSON response with Anthropic models list; errors handled gracefully; admin-only access enforced</done>
</task>

<task type="auto">
  <name>Task 2: Create Stimulus controller for model fetching and selection</name>
  <files>app/javascript/controllers/anthropic_model_select_controller.js</files>
  <action>Create Stimulus controller (anthropic-model-select) that fetches models from the backend endpoint on connect. Targets: select, spinner, customOptionWrapper. Values: currentModel (the currently selected value). Actions: fetch models on connect, populate select options, preserve current selection, show/hide spinner during fetch, show error message if fetch fails. Add "Custom..." option at end of list to allow manual entry for custom models. When "Custom..." is selected, show a text input field for manual entry. Follow the same fetch pattern as lunchflow_preload_controller (CSRF token, JSON response).</action>
  <verify>Controller fetches models on page load, populates select dropdown, shows "Custom..." option, displays text input when "Custom..." selected</verify>
  <done>Stimulus controller successfully fetches and populates models; custom option enables text input; loading state displays correctly</done>
</task>

<task type="auto">
  <name>Task 3: Update Anthropic settings view to use select dropdown</name>
  <files>app/views/settings/hostings/_anthropic_settings.html.erb</files>
  <action>Replace the text_field for anthropic_model with a select dropdown wrapped with the anthropic-model-select controller. Structure: div wrapper with controller, select element for model selection, hidden text input for custom model entry (shown only when "Custom..." selected), spinner element for loading state. Use form.select with options_for_select, populated via Stimulus controller. Maintain ENV-based locking (disabled when ENV["ANTHROPIC_MODEL"] set). Preserve auto-submit-form behavior. Add help text explaining that custom models can be entered via "Custom..." option.</action>
  <verify>Select dropdown appears in Anthropic settings; models populate on page load; "Custom..." option shows text input; field disabled when ENV["ANTHROPIC_MODEL"] set; form submits correctly</verify>
  <done>View renders select dropdown with controller; models populate from API; custom model entry works; ENV locking preserved; auto-submit works</done>
</task>

<task type="auto">
  <name>Task 4: Update locale strings for model select</name>
  <files>config/locales/views/settings/hostings/en.yml</files>
  <action>Add translation keys for model select: custom_model_option ("Custom..."), custom_model_label ("Enter custom model name"), custom_model_help ("Enter a custom Anthropic model name (must start with 'claude-')"), models_fetch_error ("Failed to load models: %{error}"), models_loading ("Loading models..."). Update existing model_help to mention the dropdown and custom option.</action>
  <verify>All new translation keys present in locale file; interpolation works for error message</verify>
  <done>Locale file updated with all required keys; interpolation placeholders correct</done>
</task>

<task type="auto">
  <name>Task 5: Add tests for models endpoint and validation</name>
  <files>test/controllers/settings/hostings_controller_test.rb</files>
  <action>Add test for GET /settings/hosting/anthropic_models endpoint. Test cases: admin can fetch models with valid API key, non-admin redirected, returns error JSON when API key invalid, returns empty array when API key missing. Use VCR to mock Anthropic API responses for consistent testing. Ensure existing tests still pass.</action>
  <verify>bin/rails test test/controllers/settings/hostings_controller_test.rb passes all tests including new anthropic_models tests</verify>
  <done>All tests pass (existing + new); VCR cassettes created for Anthropic /v1/models API; endpoint properly tested</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `bin/rails test` passes all tests
- [ ] `bin/rubocop` passes without errors
- [ ] Manual verification: Select dropdown appears and populates with models
- [ ] Manual verification: "Custom..." option enables text input
- [ ] Manual verification: ENV["ANTHROPIC_MODEL"] still locks the field
- [ ] Manual verification: Auto-submit still works after model selection
</verification>

<success_criteria>

- Backend endpoint returns valid Anthropic models list
- Stimulus controller fetches and populates models on page load
- Select dropdown replaces text input in UI
- "Custom..." option allows manual model entry
- ENV-based locking preserved
- All tests passing
- No regressions in existing Anthropic settings functionality
  </success_criteria>

<output>
After completion, create `.planning/phases/15-anthropic-model-autopopulate/15-01-SUMMARY.md`:

# Phase 15 Plan 1: Anthropic Model Autopopulate Summary

**Converted Anthropic model field from text input to select dropdown with dynamic model fetching from Anthropic API.**

## Accomplishments

- Created backend endpoint `/settings/hosting/anthropic_models` that proxies requests to Anthropic's `/v1/models` API
- Implemented `anthropic_model_select_controller.js` Stimulus controller for fetching models and managing selection
- Updated Anthropic settings view to use select dropdown with "Custom..." fallback option
- Added comprehensive locale strings for model selection UI
- Added tests for models endpoint with VCR cassettes for API mocking

## Files Created/Modified

- `config/routes.rb` - Added anthropic_models route
- `app/controllers/settings/hostings_controller.rb` - Added anthropic_models action
- `app/javascript/controllers/anthropic_model_select_controller.js` - NEW
- `app/views/settings/hostings/_anthropic_settings.html.erb` - Updated to use select dropdown
- `config/locales/views/settings/hostings/en.yml` - Added model select translations
- `test/controllers/settings/hostings_controller_test.rb` - Added endpoint tests
- `test/vcr_cassettes/anthropic_models_*.yml` - NEW (VCR cassettes for API mocking)

## Decisions Made

- Backend proxy pattern chosen to avoid exposing API keys to frontend
- "Custom..." option preserved ability to enter non-listed models
- Error handling returns empty array with message to prevent UI breakage
- Used existing anthropic gem for API consistency with Provider::Anthropic

## Issues Encountered

None (or describe any issues and resolutions)

## Next Step

Phase 15 complete. Ready for next phase or milestone v1.1 final verification.
</output>
