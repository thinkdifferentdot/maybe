---
phase: 05-settings-model
plan: 01
type: execute
domain: rails-models
---

<objective>
Add Anthropic configuration fields to the Setting model following the established OpenAI pattern.

Purpose: Enable storage of Anthropic API credentials and provider selection through the settings system, with ENV fallbacks for self-hosted deployments.

Output: Three new Setting fields (anthropic_access_token, anthropic_model, llm_provider) with proper ENV defaults and provider constants.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/phase-prompt.md
~/.claude/get-shit-done/references/plan-format.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-settings-model/05-CONTEXT.md
@.planning/phases/05-settings-model/05-RESEARCH.md
@.planning/phases/02-core-operations/02-01-SUMMARY.md
@app/models/setting.rb

**Tech stack available:** rails-settings gem (bundled), RailsSettings::Base pattern
**Established patterns:** Field declarations with ENV defaults, provider constants, fetch() for non-nil defaults

**Constraining decisions:**
- Phase 1-01: anthropic gem uses ANTHROPIC_API_KEY ENV (not ACCESS_TOKEN)
- Phase 1-03: Provider::Anthropic initialized with access_token: keyword argument

**Key decisions from RESEARCH.md:**
- Follow OpenAI pattern exactly for field declarations
- Use ENV["ANTHROPIC_API_KEY"] for access_token (matches gem convention)
- Use ENV.fetch("LLM_PROVIDER", "openai") for provider selection default
- Add LLM_PROVIDERS constant mirroring existing provider patterns

**Issues being addressed:** None
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Anthropic API credentials fields to Setting model</name>
  <files>app/models/setting.rb</files>
  <action>Add two new field declarations after the OpenAI fields (after line 12):

```ruby
field :anthropic_access_token, type: :string, default: ENV["ANTHROPIC_API_KEY"]
field :anthropic_model, type: :string, default: ENV["ANTHROPIC_MODEL"]
```

Key details:
- Place after openai_json_mode field (line 12), before brand_fetch_client_id (line 13)
- Use ANTHROPIC_API_KEY (not ACCESS_TOKEN) to match the official gem's ENV convention
- anthropic_model defaults to ENV["ANTHROPIC_MODEL"] - blank is OK (Provider::Anthropic has its own default)
- Both are type: :string for consistency with OpenAI fields</action>
  <verify>Fields are declared, Setting.anthropic_access_token and Setting.anthropic_model methods exist</verify>
  <done>Both anthropic_access_token and anthropic_model fields added with correct ENV defaults</done>
</task>

<task type="auto">
  <name>Task 2: Add LLM provider selection field and constant to Setting model</name>
  <files>app/models/setting.rb</files>
  <action>First, add the LLM_PROVIDERS constant after the existing provider constants (after line 17):

```ruby
LLM_PROVIDERS = %w[openai anthropic].freeze
```

Then add the llm_provider field after the securities_provider field (after line 17):

```ruby
field :llm_provider, type: :string, default: ENV.fetch("LLM_PROVIDER", "openai")
```

Key details:
- LLM_PROVIDERS constant enables validation: only openai and anthropic are valid values
- Use ENV.fetch with "openai" default so existing deployments continue using OpenAI
- Place after existing provider selection fields (exchange_rate_provider, securities_provider)
- This field drives which provider the app uses globally for all AI features</action>
  <verify>LLM_PROVIDERS constant exists, Setting.llm_provider defaults to "openai" when ENV not set</verify>
  <done>llm_provider field added with LLM_PROVIDERS constant defining valid values</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Setting.anthropic_access_token field exists with ENV["ANTHROPIC_API_KEY"] default
- [ ] Setting.anthropic_model field exists with ENV["ANTHROPIC_MODEL"] default
- [ ] Setting::LLM_PROVIDERS constant defined as %w[openai anthropic]
- [ ] Setting.llm_provider field exists with ENV.fetch("LLM_PROVIDER", "openai") default
- [ ] No Rubocop offenses introduced
- [ ] No test failures
</verification>

<success_criteria>

- All Anthropic settings fields added to Setting model
- Fields follow existing OpenAI pattern exactly
- ENV fallbacks work for self-hosted deployments
  </success_criteria>

<output>
After completion, create `.planning/phases/05-settings-model/05-01-SUMMARY.md`:

# Phase 5 Plan 1: Settings Fields Summary

**Added Anthropic configuration fields to Setting model following the established OpenAI pattern**

## Accomplishments

- Added anthropic_access_token field with ANTHROPIC_API_KEY ENV default
- Added anthropic_model field with ANTHROPIC_MODEL ENV default
- Added LLM_PROVIDERS constant defining valid provider values
- Added llm_provider field with LLM_PROVIDER ENV default (openai fallback)

## Files Created/Modified

- `app/models/setting.rb` - Added 3 new fields and LLM_PROVIDERS constant

## Decisions Made

- Used ANTHROPIC_API_KEY (not ACCESS_TOKEN) to match official gem convention
- Default provider is "openai" for backward compatibility
- Provider selection is global (single field, not per-feature)

## Issues Encountered

[None expected, document any issues that arise]

## Next Step

Ready for 05-02-PLAN.md - Add anthropic method to Provider::Registry
</output>
