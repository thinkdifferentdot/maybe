---
phase: 05-settings-model
plan: 03
type: execute
domain: rails-models
---

<objective>
Update Settings::HostingsController to permit and handle Anthropic settings, add validation for LLM provider selection.

Purpose: Enable the settings UI (Phase 6) to save Anthropic configuration through the controller, with proper validation and security handling for API tokens.

Output: Controller params updated, update actions added for Anthropic fields, LLM provider validation added.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/phase-prompt.md
~/.claude/get-shit-done/references/plan-format.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-settings-model/05-CONTEXT.md
@.planning/phases/05-settings-model/05-RESEARCH.md
@.planning/phases/05-settings-model/05-01-PLAN.md
@.planning/phases/05-settings-model/05-02-PLAN.md
@.planning/phases/02-core-operations/02-01-SUMMARY.md
@app/controllers/settings/hostings_controller.rb
@app/models/setting.rb

**Tech stack available:** Setting fields (from 05-01), Provider::Registry.anthropic (from 05-02)
**Established patterns:** Params permitting, token redaction placeholder handling, ValidationError with i18n

**Constraining decisions:**
- Phase 05-01: LLM_PROVIDERS = %w[openai anthropic].freeze
- Phase 05-01: llm_provider field with ENV.fetch("LLM_PROVIDER", "openai") default

**Key decisions from RESEARCH.md:**
- Follow OpenAI pattern exactly for params permitting
- Use "********" redaction placeholder for API tokens
- Add validation for llm_provider against LLM_PROVIDERS constant
- Handle token updates with strip to remove whitespace

**Issues being addressed:** None
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Anthropic fields to controller permitted params</name>
  <files>app/controllers/settings/hostings_controller.rb</files>
  <action>Update the hosting_params private method (line 102) to include the new Anthropic fields:

Change:
```ruby
params.require(:setting).permit(:onboarding_state, :require_email_confirmation, :brand_fetch_client_id, :twelve_data_api_key, :openai_access_token, :openai_uri_base, :openai_model, :openai_json_mode, :exchange_rate_provider, :securities_provider)
```

To:
```ruby
params.require(:setting).permit(:onboarding_state, :require_email_confirmation, :brand_fetch_client_id, :twelve_data_api_key, :openai_access_token, :openai_uri_base, :openai_model, :openai_json_mode, :exchange_rate_provider, :securities_provider, :anthropic_access_token, :anthropic_model, :llm_provider)
```

Add the three new Anthropic fields to the end of the permit list.</action>
  <verify>hosting_params includes anthropic_access_token, anthropic_model, and llm_provider</verify>
  <done>All three Anthropic fields added to permitted params</done>
</task>

<task type="auto">
  <name>Task 2: Add update actions for Anthropic fields</name>
  <files>app/controllers/settings/hostings_controller.rb</files>
  <action>Add update handlers for the three new Anthropic fields in the update action (after line 87, before the redirect):

```ruby
# Anthropic configuration
if hosting_params.key?(:anthropic_access_token)
  token_param = hosting_params[:anthropic_access_token].to_s.strip
  # Ignore blanks and redaction placeholders to prevent accidental overwrite
  unless token_param.blank? || token_param == "********"
    Setting.anthropic_access_token = token_param
  end
end

if hosting_params.key?(:anthropic_model)
  Setting.anthropic_model = hosting_params[:anthropic_model]
end

if hosting_params.key?(:llm_provider)
  Setting.llm_provider = hosting_params[:llm_provider]
end
```

Key details:
- Place after OpenAI handlers (after line 87), before the redirect (line 89)
- Follow exact OpenAI pattern for token handling (strip, ignore blanks and "********")
- Model and provider don't need special handling (direct assignment)</action>
  <verify>Update action handles all three Anthropic fields when present in params</verify>
  <done>All three Anthropic fields have update handlers following OpenAI pattern</done>
</task>

<task type="auto">
  <name>Task 3: Add LLM provider validation to Setting model</name>
  <files>app/models/setting.rb</files>
  <action>Add a validation class method for LLM provider selection (after the validate_openai_config! method at line 133):

```ruby
# Validates LLM provider is one of the supported providers
def self.validate_llm_provider!(provider)
  return if provider.blank? || LLM_PROVIDERS.include?(provider)

  raise ValidationError, "LLM provider must be one of: #{LLM_PROVIDERS.join(', ')}"
end
```

This enables validation before saving the provider selection, similar to the existing validate_openai_config! pattern.</action>
  <verify>Setting.validate_llm_provider!("openai") passes, Setting.validate_llm_provider!("invalid") raises ValidationError</verify>
  <done>validate_llm_provider! method added that checks against LLM_PROVIDERS constant</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] hosting_params permits anthropic_access_token, anthropic_model, llm_provider
- [ ] Update action handles all three Anthropic fields correctly
- [ ] Token redaction placeholder ("********") is respected
- [ ] Setting.validate_llm_provider! validates against LLM_PROVIDERS
- [ ] No Rubocop offenses introduced
- [ ] No test failures
</verification>

<success_criteria>

- Controller permits and handles all Anthropic settings fields
- Token security follows OpenAI pattern (redaction placeholder handling)
- Provider validation ensures only valid providers can be selected
- Phase 5 complete, ready for Phase 6 (Settings UI)
  </success_criteria>

<output>
After completion, create `.planning/phases/05-settings-model/05-03-SUMMARY.md`:

# Phase 5 Plan 3: Controller & Validation Summary

**Updated Settings::HostingsController to permit and handle Anthropic settings with proper validation**

## Accomplishments

- Added anthropic_access_token, anthropic_model, and llm_provider to permitted params
- Added update handlers for all three Anthropic fields following OpenAI pattern
- Added validate_llm_provider! validation method to Setting model
- Verified token redaction placeholder handling works correctly

## Files Created/Modified

- `app/controllers/settings/hostings_controller.rb` - Added params permitting and update handlers
- `app/models/setting.rb` - Added validate_llm_provider! method

## Decisions Made

- Followed exact OpenAI pattern for token security (ignore "********" placeholder)
- Simple validation for llm_provider (no complex logic needed)
- No validation required for anthropic_model (blank is OK, provider has default)

## Issues Encountered

[None expected, document any issues that arise]

## Next Step

Phase 5 complete! Ready for Phase 6 (Settings UI) - Build provider selector dropdown and Anthropic configuration form
</output>
