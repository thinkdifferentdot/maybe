---
phase: 05-settings-model
plan: 02
type: execute
domain: rails-models
---

<objective>
Add anthropic provider method to Provider::Registry and make Anthropic discoverable for LLM concept.

Purpose: Enable Anthropic provider instantiation through the registry system using the settings fields added in 05-01, following the exact pattern of OpenAI.

Output: Provider::Registry.anthropic method that returns Provider::Anthropic instance or nil, with Anthropic in available_providers for LLM concept.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/phase-prompt.md
~/.claude/get-shit-done/references/plan-format.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-settings-model/05-CONTEXT.md
@.planning/phases/05-settings-model/05-RESEARCH.md
@.planning/phases/05-settings-model/05-01-PLAN.md
@.planning/phases/01-foundation/1-03-SUMMARY.md
@app/models/provider/registry.rb
@app/models/provider/anthropic.rb
@app/models/setting.rb

**Tech stack available:** Provider::Anthropic class (from Phase 1), Setting fields (from 05-01)
**Established patterns:** Registry provider methods with ENV → Setting fallback, early return nil when no credential

**Constraining decisions:**
- Phase 1-03: Provider::Anthropic.new(access_token, model: model) signature
- Phase 1-03: DEFAULT_MODEL is "claude-sonnet-4-5-20250929"

**Key decisions from RESEARCH.md:**
- Follow OpenAI registry pattern exactly: ENV.presence || Setting.field_name
- No uri_base parameter (Anthropic doesn't support custom endpoints)
- Simpler structure: just access_token and model (no error logging needed)
- Place after openai method to keep LLM providers together

**Issues being addressed:** None
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add anthropic method to Provider::Registry</name>
  <files>app/models/provider/registry.rb</files>
  <action>Add a private `anthropic` class method to Provider::Registry following the exact pattern of the `openai` method (lines 65-79):

```ruby
def anthropic
  access_token = ENV["ANTHROPIC_API_KEY"].presence || Setting.anthropic_access_token

  return nil unless access_token.present?

  model = ENV["ANTHROPIC_MODEL"].presence || Setting.anthropic_model

  Provider::Anthropic.new(access_token, model: model)
end
```

Key differences from OpenAI:
- No uri_base parameter (Anthropic doesn't support custom endpoints)
- No custom error logging (model is optional, Provider::Anthropic has its own default)
- Simpler structure: just access_token and model

Place this method after the `openai` method (after line 79) to keep related LLM providers together in the "private" section of the class << self block.</action>
  <verify>Method exists, returns nil when no API key, instantiates Provider::Anthropic when configured</verify>
  <done>anthropic method follows same ENV → Setting pattern as openai, returns Provider::Anthropic instance or nil</done>
</task>

<task type="auto">
  <name>Task 2: Add anthropic to LLM concept available_providers</name>
  <files>app/models/provider/registry.rb</files>
  <action>Modify the `available_providers` instance method (lines 106-117) to include :anthropic in the :llm case:

Change:
```ruby
when :llm
  %i[openai]
```

To:
```ruby
when :llm
  %i[openai anthropic]
```

This makes Anthropic discoverable via Registry.for_concept(:llm).providers and consistent with the openai provider.</action>
  <verify>Registry.for_concept(:llm).providers includes both openai and anthropic (when both are configured)</verify>
  <done>:anthropic symbol added to :llm available_providers array</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Provider::Registry.anthropic private class method exists
- [ ] Method returns nil when ANTHROPIC_API_KEY ENV and Setting.anthropic_access_token are both blank
- [ ] Method returns Provider::Anthropic instance when configured
- [ ] Registry.for_concept(:llm).providers includes :anthropic when configured
- [ ] No Rubocop offenses introduced
- [ ] No test failures
</verification>

<success_criteria>

- anthropic method added to registry following OpenAI pattern
- Anthropic discoverable via Registry.for_concept(:llm)
- Both providers available when both are configured
  </success_criteria>

<output>
After completion, create `.planning/phases/05-settings-model/05-02-SUMMARY.md`:

# Phase 5 Plan 2: Registry Integration Summary

**Added anthropic provider method to Provider::Registry and made Anthropic discoverable for LLM concept**

## Accomplishments

- Added anthropic class method to Provider::Registry following OpenAI pattern
- Made Anthropic discoverable via Registry.for_concept(:llm).providers
- Verified ENV → Setting fallback pattern works correctly

## Files Created/Modified

- `app/models/provider/registry.rb` - Added anthropic method, updated available_providers

## Decisions Made

- No uri_base parameter (Anthropic doesn't support custom endpoints)
- Followed exact OpenAI pattern for ENV → Setting fallback
- Kept LLM providers together (openai, then anthropic)

## Issues Encountered

[None expected, document any issues that arise]

## Next Step

Ready for 05-03-PLAN.md - Update controller params and add validation for Anthropic settings
</output>
