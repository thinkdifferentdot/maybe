---
phase: 06-settings-ui
plan: 02
type: execute
---

<objective>
Add Anthropic API key and model input fields to self-hosting settings.

Purpose: Allow users to configure their Anthropic API credentials. These fields follow the exact pattern of OpenAI settings (access token + model).

Output: Anthropic configuration form that saves to Setting.anthropic_access_token and Setting.anthropic_model.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-settings-ui/06-CONTEXT.md
@app/views/settings/hostings/_openai_settings.html.erb
@app/views/settings/hostings/show.html.erb
@app/controllers/settings/hostings_controller.rb
@config/locales/views/settings/hostings/en.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add anthropic fields to Setting model</name>
  <files>app/models/setting.rb</files>
  <action>Add two field declarations after llm_provider (added in 06-01):
```ruby
field :anthropic_access_token, type: :string, default: ENV["ANTHROPIC_API_KEY"]
field :anthropic_model, type: :string, default: ENV["ANTHROPIC_MODEL"]
```
Place these after the llm_provider field (around line 18). Follow exact pattern of openai_access_token and openai_model above. Note: ENV key is "ANTHROPIC_API_KEY" not "ANTHROPIC_ACCESS_TOKEN" to match Anthropic convention.</action>
  <verify>bin/rails runner "puts Setting.anthropic_access_token; puts Setting.anthropic_model" runs without error</verify>
  <done>Setting.anthropic_access_token and Setting.anthropic_model accessible with ENV defaults</done>
</task>

<task type="auto">
  <name>Task 2: Create Anthropic settings partial</name>
  <files>app/views/settings/hostings/_anthropic_settings.html.erb</files>
  <action>Create partial following _openai_settings.html.erb pattern exactly. Structure:
- div with space-y-4
- h2 with t(".title")
- p description with t(".description") (or env_configured_message if ENV present)
- styled_form_with with auto-submit-form controller (blur trigger)
- password_field for anthropic_access_token (redacted as "********" if present, disabled if ENV set)
- text_field for anthropic_model (disabled if ENV set)
Include the ENV check for showing env_configured_message (like line 4-8 in openai_settings).</action>
  <verify>File exists with password_field and text_field matching OpenAI pattern</verify>
  <done>Partial renders two form fields with proper ENV handling and auto-submit</done>
</task>

<task type="auto">
  <name>Task 3: Add controller support for anthropic params</name>
  <files>app/controllers/settings/hostings_controller.rb</files>
  <action>In update method, add handling after openai_json_mode block (around line 88):
```ruby
if hosting_params.key?(:anthropic_access_token)
  token_param = hosting_params[:anthropic_access_token].to_s.strip
  # Ignore blanks and redaction placeholders to prevent accidental overwrite
  unless token_param.blank? || token_param == "********"
    Setting.anthropic_access_token = token_param
  end
end

if hosting_params.key?(:anthropic_model)
  Setting.anthropic_model = hosting_params[:anthropic_model]
end
```
Add :anthropic_access_token and :anthropic_model to hosting_params permit array.</action>
  <verify>grep anthropic app/controllers/settings/hostings_controller.rb shows param handling</verify>
  <done>Controller accepts and saves anthropic params with redaction protection</done>
</task>

<task type="auto">
  <name>Task 4: Add English locale strings for Anthropic settings</name>
  <files>config/locales/views/settings/hostings/en.yml</files>
  <action>Add under hostings key (after openai_settings, around line 57):
```yaml
anthropic_settings:
  title: Anthropic
  description: Enter your Anthropic API key and model for Claude support
  env_configured_message: Successfully configured through environment variables.
  access_token_label: API Key
  access_token_placeholder: Enter your Anthropic API key
  model_label: Model (Optional)
  model_placeholder: "claude-sonnet-4-5-20250929 (default)"
```
Follow exact format of openai_settings locale keys.</action>
  <verify>bin/rails runner "puts I18n.t('settings.hostings.anthropic_settings.title')" returns "Anthropic"</verify>
  <done>Locale keys present for all Anthropic settings labels</done>
</task>

<task type="auto">
  <name>Task 5: Render Anthropic settings in hosting view</name>
  <files>app/views/settings/hostings/show.html.erb</files>
  <action>Add to the "General" settings_section after openai_settings. Inside the space-y-6 div, add: `<%= render "settings/hostings/anthropic_settings" %>`. This places Anthropic settings immediately after OpenAI settings within the General section.</action>
  <verify>bin/rails runner "puts File.read('app/views/settings/hostings/show.html.erb').include?('anthropic_settings')"</verify>
  <done>Anthropic settings form appears in General section</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Visit /settings/hosting shows "Anthropic" section with API key and model fields
- [ ] API key field is password type, shows "********" when value exists
- [ ] Entering API key and model submits successfully
- [ ] Setting.anthropic_access_token contains the entered value (not redacted)
- [ ] ENV["ANTHROPIC_API_KEY"] disables fields and shows env_configured_message
</verification>

<success_criteria>

- Anthropic settings section visible in hosting settings
- Two input fields: API key (password) and model (text)
- Password field redacts existing value as "********"
- Redacted value is not saved (prevents accidental overwrite)
- ENV variables disable fields and show configured message
- Follows OpenAI settings pattern exactly
  </success_criteria>

<output>
After completion, create `.planning/phases/06-settings-ui/06-02-SUMMARY.md`:

# Phase 6 Plan 2: Anthropic Configuration Fields Summary

**Added Anthropic API key and model input fields following OpenAI settings pattern**

## Accomplishments

- Added Setting.anthropic_access_token and Setting.anthropic_model fields
- Created _anthropic_settings.html.erb partial matching OpenAI structure
- Added controller support with redaction protection
- Added i18n locale strings
- Integrated into hosting settings view

## Files Created/Modified

- `app/models/setting.rb` - Added anthropic_access_token and anthropic_model fields
- `app/views/settings/hostings/_anthropic_settings.html.erb` - New partial
- `app/controllers/settings/hostings_controller.rb` - Added anthropic param handling
- `app/views/settings/hostings/show.html.erb` - Rendered anthropic_settings partial
- `config/locales/views/settings/hostings/en.yml` - Added locale keys

## Decisions Made

- ENV key is "ANTHROPIC_API_KEY" (Anthropic convention) not "ANTHROPIC_ACCESS_TOKEN"
- Redaction placeholder "********" prevents accidental overwrite
- Follows OpenAI pattern exactly for consistency
- Placed in General section alongside OpenAI settings

## Next Step

Ready for 06-03-PLAN.md (Show/hide fields based on provider selection)
</output>
