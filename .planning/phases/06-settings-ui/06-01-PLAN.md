---
phase: 06-settings-ui
plan: 01
type: execute
---

<objective>
Add LLM provider selector dropdown to self-hosting settings page.

Purpose: Allow users to select between OpenAI and Anthropic as their AI provider. The dropdown follows the existing provider_selection pattern used for exchange rates and securities.

Output: Working provider dropdown in settings/hostings that persists selection to Setting.llm_provider.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-settings-ui/06-CONTEXT.md
@app/views/settings/hostings/show.html.erb
@app/views/settings/hostings/_provider_selection.html.erb
@app/controllers/settings/hostings_controller.rb
@config/locales/views/settings/hostings/en.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add llm_provider field to Setting model</name>
  <files>app/models/setting.rb</files>
  <action>Add field declaration for llm_provider after line 17 (securities_provider). Use: `field :llm_provider, type: :string, default: ENV.fetch("LLM_PROVIDER", "openai")`. This follows the existing pattern for exchange_rate_provider and securities_provider. The default is "openai" to maintain backward compatibility.</action>
  <verify>bin/rails runner "puts Setting.llm_provider" returns "openai" (or ENV value if set)</verify>
  <done>Setting.llm_provider accessible, defaults to "openai", respects ENV["LLM_PROVIDER"]</done>
</task>

<task type="auto">
  <name>Task 2: Create LLM provider selector partial</name>
  <files>app/views/settings/hostings/_llm_provider_selection.html.erb</files>
  <action>Create new partial following the pattern of _provider_selection.html.erb. Structure:
- div with space-y-4
- h2 title with t(".title")
- p description with t(".description")
- styled_form_with targeting settings_hosting_path
- select for llm_provider with options: [[t(".providers.openai"), "openai"], [t(".providers.anthropic"), "anthropic"]]
- disabled if ENV["LLM_PROVIDER"] present
- data controller "auto-submit-form" with trigger-event "change"
Follow exact HTML structure from _provider_selection.html.erb for consistency.</action>
  <verify>File exists at app/views/settings/hostings/_llm_provider_selection.html.erb with proper ERB syntax</verify>
  <done>Partial renders form select with two provider options, follows auto-submit pattern</done>
</task>

<task type="auto">
  <name>Task 3: Add controller support for llm_provider param</name>
  <files>app/controllers/settings/hostings_controller.rb</files>
  <action>In the update method, add handling for llm_provider param after line 59 (securities_provider):
```ruby
if hosting_params.key?(:llm_provider)
  Setting.llm_provider = hosting_params[:llm_provider]
end
```
Also add :llm_provider to the hosting_params permit array at the end of the file.</action>
  <verify>grep llm_provider app/controllers/settings/hostings_controller.rb shows the param is permitted and handled</verify>
  <done>Controller accepts and saves llm_provider parameter to Setting.llm_provider</done>
</task>

<task type="auto">
  <name>Task 4: Render LLM provider selection in hosting settings view</name>
  <files>app/views/settings/hostings/show.html.erb</files>
  <action>Add LLM provider section to the "General" settings_section. Place it before openai_settings (line 4) so provider selection appears above the provider-specific configuration. Add: `<%= render "settings/hostings/llm_provider_selection" %>` inside the space-y-6 div.</action>
  <verify>bin/rails runner "puts File.read('app/views/settings/hostings/show.html.erb')'" includes llm_provider_selection render</verify>
  <done>LLM provider dropdown appears in General section, positioned above OpenAI settings</done>
</task>

<task type="auto">
  <name>Task 5: Add English locale strings for LLM provider selector</name>
  <files>config/locales/views/settings/hostings/en.yml</files>
  <action>Add under hostings key:
```yaml
llm_provider_selection:
  title: AI Provider
  description: Select your AI provider for chat, auto-categorization, and merchant detection
  exchange_rate_provider_label: Exchange Rate Provider
  llm_provider_label: LLM Provider
  providers:
    openai: OpenAI
    anthropic: Anthropic
  env_configured_message: Successfully configured through environment variables.
```
Position this before openai_settings key (before line 42). Follow existing YAML structure and indentation.</action>
  <verify>bin/rails runner "puts I18n.t('settings.hostings.llm_provider_selection.title')" returns "AI Provider"</verify>
  <done>Locale keys present for title, description, label, provider names, env message</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `bin/rails test test/controllers/settings/hostings_controller_test.rb` passes (if test exists)
- [ ] Visit /settings/hosting shows "AI Provider" section with dropdown
- [ ] Selecting "Anthropic" and submitting saves Setting.llm_provider = "anthropic"
- [ ] Selecting "OpenAI" and submitting saves Setting.llm_provider = "openai"
- [ ] ENV["LLM_PROVIDER"]="anthropic" disables the dropdown
</verification>

<success_criteria>

- LLM provider dropdown appears in General section of hosting settings
- Dropdown has two options: "OpenAI" and "Anthropic"
- Selection persists to Setting.llm_provider
- ENV["LLM_PROVIDER"] disables the dropdown when set
- Follows existing UI patterns (auto-submit-form, disabled state for ENV)
  </success_criteria>

<output>
After completion, create `.planning/phases/06-settings-ui/06-01-SUMMARY.md`:

# Phase 6 Plan 1: LLM Provider Selector Summary

**Added LLM provider dropdown to self-hosting settings for provider selection**

## Accomplishments

- Added Setting.llm_provider field with ENV fallback
- Created _llm_provider_selection.html.erb partial following existing patterns
- Added controller support for llm_provider parameter
- Integrated selector into hosting settings view
- Added i18n locale strings

## Files Created/Modified

- `app/models/setting.rb` - Added llm_provider field
- `app/views/settings/hostings/_llm_provider_selection.html.erb` - New partial
- `app/controllers/settings/hostings_controller.rb` - Added llm_provider handling
- `app/views/settings/hostings/show.html.erb` - Rendered selector partial
- `config/locales/views/settings/hostings/en.yml` - Added locale keys

## Decisions Made

- Provider selector placed in "General" section above provider-specific config
- Default value is "openai" for backward compatibility
- Follows existing auto-submit-form pattern (no save button needed)
- ENV["LLM_PROVIDER"] disables dropdown (consistent with other providers)

## Next Step

Ready for 06-02-PLAN.md (Anthropic configuration fields)
</output>
