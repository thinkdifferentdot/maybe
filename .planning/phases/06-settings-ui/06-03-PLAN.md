---
phase: 06-settings-ui
plan: 03
type: execute
---

<objective>
Show/hide provider configuration sections based on selected provider.

Purpose: Users should only see configuration fields for their chosen provider. When OpenAI is selected, hide Anthropic fields. When Anthropic is selected, hide OpenAI fields.

Output: Dynamic show/hide behavior controlled by Stimulus controller, showing only relevant provider settings.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-settings-ui/06-CONTEXT.md
@app/views/settings/hostings/show.html.erb
@app/views/settings/hostings/_provider_selection.html.erb
@app/javascript/controllers/auto_submit_form_controller.js
@config/locales/views/settings/hostings/en.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create provider visibility Stimulus controller</name>
  <files>app/javascript/controllers/provider_visibility_controller.js</files>
  <action>Create new Stimulus controller that shows/hides sections based on provider selection. Pattern:
```javascript
import { Controller } from "@hotwired/stimulus";

export default class extends Controller {
  static targets = ["section"];
  static values = { provider: String };

  connect() {
    this.updateVisibility();
  }

  providerChanged(event) {
    this.providerValue = event.target.value;
    this.updateVisibility();
  }

  updateVisibility() {
    this.sectionTargets.forEach(section => {
      const sectionProvider = section.dataset.provider;
      if (sectionProvider === this.providerValue) {
        section.classList.remove("hidden");
      } else {
        section.classList.add("hidden");
      }
    });
  }
}
```
This follows the reveal-on-selection pattern from CONTEXT.md.</action>
  <verify>File exists at app/javascript/controllers/provider_visibility_controller.js with valid JavaScript</verify>
  <done>Controller created with connect, providerChanged, and updateVisibility methods</done>
</task>

<task type="auto">
  <name>Task 2: Wrap OpenAI settings in visibility-controlled div</name>
  <files>app/views/settings/hostings/_openai_settings.html.erb</files>
  <action>Wrap the entire content in a div with data attributes:
```erb
<div data-provider-visibility-target="section" data-provider="openai">
  <div class="space-y-4">
    <!-- existing content -->
  </div>
</div>
```
The wrapper div goes around the existing space-y-4 div (lines 1-67). This allows the controller to hide/show the entire section.</action>
  <verify>grep 'data-provider-visibility-target' app/views/settings/hostings/_openai_settings.html.erb returns results</verify>
  <done>OpenAI settings wrapped with data-provider="openai" for controller targeting</done>
</task>

<task type="auto">
  <name>Task 3: Wrap Anthropic settings in visibility-controlled div</name>
  <files>app/views/settings/hostings/_anthropic_settings.html.erb</files>
  <action>Wrap the entire content in a div with data attributes:
```erb
<div data-provider-visibility-target="section" data-provider="anthropic">
  <div class="space-y-4">
    <!-- existing content -->
  </div>
</div>
```
Same pattern as OpenAI settings wrapper.</action>
  <verify>grep 'data-provider-visibility-target' app/views/settings/hostings/_anthropic_settings.html.erb returns results</verify>
  <done>Anthropic settings wrapped with data-provider="anthropic" for controller targeting</done>
</task>

<task type="auto">
  <name>Task 4: Attach controller to llm_provider_selection partial</name>
  <files>app/views/settings/hostings/_llm_provider_selection.html.erb</files>
  <action>Add controller attachment to the outer div and action to the select:
1. Add to outer div: `data-controller="provider-visibility" data-provider-visibility-target="section"`
2. Add to select element: `data-action="change->provider-visibility#providerChanged"`
The controller connects on load and listens for selection changes to toggle visibility.</action>
  <verify>grep 'provider-visibility' app/views/settings/hostings/_llm_provider_selection.html.erb returns results</verify>
  <done>Controller attached with change action on select element</done>
</task>

<task type="auto">
  <name>Task 5: Set initial provider value in controller action</name>
  <files>app/controllers/settings/hostings_controller.rb</files>
  <action>In the show method, add instance variable for current provider after line 22:
```ruby
@llm_provider = ENV["LLM_PROVIDER"].presence || Setting.llm_provider
```
This provides the initial value to the view for proper default visibility state.</action>
  <verify>grep '@llm_provider' app/controllers/settings/hostings_controller.rb shows the assignment</verify>
  <done>@llm_provider available in view for initial controller state</done>
</task>

<task type="auto">
  <name>Task 6: Update llm_provider_selection with initial provider value</name>
  <files>app/views/settings/hostings/_llm_provider_selection.html.erb</files>
  <action>Add data-provider-value attribute to the select element to initialize the controller:
```erb
data-provider-visibility-provider-value="<%= @llm_provider %>"
```
This ensures the controller knows the initial provider on connect.</action>
  <verify>File contains data-provider-visibility-provider-value attribute with @llm_provider</verify>
  <done>Controller initializes with current provider value from backend</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Visit /settings/hosting with llm_provider="openai" shows only OpenAI fields
- [ ] Change provider to "Anthropic" hides OpenAI, shows Anthropic fields
- [ ] Change provider to "OpenAI" hides Anthropic, shows OpenAI fields
- [ ] Page reload maintains correct visibility state
- [ ] Only one provider's configuration visible at a time
</verification>

<success_criteria>

- Provider visibility controller created and registered
- OpenAI and Anthropic sections wrapped with data-provider attributes
- Changing provider dropdown immediately toggles visibility
- Initial page load shows correct provider section
- Only selected provider's fields are visible at any time
  </success_criteria>

<output>
After completion, create `.planning/phases/06-settings-ui/06-03-SUMMARY.md`:

# Phase 6 Plan 3: Provider Visibility Toggle Summary

**Implemented show/hide behavior for provider configuration sections**

## Accomplishments

- Created provider_visibility_controller.js Stimulus controller
- Wrapped OpenAI and Anthropic settings with data-provider attributes
- Attached controller to provider selection dropdown
- Added initial provider value from backend

## Files Created/Modified

- `app/javascript/controllers/provider_visibility_controller.js` - New controller
- `app/views/settings/hostings/_openai_settings.html.erb` - Added visibility wrapper
- `app/views/settings/hostings/_anthropic_settings.html.erb` - Added visibility wrapper
- `app/views/settings/hostings/_llm_provider_selection.html.erb` - Attached controller
- `app/controllers/settings/hostings_controller.rb` - Added @llm_provider

## Decisions Made

- Uses hidden class for show/hide (Tailwind standard)
- Controller reads initial provider from @llm_provider instance variable
- Change event triggers immediate visibility update
- Only one provider section visible at a time (clean UX)

## Next Step

Ready for 06-04-PLAN.md (Configuration validation)
</output>
