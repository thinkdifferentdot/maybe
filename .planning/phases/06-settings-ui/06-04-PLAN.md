---
phase: 06-settings-ui
plan: 04
type: execute
---

<objective>
Add configuration validation and error messages for Anthropic settings.

Purpose: Validate Anthropic API configuration before saving, show helpful error messages when configuration is invalid, and ensure users can't save broken settings.

Output: Working validation for anthropic_model with clear error messages following the OpenAI validate_openai_config! pattern.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-settings-ui/06-CONTEXT.md
@app/models/setting.rb
@app/controllers/settings/hostings_controller.rb
@config/locales/views/settings/hostings/en.yml
@config/locales/en.yml (for setting validation error keys)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add validate_anthropic_config! method to Setting model</name>
  <files>app/models/setting.rb</files>
  <action>Add class method after validate_openai_config! (search for existing validation method). Pattern:
```ruby
def self.validate_anthropic_config!(model:)
  return if model.blank?

  # Anthropic models must start with "claude-" prefix
  unless model.start_with?("claude-")
    raise ValidationError, I18n.t("settings.hostings.update.invalid_anthropic_model")
  end
end
```
This validates that Anthropic model names follow the "claude-" prefix convention. Place it near validate_openai_config! for consistency.</action>
  <verify>bin/rails runner "Setting.validate_anthropic_config!(model: 'gpt-4')" raises ValidationError</verify>
  <done>validate_anthropic_config! method exists and validates claude- prefix</done>
</task>

<task type="auto">
  <name>Task 2: Call validation in controller before saving anthropic_model</name>
  <files>app/controllers/settings/hostings_controller.rb</files>
  <action>Add validation call before saving anthropic_model (after the anthropic_access_token block). Pattern follows OpenAI validation (lines 69-75):
```ruby
# Validate Anthropic configuration before updating
if hosting_params.key?(:anthropic_model)
  Setting.validate_anthropic_config!(model: hosting_params[:anthropic_model])
end
```
This ensures invalid models are rejected before saving.</action>
  <verify>grep validate_anthropic_config app/controllers/settings/hostings_controller.rb returns results</verify>
  <done>Controller validates anthropic_model before saving</done>
</task>

<task type="auto">
  <name>Task 3: Add validation error locale string</name>
  <files>config/locales/views/settings/hostings/en.yml</files>
  <action>Add under hostings.update key (find existing update: section with invalid_openai_model). Add:
```yaml
invalid_anthropic_model: "Anthropic model names must start with 'claude-'"
```
Place it after invalid_openai_model for consistency. Keep the message clear and actionable.</action>
  <verify>bin/rails runner "puts I18n.t('settings.hostings.update.invalid_anthropic_model')" returns the error message</verify>
  <done>Locale key exists for anthropic model validation error</done>
</task>

<task type="auto">
  <name>Task 4: Update placeholder with Anthropic model naming guidance</name>
  <files>app/views/settings/hostings/_anthropic_settings.html.erb</files>
  <action>Update the model placeholder to be more specific. Change from generic placeholder to: `"claude-sonnet-4-5-20250929 (default)"`. This shows users the correct format and gives them a working default model to use.</action>
  <verify>grep 'claude-sonnet' app/views/settings/hostings/_anthropic_settings.html.erb returns results</verify>
  <done>Model placeholder shows correct claude- prefix format</done>
</task>

<task type="auto">
  <name>Task 5: Add help text for Anthropic model format</name>
  <files>app/views/settings/hostings/_anthropic_settings.html.erb</files>
  <action>Add small help text below the model field (similar to json_mode_help in openai_settings). Add after the model field:
```erb
<p class="text-xs text-secondary mt-1"><%= t(".model_help") %></p>
```
Then add the locale string with guidance about claude- prefix requirement.</action>
  <verify>File contains help text paragraph below model field</verify>
  <done>Help text appears below model input field</done>
</task>

<task type="auto">
  <name>Task 6: Add model_help locale string</name>
  <files>config/locales/views/settings/hostings/en.yml</files>
  <action>Add under anthropic_settings key:
```yaml
model_help: "Model names must start with 'claude-' (e.g., claude-sonnet-4-5-20250929, claude-opus-4-5)"
```
This provides inline guidance before users attempt to save an invalid model.</action>
  <verify>bin/rails runner "puts I18n.t('settings.hostings.anthropic_settings.model_help')" returns help text</verify>
  <done>Help text locale key added with model format guidance</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Saving anthropic_model="gpt-4" shows error "must start with 'claude-'"
- [ ] Saving anthropic_model="claude-sonnet-4-5-20250929" succeeds
- [ ] Help text appears below model field on the form
- [ ] Placeholder shows a valid claude- model name
- [ ] Error message is clear and actionable
</verification>

<success_criteria>

- validate_anthropic_config! validates claude- prefix
- Controller calls validation before saving
- Invalid models show clear error message
- Help text guides users to correct format
- Placeholder demonstrates valid model name
- Follows OpenAI validation pattern exactly
  </success_criteria>

<output>
After completion, create `.planning/phases/06-settings-ui/06-04-SUMMARY.md`:

# Phase 6 Plan 4: Configuration Validation Summary

**Added Anthropic configuration validation with clear error messages**

## Accomplishments

- Added validate_anthropic_config! method to Setting model
- Integrated validation into controller before saving
- Added locale strings for validation errors
- Added inline help text for model format guidance
- Updated placeholder with valid model example

## Files Created/Modified

- `app/models/setting.rb` - Added validate_anthropic_config! method
- `app/controllers/settings/hostings_controller.rb` - Added validation call
- `app/views/settings/hostings/_anthropic_settings.html.erb` - Added help text
- `config/locales/views/settings/hostings/en.yml` - Added error and help text

## Decisions Made

- Validation checks for "claude-" prefix (Anthropic naming convention)
- Error message is clear: "must start with 'claude-'"
- Help text provides inline guidance before save attempt
- Placeholder shows valid example model name
- Follows OpenAI validation pattern exactly

## Issues Encountered

None

## Next Phase Readiness

Phase 6 complete. Ready for Phase 7 (Langfuse Integration) or Phase 5 (Settings Model) if not yet executed.

Note: Phase 5 (Settings Model) should be completed before Phase 6 execution for proper dependency order, but all plans are created and ready.
</output>
