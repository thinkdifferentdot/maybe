---
phase: 09-resolve-anthropic-issues
plan: 01
type: execute
domain: rails-testing
---

<objective>
Complete Phase 08-03 documentation and perform systematic bug triage for the Anthropic integration.

Purpose: (1) Document the provider switching work completed in Phase 08-03 that never got a SUMMARY.md, (2) Perform a full feature sweep to catalog and fix any remaining Anthropic integration bugs following the systematic triage process from CONTEXT.md.

Output: 08-03-SUMMARY.md documenting provider switching fix, ISSUES.md cataloging discovered bugs, fixes for any critical/normal issues found.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-resolve-anthropic-issues/09-CONTEXT.md
@.planning/phases/09-resolve-anthropic-issues/09-RESEARCH.md
@.planning/phases/08-validation-testing/08-01-SUMMARY.md
@.planning/phases/08-validation-testing/08-02-SUMMARY.md
@.planning/phases/08-validation-testing/08-03-PLAN.md

# Provider switching implementation files:
@app/models/assistant/provided.rb
@app/models/chat.rb
@app/models/provider/anthropic.rb
@app/controllers/settings/hostings_controller.rb
@app/views/settings/hostings/_anthropic_settings.html.erb
@app/views/settings/hostings/_openai_settings.html.erb
@test/controllers/settings/hostings_controller_test.rb
@test/models/setting_test.rb
@test/models/provider/registry_test.rb

**Tech stack available:**
- Minitest for all testing
- Rails console for manual testing
- VCR cassettes from 08-01 for Anthropic API testing

**Established patterns:**
- SUMMARY.md frontmatter with dependency graph
- Issue severity categories: critical, normal, minor
- Resolution documentation pattern from RESEARCH.md

**Constraining decisions:**
- Phase 08-01: Anthropic SDK returns BaseModel with symbol keys
- Phase 08-01: API may return direct arrays, check type before using dig
- Phase 08-01: Function results must include name and arguments for Anthropic
- Phase 08-03 (commit 5832ffab): Fixed provider switching to respect llm_provider setting

**Issues being addressed:**
- Phase 08-03 has no SUMMARY.md (work completed but not documented)
- Unknown bugs may exist that weren't caught in Phase 8 testing

**Phase 8 fixes already applied:**
- ChatParser: Use symbol keys for BaseModel objects
- AutoCategorizer/AutoMerchantDetector: Check array type before using dig
- Function results: Include name and arguments for Anthropic multi-turn
- Provider switching: Assistant::Provided now orders providers by user's llm_provider preference
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Phase 08-03 SUMMARY.md</name>
  <files>.planning/phases/08-validation-testing/08-03-SUMMARY.md</files>
  <action>Create 08-03-SUMMARY.md documenting the provider switching work completed in commits:
- 3d5b7b44: Setting model tests for llm_provider and Anthropic fields
- a079566c: Registry tests for LLM provider selection
- 5832ffab: Fix provider switching to respect llm_provider setting

Include frontmatter with dependency graph, key-files, key-decisions, patterns-established. Document the critical bug fix where chats would always use OpenAI even when Anthropic was selected. Use the same format as 08-01-SUMMARY.md and 08-02-SUMMARY.md.</action>
  <verify>File .planning/phases/08-validation-testing/08-03-SUMMARY.md exists with proper frontmatter and sections</verify>
  <done>08-03-SUMMARY.md created with commits, files changed, decisions documented</done>
</task>

<task type="auto">
  <name>Task 2: Perform full feature sweep and create ISSUES.md catalog</name>
  <files>.planning/phases/09-resolve-anthropic-issues/ISSUES.md</files>
  <action>Perform systematic bug discovery following CONTEXT.md process. Test ALL features:

1. Chat with Anthropic:
   - Start Rails console: bin/rails console
   - Test basic chat: Assistant::Provided.new.chat("Hello")
   - Verify Anthropic is used when llm_provider="anthropic"

2. Auto-categorization with Anthropic:
   - Test: Provider::Anthropic.new.auto_categorize("Starbucks purchase")
   - Verify category returned

3. Merchant detection with Anthropic:
   - Test: Provider::Anthropic.new.auto_detect_merchants("Starbucks coffee")
   - Verify merchants returned

4. Settings UI:
   - Check views render correctly for both providers
   - Verify validation messages appear

5. Provider switching:
   - Switch from OpenAI to Anthropic
   - Verify subsequent AI calls use Anthropic

Create ISSUES.md with format:
```markdown
# Phase 9: Anthropic Issues Catalog

## Critical Issues
[Bugs that completely break functionality]

## Normal Issues
[Bugs with workarounds or partial functionality]

## Minor Issues
[Cosmetic or low-impact issues]
```

If no issues found, document that explicitly.</action>
  <verify>ISSUES.md exists in .planning/phases/09-resolve-anthropic-issues/</verify>
  <done>All features tested, issues cataloged with severity levels</done>
</task>

<task type="auto">
  <name>Task 3: Fix discovered issues</name>
  <files>varies based on issues found</files>
  <action>Work through ISSUES.md systematically:

1. **Critical issues:** Fix immediately
2. **Normal issues:** Fix if time permits, otherwise document as deferred
3. **Minor issues:** Document only, defer to future

For each fix:
- Write failing test first (if not already covered)
- Implement fix
- Update ISSUES.md with resolution status

Use the resolution documentation pattern from RESEARCH.md:
```markdown
## Issue: [Title]
**Status:** Fixed / Won't Fix / Deferred
**Severity:** Critical / Normal / Minor
**Discovery:** [How it was found]
**Resolution:** [What was done]
**Files Changed:** [List of files]
```

If no issues found, document in ISSUES.md that all features verified working.</action>
  <verify>All critical and normal issues have "Status: Fixed" or documented rationale for deferral</verify>
  <done>All discovered issues resolved or properly deferred</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] 08-03-SUMMARY.md exists and matches format of other phase summaries
- [ ] ISSUES.md exists with all features tested
- [ ] Any critical issues discovered are fixed
- [ ] Git commits created for any fixes
</verification>

<success_criteria>

- Phase 08-03 documented with SUMMARY.md
- All Anthropic features tested and cataloged
- Critical issues resolved
- ISSUES.md provides clear resolution status for all discovered bugs
  </success_criteria>

<output>
After completion, create `.planning/phases/09-resolve-anthropic-issues/09-01-SUMMARY.md`:

# Phase 9 Plan 1: Resolve Anthropic Issues Summary

**[One-line summary of what was accomplished]**

## Accomplishments

- Created 08-03-SUMMARY.md documenting provider switching fix
- Performed full feature sweep of all Anthropic functionality
- Cataloged [X] issues in ISSUES.md
- Fixed [X] critical/normal issues

## Files Created/Modified

- `.planning/phases/08-validation-testing/08-03-SUMMARY.md` - Phase 08-03 documentation
- `.planning/phases/09-resolve-anthropic-issues/ISSUES.md` - Issues catalog
- [List any files modified for fixes]

## Commits

- [List commits for fixes, if any]

## Issues Resolved

[Summary from ISSUES.md]

## Next Step

Phase 9 complete! All Anthropic integration issues resolved and documented.
</output>
