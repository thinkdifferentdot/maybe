---
phase: 18-fuzzy-category-merchant-matching
plan: 01
type: execute
domain: rails
---

<objective>
Port fuzzy name matching functionality from OpenAI to Anthropic's AutoCategorizer to enable better category and merchant normalization.

Purpose: Achieve feature parity between providers - both OpenAI and Anthropic should use fuzzy matching to normalize AI-returned category names and handle common variations (e.g., "gasoline" → "Gas & Fuel", "coffee shop" → "Coffee Shops").

Output: Provider::Anthropic::AutoCategorizer updated with `find_fuzzy_category_match` and `fuzzy_name_match?` methods, plus test coverage.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-fuzzy-category-merchant-matching/18-CONTEXT.md
@.planning/phases/18-fuzzy-category-merchant-matching/18-RESEARCH.md

# Source implementation (OpenAI):
@app/models/provider/openai/auto_categorizer.rb

# Target implementation (Anthropic):
@app/models/provider/anthropic/auto_categorizer.rb

# Test patterns:
@test/models/provider/anthropic_test.rb

**Established patterns:**
- Ruby string operations for fuzzy matching (no external gem required)
- Normalization: downcase + gsub(/[^a-z0-9]/, "") for comparison
- Substring matching: normalized_input.include?(normalized_cat) || normalized_cat.include?(normalized_input)
- Synonym mappings via variations hash

**Tech stack available:**
- Rails 7.2
- Ruby stdlib (String methods)
- Minitest for testing

**Constraining decisions:**
- Phase 17: Test patterns established in anthropic_test.rb
- Phase 16: Anthropic chat streaming completed
- Research recommendation: Port existing OpenAI implementation first; Levenshtein improvement deferred to future work

**Issues being addressed:** None (feature parity work)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Port fuzzy_name_match? method to Anthropic AutoCategorizer</name>
  <files>app/models/provider/anthropic/auto_categorizer.rb</files>
  <action>
Add private method `fuzzy_name_match?(input, category)` to Provider::Anthropic::AutoCategorizer.

Port the exact implementation from OpenAI (lines 314-340 of openai/auto_categorizer.rb):

```ruby
def fuzzy_name_match?(input, category)
  variations = {
    "gas" => [ "gas & fuel", "gas and fuel", "fuel", "gasoline" ],
    "restaurants" => [ "restaurant", "dining", "food" ],
    "groceries" => [ "grocery", "supermarket", "food store" ],
    "streaming" => [ "streaming services", "streaming service" ],
    "rideshare" => [ "ride share", "ride-share", "uber", "lyft" ],
    "coffee" => [ "coffee shops", "coffee shop", "cafe" ],
    "fast food" => [ "fastfood", "quick service" ],
    "gym" => [ "gym & fitness", "fitness", "gym and fitness" ],
    "flights" => [ "flight", "airline", "airlines", "airfare" ],
    "hotels" => [ "hotel", "lodging", "accommodation" ]
  }

  input_lower = input.to_s.downcase
  category_lower = category.to_s.downcase

  variations.each do |_key, synonyms|
    if synonyms.include?(input_lower) && synonyms.include?(category_lower)
      return true
    end
  end

  false
end
```

Place this method after the `normalize_category_name` method (around line 237).

WHY: This handles common category name variations that AI might return (e.g., "gasoline" instead of "Gas & Fuel", "cafe" instead of "Coffee Shops").
  </action>
  <verify>Method exists in Provider::Anthropic::AutoCategorizer with correct signature and variations hash</verify>
  <done>fuzzy_name_match? method matches OpenAI implementation exactly</done>
</task>

<task type="auto">
  <name>Task 2: Port find_fuzzy_category_match method to Anthropic AutoCategorizer</name>
  <files>app/models/provider/anthropic/auto_categorizer.rb</files>
  <action>
Add private method `find_fuzzy_category_match(category_name)` to Provider::Anthropic::AutoCategorizer.

Port the exact implementation from OpenAI (lines 294-312 of openai/auto_categorizer.rb):

```ruby
def find_fuzzy_category_match(category_name)
  input_str = category_name.to_s
  normalized_input = input_str.downcase.gsub(/[^a-z0-9]/, "")

  user_categories.each do |cat|
    cat_name_str = cat[:name].to_s
    normalized_cat = cat_name_str.downcase.gsub(/[^a-z0-9]/, "")

    # Check if one contains the other
    return cat[:name] if normalized_input.include?(normalized_cat) || normalized_cat.include?(normalized_input)

    # Check common abbreviations/variations
    return cat[:name] if fuzzy_name_match?(input_str, cat_name_str)
  end

  nil
end
```

Place this method before the `fuzzy_name_match?` method (around line 238, before the newly added fuzzy_name_match?).

WHY: This enables substring matching (e.g., "coffee" matches "Coffee Shops") and delegates to fuzzy_name_match? for synonym checking.
  </action>
  <verify>Method exists in Provider::Anthropic::AutoCategorizer with correct signature and iteration logic</verify>
  <done>find_fuzzy_category_match method matches OpenAI implementation exactly</done>
</task>

<task type="auto">
  <name>Task 3: Update normalize_category_name to call find_fuzzy_category_match</name>
  <files>app/models/provider/anthropic/auto_categorizer.rb</files>
  <action>
Update the `normalize_category_name` method in Provider::Anthropic::AutoCategorizer to add fuzzy matching fallback.

Currently the method (lines 222-237) returns after case-insensitive match. Add the fuzzy match step before returning the normalized string:

```ruby
def normalize_category_name(category_name)
  return nil if category_name.nil? || category_name == "null"

  normalized = category_name.to_s.strip
  return nil if normalized.empty? || normalized == "null"

  # Try exact match first
  exact_match = user_categories.find { |c| c[:name] == normalized }
  return exact_match[:name] if exact_match

  # Try case-insensitive match
  case_insensitive_match = user_categories.find { |c| c[:name].to_s.downcase == normalized.downcase }
  return case_insensitive_match[:name] if case_insensitive_match

  # Try partial/fuzzy match (for common variations) - ADD THIS
  fuzzy_match = find_fuzzy_category_match(normalized)
  return fuzzy_match if fuzzy_match

  normalized  # Return normalized string if no match found
end
```

The only change is adding the 3 lines for fuzzy match between case_insensitive_match and the final return.

WHY: This integrates the fuzzy matching into the normalization flow, matching OpenAI's behavior.
  </action>
  <verify>normalize_category_name calls find_fuzzy_category_match before returning normalized string</verify>
  <done>normalize_category_name method matches OpenAI implementation structure</done>
</task>

<task type="auto">
  <name>Task 4: Add tests for fuzzy matching in anthropic_test.rb</name>
  <files>test/models/provider/anthropic_test.rb</files>
  <action>
Add test methods for fuzzy matching to Provider::AnthropicTest class.

Add 3 new test methods after existing tests (around line 120+):

1. `test_fuzzy_name_match_handles_common_variations` - Test fuzzy_name_match? directly
   - Create AutoCategorizer instance with mock categories
   - Assert fuzzy_name_match?("gasoline", "gas & fuel") returns true
   - Assert fuzzy_name_match?("coffee shop", "coffee shops") returns true
   - Assert fuzzy_name_match?("unrelated", "restaurants") returns false

2. `test_find_fuzzy_category_match_handles_substrings` - Test substring matching
   - Create AutoCategorizer with categories including "Coffee Shops"
   - Assert find_fuzzy_category_match("coffee") returns "Coffee Shops"
   - Assert find_fuzzy_category_match("coffee shop") returns "Coffee Shops"
   - Assert find_fuzzy_category_match("Gas & Fuel") returns "Gas & Fuel" (via synonym)

3. `test_normalize_category_name_applies_fuzzy_matching` - Test integration with normalize_category_name
   - Create AutoCategorizer with user_categories array
   - Test "gasoline" normalizes to "Gas & Fuel"
   - Test "coffee shop" normalizes to "Coffee Shops"
   - Test "unmatched" returns as-is (no match found)

Use create_provider helper and follow existing test patterns. No VCR needed for these unit tests.

WHY: Validates the fuzzy matching logic works correctly for common variations and substring matches.
  </action>
  <verify>Run: bin/rails test test/models/provider/anthropic_test.rb -n test_fuzzy_name_match_handles_common_variations</verify>
  <done>All 3 fuzzy matching tests pass, validating synonym lookup and substring matching</done>
</task>

<task type="auto">
  <name>Task 5: Verify no regressions - run full Anthropic test suite</name>
  <files>test/models/provider/anthropic_test.rb</files>
  <action>
Run the complete Anthropic test suite to ensure fuzzy matching changes don't break existing functionality.

Execute: bin/rails test test/models/provider/anthropic_test.rb

This validates:
- Existing auto_categorize test (from Phase 17) still passes
- New fuzzy matching tests work correctly
- All other Anthropic tests remain green
  </action>
  <verify>bin/rails test test/models/provider/anthropic_test.rb passes with all tests green (should be ~13 tests total)</verify>
  <done>All tests pass, no regressions introduced</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] fuzzy_name_match? method added to Provider::Anthropic::AutoCategorizer
- [ ] find_fuzzy_category_match method added to Provider::Anthropic::AutoCategorizer
- [ ] normalize_category_name updated to call fuzzy matching
- [ ] 3 new tests added to anthropic_test.rb
- [ ] All Anthropic tests pass (no regressions)
</verification>

<success_criteria>

- Fuzzy matching methods ported from OpenAI to Anthropic
- Category name normalization now handles synonyms and substrings
- Test coverage validates fuzzy matching behavior
- Feature parity achieved: Anthropic matches OpenAI's normalization logic
  </success_criteria>

<output>
After completion, create `.planning/phases/18-fuzzy-category-merchant-matching/18-01-SUMMARY.md`:

# Phase 18 Plan 1: Fuzzy Category & Merchant Matching Summary

**Ported fuzzy name matching from OpenAI to Anthropic, enabling better category/merchant normalization**

## Accomplishments

- Added `fuzzy_name_match?` method to handle common category name variations (synonyms)
- Added `find_fuzzy_category_match` method for substring matching and synonym lookup
- Updated `normalize_category_name` to apply fuzzy matching as fallback
- Added 3 tests validating fuzzy matching behavior
- Verified all tests pass (no regressions)

## Files Created/Modified

- `app/models/provider/anthropic/auto_categorizer.rb` - MODIFIED: Added fuzzy_name_match?, find_fuzzy_category_match, updated normalize_category_name
- `test/models/provider/anthropic_test.rb` - MODIFIED: Added 3 fuzzy matching tests

## Decisions Made

None - ported existing OpenAI implementation as-is for feature parity. Levenshtein distance improvement deferred per research recommendation.

## Issues Encountered

None

## Next Phase

Phase 19: Flexible JSON Parsing - ready to begin
</output>
