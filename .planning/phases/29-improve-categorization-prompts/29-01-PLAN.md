# Phase 29: Improve Categorization Prompts - Plan

**Created:** 2026-01-11
**Status:** Ready for execution
**Type:** Implementation

<objective>
Add few-shot examples to AI categorization prompts to reduce >50% null categorization results. Implement a two-tier few-shot system with static baseline examples (3-5 hardcoded) and optional user-specific LearnedPattern examples (0-3).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@.planning/phases/29-improve-categorization-prompts/29-RESEARCH.md
</execution_context>

<context>
**Phase:**
Phase 29 from ROADMAP.md — Goal: "Add few-shot examples to prompts to reduce >50% null categorization results"

**User Vision (from 29-CONTEXT.md):**
- Two-tier approach: static baseline examples + optional LearnedPattern enhancement
- Ship something pragmatic over perfection
- Reuse existing LearnedPattern model, no new infrastructure

**Research Findings (from 29-RESEARCH.md):**
- OpenAI Cookbook confirms transaction categorization benefits significantly from few-shot examples
- 3-5 static examples + 0-3 dynamic examples is optimal
- Category diversity > similarity when selecting examples
- Minimal format: "Transaction: DESCRIPTION → Category: NAME"

**Codebase Context:**
- `Provider::Openai::AutoCategorizer` (456 lines) — uses `developer_message_for_generic` for prompt
- `Provider::Anthropic::AutoCategorizer` (293 lines) — uses `developer_message` for prompt
- Both accept `family` parameter (already passed but unused)
- Both include shared concerns (JsonParser, ErrorHandler, UsageRecorder)
- `LearnedPattern` model has `merchant_name`, `category_id`, `family_id`
- Family has `has_many :learned_patterns`

**Integration Points:**
1. Create `Provider::Concerns::FewShotExamples` module
2. Modify `Provider::Openai::AutoCategorizer#developer_message_for_generic`
3. Modify `Provider::Anthropic::AutoCategorizer#developer_message`
</context>

<tasks>
## Task 1: Create Provider::Concerns::FewShotExamples Module

**File:** `app/models/provider/concerns/few_shot_examples.rb`

Create a shared concern for building few-shot examples following the two-tier pattern:

```ruby
module Provider::Concerns::FewShotExamples
  extend ActiveSupport::Concern

  private

  def build_few_shot_examples
    examples = static_examples

    # Add user-specific examples if family has LearnedPattern records
    examples.concat(dynamic_examples) if family && family.learned_patterns.exists?

    examples
  end

  def static_examples
    # 3-5 hardcoded examples covering common transaction types
    # Only include if category exists in user_categories
    [
      { description: "WHOLE FOODS MARKET", category: "Groceries" },
      { description: "SHELL SERVICE STATION", category: "Gas & Fuel" },
      { description: "STARBUCKS", category: "Coffee Shops" },
      { description: "NETFLIX", category: "Streaming Services" },
      { description: "CHIPOTLE", category: "Restaurants" }
    ].select { |ex| category_exists?(ex[:category]) }
  end

  def dynamic_examples
    # Get diverse category examples (one per category max)
    patterns_by_category = family.learned_patterns.includes(:category).group_by(&:category)

    # Sample up to 3 categories, take first pattern from each
    patterns_by_category.values.sample(3).map(&:first).map do |pattern|
      {
        description: pattern.merchant_name,
        category: pattern.category.name
      }
    end
  end

  def category_exists?(name)
    user_categories.any? { |c| c[:name] == name }
  end

  def format_few_shot_examples(examples)
    return "" if examples.empty?

    examples.map do |ex|
      "Transaction: #{ex[:description]} → Category: #{ex[:category]}"
    end.join("\n")
  end
end
```

**Key decisions:**
- Static examples use recognizable real-world brands (OpenAI Cookbook pattern)
- Dynamic examples use category-based grouping for diversity (not all coffee shops)
- Only include static examples if user has that category name
- Minimal format without verbose explanations

---

## Task 2: Modify Provider::Openai::AutoCategorizer

**File:** `app/models/provider/openai/auto_categorizer.rb`

**Changes:**
1. Add `include Provider::Concerns::FewShotExamples` after other includes
2. Modify `developer_message_for_generic` to include few-shot examples before the transactions

```ruby
def developer_message_for_generic
  few_shot_text = build_few_shot_examples_text

  <<~MESSAGE.strip_heredoc
    #{few_shot_text}

    AVAILABLE CATEGORIES: #{user_categories.map { |c| c[:name] }.join(", ")}

    TRANSACTIONS TO CATEGORIZE:
    #{format_transactions_simply}

    CATEGORIZATION GUIDELINES:
    # ... (existing guidelines unchanged)

    Respond with ONLY this JSON (no markdown code blocks, no other text):
    {"categorizations": [{"transaction_id": "...", "category_name": "..."}]}
  MESSAGE
end

def build_few_shot_examples_text
  examples = build_few_shot_examples
  return "" if examples.empty?

  <<~EXAMPLES
    EXAMPLES:
    #{format_few_shot_examples(examples)}

  EXAMPLES
end
```

---

## Task 3: Modify Provider::Anthropic::AutoCategorizer

**File:** `app/models/provider/anthropic/auto_categorizer.rb`

**Changes:**
1. Add `include Provider::Concerns::FewShotExamples` after other includes
2. Modify `developer_message` to include few-shot examples

```ruby
def developer_message
  few_shot_text = build_few_shot_examples_text

  <<~MESSAGE.strip_heredoc
    #{few_shot_text}
    Here are the user's available categories in JSON format:

    ```json
    #{user_categories.to_json}
    ```

    Use the available categories to auto-categorize the following transactions:

    ```json
    #{transactions.to_json}
    ```

    Use the categorize_transactions tool to provide your categorizations.
  MESSAGE
end

def build_few_shot_examples_text
  examples = build_few_shot_examples
  return "" if examples.empty?

  <<~EXAMPLES
    EXAMPLES:
    #{format_few_shot_examples(examples)}

  EXAMPLES
end
```

---

## Task 4: Add Tests for FewShotExamples

**File:** `test/models/provider/concerns/few_shot_examples_test.rb`

Test the concern's behavior:
1. Static examples are returned
2. Static examples filter to user's available categories
3. Dynamic examples are added when family has LearnedPatterns
4. Dynamic examples are diverse (one per category)
5. Empty examples returns empty when family has no patterns
6. Format examples produces correct string output

**Integration test:** Verify that `developer_message` includes few-shot text when examples exist.
</tasks>

<verification>
## Verification Steps

1. **Run existing provider tests:**
   ```bash
   bin/rails test test/models/provider/openai/auto_categorizer_test.rb
   bin/rails test test/models/provider/anthropic/auto_categorizer_test.rb
   ```
   All existing tests should pass (no regressions).

2. **Run new FewShotExamples tests:**
   ```bash
   bin/rails test test/models/provider/concerns/few_shot_examples_test.rb
   ```
   All new tests should pass.

3. **Check prompt content (manual):**
   - In Rails console, create an AutoCategorizer with a family that has LearnedPatterns
   - Call `developer_message` or `developer_message_for_generic`
   - Verify EXAMPLES section appears with static + dynamic examples

4. **Validate token counts:**
   - Examples should add ~200-400 tokens per prompt
   - Not 5x increase (would indicate token bloat anti-pattern)

5. **Test with no LearnedPatterns:**
   - Create AutoCategorizer with nil family or family with no patterns
   - Verify static examples still appear (if categories match)
</verification>

<success_criteria>
- [ ] `Provider::Concerns::FewShotExamples` module created
- [ ] Both `Provider::Openai::AutoCategorizer` and `Provider::Anthropic::AutoCategorizer` include the concern
- [ ] `developer_message` and `developer_message_for_generic` include few-shot examples
- [ ] All existing provider tests pass (210 tests)
- [ ] New FewShotExamples tests pass
- [ ] Manual verification confirms prompts include EXAMPLES section
- [ ] Token increase is reasonable (<500 tokens per prompt)
</success_criteria>

<output>
**Files created:**
- `app/models/provider/concerns/few_shot_examples.rb`
- `test/models/provider/concerns/few_shot_examples_test.rb`

**Files modified:**
- `app/models/provider/openai/auto_categorizer.rb` (add include, modify developer_message_for_generic)
- `app/models/provider/anthropic/auto_categorizer.rb` (add include, modify developer_message)

**Expected test count:** ~42 new tests (6 for FewShotExamples concern + integration)
**Expected time:** ~10 minutes for implementation, ~5 minutes for testing
</output>

---

*Phase: 29-improve-categorization-prompts*
*Plan created: 2026-01-11*
*Ready for execution: yes*
