---
phase: 29-improve-categorization-prompts
plan: 01
type: execute
---

<objective>
Enhance AI categorization prompts with few-shot examples to reduce >50% null categorization results.

Purpose: Current prompts use zero-shot learning (instructions only, no examples). Adding few-shot examples demonstrates expected output patterns, significantly improving categorization accuracy for both OpenAI and Anthropic providers.

Output: Enhanced prompts in both AutoCategorizer classes with curated few-shot examples, plus test validation showing improved accuracy.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Current prompt implementations (zero-shot)
@app/models/provider/openai/auto_categorizer.rb
@app/models/provider/anthropic/auto_categorizer.rb

# Example of few-shot already working in merchant detection
@app/models/provider/openai/auto_merchant_detector.rb

# Test data showing transaction patterns
@test/models/provider/anthropic_test.rb

# Phase 27 summary - for recent prompt context
@.planning/phases/27-simplify-json-parsing/27-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Design few-shot examples for common transaction patterns</name>
  <files>app/models/provider/openai/auto_categorizer.rb, app/models/provider/anthropic/auto_categorizer.rb</files>
  <action>Create a constant FEW_SHOT_EXAMPLES at top of each AutoCategorizer class with 8-10 curated examples covering:

1. Clear merchant with hint (e.g., "McDonalds" with hint "Fast Food" → "Fast Food")
2. Known brand (e.g., "Amazon purchase" → "Shopping")
3. Subscription service (e.g., "Netflix subscription" with hint "Subscriptions" → "Subscriptions")
4. Income (e.g., "paycheck" → "Income")
5. Ambiguous but inferable (e.g., "Italian dinner with friends" → "Restaurants")
6. Generic/uncategorizable (e.g., "1212XXXBCaaa charge" → null)
7. POS payment (e.g., "POS DEBIT 12345" → null)
8. Check/ACH (e.g., "ACH WITHDRAWAL" → null)

Use format: {input: {...}, output: {...}} for programmatic rendering into prompts.
</action>
  <verify>FEW_SHOT_EXAMPLES constant defined in both files with 8+ curated examples</verify>
  <done>Shared few-shot examples constant available for prompt building</done>
</task>

<task type="auto">
  <name>Task 2: Enhance OpenAI detailed_instructions with few-shot examples</name>
  <files>app/models/provider/openai/auto_categorizer.rb</files>
  <action>Update detailed_instructions method to include a "Few-Shot Examples" section before the closing instruction. Add examples showing transaction input → expected category output. Format as:

```
Here are examples of how to categorize:

Example 1:
Transaction: "McDonalds", hint: "Fast Food", classification: "expense"
→ Category: "Fast Food" (matches hint, prefer specific subcategory)

Example 2:
Transaction: "Amazon purchase", classification: "expense"
→ Category: "Shopping" (known brand)

Example 3:
Transaction: "1212XXXBCaaa charge", classification: "expense"
→ Category: null (generic/unclear, better to return null than false positive)

[continue with remaining examples]
```

Keep existing rules, add examples as illustration section.
</action>
  <verify>detailed_instructions method includes few-shot examples section, examples demonstrate key patterns</verify>
  <done>OpenAI AutoCategorizer prompt enhanced with few-shot learning</done>
</task>

<task type="auto">
  <name>Task 3: Enhance Anthropic instructions with few-shot examples</name>
  <files>app/models/provider/anthropic/auto_categorizer.rb</files>
  <action>Update instructions method to include same few-shot examples as OpenAI. Anthropic uses tool calling so format examples as tool use demonstration:

```
Here are examples of how to categorize:

Example 1: "McDonalds" with hint "Fast Food"
→ Use categorize_transactions tool: {transaction_id: "1", category_name: "Fast Food"}

Example 2: "Generic POS DEBIT 12345"
→ Use categorize_transactions tool: {transaction_id: "2", category_name: null}

[continue with remaining examples]
```

Ensure Anthropic and OpenAI prompts have consistent examples for comparable results.
</action>
  <verify>instructions method includes few-shot examples, format compatible with tool calling</verify>
  <done>Anthropic AutoCategorizer prompt enhanced with few-shot learning</done>
</task>

<task type="auto">
  <name>Task 4: Update developer_message_for_generic with inline examples</name>
  <files>app/models/provider/openai/auto_categorizer.rb</files>
  <action>Enhance developer_message_for_generic (used for smaller/local LLMs) with inline few-shot examples. Add section after "CATEGORIZATION GUIDELINES":

```
EXAMPLES:
- "McDonalds" → Fast Food (clear merchant, use hint)
- "Amazon purchase" → Shopping (known brand)
- "Netflix subscription" → Subscriptions (subscription service)
- "paycheck" → Income (income classification)
- "Italian dinner with friends" → Restaurants (inferable from description)
- "1212XXXBCaaa charge" → null (generic/unclear)
- "POS DEBIT 12345" → null (POS terminal)
- "ACH WITHDRAWAL" → null (bank transfer)
```

Keep concise format - generic LLMs need shorter prompts.
</action>
  <verify>developer_message_for_generic includes inline examples section, examples are concise</verify>
  <done>Generic prompt (smaller LLMs) enhanced with few-shot examples</done>
</task>

<task type="auto">
  <name>Task 5: Add categorization accuracy tests</name>
  <files>test/models/provider/openai/auto_categorizer_test.rb, test/models/provider/anthropic_test.rb</files>
  <action>Add test cases to verify improved categorization with few-shot prompts. Create test "auto categorization improves with few-shot examples" that:

1. Uses a set of challenging transactions (generic names, ambiguous descriptions)
2. Counts null categorizations before/after few-shot (use VCR cassettes for consistency)
3. Verifies specific patterns are now categorized correctly (e.g., "McDonalds" → Fast Food not null)

Target: Demonstrate that few-shot examples reduce nulls for recognizable transactions by 30%+.

Note: This test documents improvement - actual reduction depends on LLM behavior.
</action>
  <verify>Test file exists with accuracy verification test, VCR cassettes record baseline and improved behavior</verify>
  <done>Tests exist to validate few-shot effectiveness</done>
</task>

<task type="auto">
  <name>Task 6: Run full test suite to verify no regressions</name>
  <files>app/models/provider/openai/auto_categorizer.rb, app/models/provider/anthropic/auto_categorizer.rb, test/models/provider/openai/auto_categorizer_test.rb, test/models/provider/anthropic_test.rb</files>
  <action>Run bin/rails test to verify all provider tests still pass after prompt enhancements. The enhanced prompts should maintain existing correct categorizations while improving edge cases. Verify all 174+ provider tests pass.

Also run: bin/rails test test/models/provider/openai/auto_categorizer_test.rb
And: bin/rails test test/models/provider/anthropic_test.rb
</action>
  <verify>bin/rails test passes with all provider tests passing, no regressions in existing categorization behavior</verify>
  <done>All tests passing, prompt enhancements deployed without breaking changes</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] FEW_SHOT_EXAMPLES constant defined in both AutoCategorizers
- [ ] Both detailed_instructions methods include few-shot examples
- [ ] developer_message_for_generic includes inline examples
- [ ] Categorization accuracy tests added
- [ ] bin/rails test passes (all 174+ provider tests)
- [ ] No regressions in existing categorization behavior
</verification>

<success_criteria>

- Few-shot examples integrated into all prompt variants (OpenAI detailed, OpenAI generic, Anthropic)
- 8-10 curated examples covering common patterns (clear merchants, brands, subscriptions, income, ambiguous, generic)
- Test coverage validates prompt improvements
- All existing tests pass (no regressions)
  </success_criteria>

<output>
After completion, create `.planning/phases/29-improve-categorization-prompts/29-01-SUMMARY.md`:

# Phase 29 Plan 1: Improve Categorization Prompts Summary

**Enhanced AI categorization prompts with few-shot examples to reduce null categorization results.**

## Accomplishments

- Added FEW_SHOT_EXAMPLES constant with 8-10 curated transaction patterns
- Integrated few-shot examples into OpenAI detailed_instructions prompt
- Integrated few-shot examples into Anthropic instructions prompt (tool-calling format)
- Enhanced developer_message_for_generic with inline examples for smaller LLMs
- Added categorization accuracy tests to validate improvements
- All 174+ provider tests passing with no regressions

## Files Created/Modified

- `app/models/provider/openai/auto_categorizer.rb` - MODIFIED: Added FEW_SHOT_EXAMPLES, enhanced prompts
- `app/models/provider/anthropic/auto_categorizer.rb` - MODIFIED: Added FEW_SHOT_EXAMPLES, enhanced prompts
- `test/models/provider/openai/auto_categorizer_test.rb` - MODIFIED: Added accuracy tests
- `test/models/provider/anthropic_test.rb` - MODIFIED: Added accuracy tests

## Decisions Made

- Use same few-shot examples across both providers for consistent behavior
- Format examples differently for Anthropic (tool-calling) vs OpenAI (JSON schema)
- Keep generic LLM prompts concise (inline examples, not verbose demonstrations)

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 29 complete — v1.3 Milestone complete! Ready for v1.4 or new milestone planning.
</output>
