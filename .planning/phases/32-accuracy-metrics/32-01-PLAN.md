---
phase: 32-accuracy-metrics
plan: 01
type: execute
---

<objective>
Build AI categorization accuracy metrics dashboard showing per-category accuracy with drill-down into miscategorized transactions.

Purpose: Enable users to see which categories AI categorizes well vs. poorly, and understand WHY misclassifications happen so they can improve their LearnedPatterns.

Output: Settings page at `/settings/accuracy_metrics` showing:
- Per-category accuracy list with percentages and raw counts (e.g., "Groceries: 95% (42/44 correct)")
- Time window selector (7 days, 30 days, all time)
- Drill-down per category showing "Recent misses" with transaction details and the pattern that caused confusion
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-learned-pattern-integration/30-01-SUMMARY.md
@.planning/phases/31-feedback-ui/31-CONTEXT.md
@.planning/phases/32-accuracy-metrics/32-CONTEXT.md
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/STRUCTURE.md
@.planning/codebase/ARCHITECTURE.md
@app/models/learned_pattern.rb
@app/models/transaction.rb
@app/controllers/settings/auto_categorization_controller.rb
@app/views/settings/auto_categorization/show.html.erb
@config/routes.rb
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CategorizationFeedback model and migration</name>
  <files>db/migrate/20260111000001_create_categorization_feedbacks.rb, app/models/categorization_feedback.rb</files>
  <action>Create a new model to track AI categorization outcomes. Schema:
- id (uuid, primary key)
- family_id (uuid, indexed, not null)
- transaction_id (uuid, indexed, not null)
- suggested_category_id (uuid, not null) - what AI suggested
- final_category_id (uuid) - what user kept (null if unchanged = implicit correct)
- was_correct (boolean, computed) - true if suggested == final OR final is null (user didn't change)
- created_at, updated_at (datetime)

The was_correct column is a computed/virtual field: suggested_category_id == final_category_id OR final_category_id IS NULL.

Model should:
- belong_to :family
- belong_to :transaction
- belong_to :category, foreign_key: :suggested_category_id
- have scope for time windows (last_7_days, last_30_days, all_time)
- have class method calculate_accuracy_per_category(family, time_window) returning hash {category => {correct: X, total: Y, accuracy: 0.XX}}
- have scope recent_misses(category) for transactions where was_correct = false</action>
  <verify>bin/rails db:migrate runs successfully, rails console test: CategorizationFeedback.create!(family: family, transaction: t, suggested_category: cat) works</verify>
  <done>Migration runs, model created, table exists with proper indexes</done>
</task>

<task type="auto">
  <name>Task 2: Create Settings::AccuracyMetricsController</name>
  <files>app/controllers/settings/accuracy_metrics_controller.rb</files>
  <action>Create controller following the pattern of Settings::AutoCategorizationController:
- layout "settings"
- before_action :ensure_admin
- show action:
  - Set @time_window from params (default: "30_days", options: "7_days", "30_days", "all_time")
  - Calculate @category_metrics using CategorizationFeedback.calculate_accuracy_per_category
  - Set @breadcrumbs with "Accuracy Metrics" label
- private methods: ensure_admin (redirects if not Current.user.admin)</action>
  <verify>Controller loads without errors, routes.rb can reference it</verify>
  <done>Controller created with show action, time_window handling, and authorization</done>
</task>

<task type="auto">
  <name>Task 3: Add accuracy metrics route</name>
  <files>config/routes.rb</files>
  <action>Add to namespace :settings block:
resource :accuracy_metrics, only: :show, controller: "accuracy_metrics"

Place it after the auto_categorization route for logical grouping.</action>
  <verify>bin/rails routes | grep accuracy_metrics returns settings/accuracy_metrics</verify>
  <done>Route added, accessible via settings_accuracy_metrics_path helper</done>
</task>

<task type="auto">
  <name>Task 4: Create accuracy metrics show view</name>
  <files>app/views/settings/accuracy_metrics/show.html.erb</files>
  <action>Create view following settings layout pattern:
1. Page title: "AI Categorization Accuracy"
2. Time window tabs: 7 days | 30 days | All time (links with ?time_window= param)
3. Category metrics table/list:
   - Category name (link to drill-down)
   - Accuracy badge (green >80%, yellow 60-80%, orange <60%)
   - Raw counts: "(X/Y correct)"
   - Visual progress bar showing accuracy percentage
4. For categories with <100% accuracy, link to drill-down showing recent misses
5. Empty state: "No AI categorizations tracked yet" message

Use DS components from design system for badges, progress bars, cards. Follow existing settings page styling from auto_categorization/show.html.erb.</action>
  <verify>View renders without syntax errors, shows table structure</verify>
  <done>View displays category metrics with time window selector</done>
</task>

<task type="auto">
  <name>Task 5: Create category drill-down view for recent misses</name>
  <files>app/controllers/settings/accuracy_metrics_controller.rb, app/views/settings/accuracy_metrics/show.html.erb</files>
  <action>Add to controller:
- miss_details action (optional, for drill-down modal or separate section)
- When category_id param present, show recent misses for that category
- Query: CategorizationFeedback.recent_misses(category).includes(:transaction).limit(20)
- For each miss: show transaction details (date, amount, merchant) AND the LearnedPattern that likely caused the misclassification (find via merchant name fuzzy match)

Update view:
- Add collapsible section or modal for category drill-down
- Show "Recent misses for {category_name}"
- Each row: transaction details + "Pattern that matched: {pattern merchant → pattern category}" (if found)
- Link to edit the LearnedPattern or create new one

The pattern matching should reuse the same fuzzy matching logic from LearnedPatternMatcher (exact → substring → fallback).</action>
  <verify>Drill-down shows miscategorized transactions with pattern information</verify>
  <done>Users can see why categories were miscategorized and identify patterns to fix</done>
</task>

<task type="auto">
  <name>Task 6: Integrate feedback recording with AI categorization</name>
  <files>app/models/family/auto_categorizer.rb</files>
  <action>Modify Family::AutoCategorizer to record CategorizationFeedback when AI successfully categorizes a transaction:
- After setting transaction.category_id, create CategorizationFeedback record
- suggested_category_id = the AI-assigned category
- final_category_id = nil (initially - user may change it)
- family_id = Current.family.id
- transaction_id = transaction.id

This creates the "implicit correct" tracking: if user never changes the category, final_category_id stays null and we count it as correct. If user changes category, we'll need to update final_category_id (handled in Phase 31, but we can add a callback for now).

Add this as the last step in the categorization success path, after transaction.update!</action>
  <verify>After AI categorization, CategorizationFeedback records exist with suggested_category_id</verify>
  <done>Every AI categorization creates feedback tracking record</done>
</task>

<task type="auto">
  <name>Task 7: Add accuracy metrics link to settings navigation</name>
  <files>app/views/settings/_settings_nav.html.erb</files>
  <action>Add navigation link to the settings sidebar:
- Label: "AI Accuracy" (or "Accuracy Metrics")
- Path: settings_accuracy_metrics_path
- Position: After "Auto-Categorization" link for logical grouping
- Follow existing nav link pattern (use _settings_nav_link_large or _settings_nav_item partial)</action>
  <verify>Settings page shows "AI Accuracy" link in navigation</verify>
  <done>Users can access accuracy metrics from settings nav</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>AI Categorization Accuracy Metrics page at /settings/accuracy_metrics</what-built>
  <how-to-verify>
    1. Run: bin/dev
    2. Visit: http://localhost:3000/settings/accuracy_metrics
    3. Verify: Page loads with time window selector (7 days | 30 days | All time)
    4. Verify: Category metrics show accuracy percentages and raw counts
    5. Click: Different time window tabs
    6. Verify: Metrics update based on selected time window
    7. Click: Drill-down on a category with <100% accuracy
    8. Verify: Recent misses show with transaction details and pattern information
    9. Verify: Navigation link appears in settings sidebar
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] bin/rails test runs with no new failures (add tests for CategorizationFeedback model)
- [ ] bin/rubocop -f github -a passes with no offenses
- [ ] Page loads at /settings/accuracy_metrics with proper authentication
- [ ] Time window switching works and updates metrics
- [ ] Category drill-down shows recent misses with pattern context
- [ ] Navigation link present in settings sidebar
</verification>

<success_criteria>

- CategorizationFeedback model tracks AI suggestions
- Accuracy metrics page displays per-category accuracy with time windows
- Users can drill into low-accuracy categories to see recent misses
- Pattern information helps users understand WHY miscategorization happened
- Navigation allows easy access from settings menu
  </success_criteria>

<output>
After completion, create `.planning/phases/32-accuracy-metrics/32-01-SUMMARY.md`:

# Phase 32 Plan 1: Accuracy Metrics Summary

**Added AI categorization accuracy tracking and metrics dashboard for per-category visibility into AI performance.**

## Accomplishments

- Created CategorizationFeedback model to track AI categorization outcomes
- Built accuracy metrics page showing per-category accuracy percentages and raw counts
- Added time window selector (7 days, 30 days, all time)
- Implemented drill-down view showing recent misses with pattern context
- Integrated feedback recording into AI categorization flow
- Added navigation link to settings sidebar

## Files Created/Modified

- `db/migrate/TIMESTAMP_create_categorization_feedbacks.rb` - Feedback tracking table
- `app/models/categorization_feedback.rb` - Feedback model with accuracy calculation
- `app/controllers/settings/accuracy_metrics_controller.rb` - Metrics page controller
- `app/views/settings/accuracy_metrics/show.html.erb` - Metrics dashboard view
- `app/models/family/auto_categorizer.rb` - Added feedback recording
- `config/routes.rb` - Added accuracy_metrics route
- `app/views/settings/_settings_nav.html.erb` - Added nav link

## Decisions Made

- Implicit feedback model: user doesn't change category = correct, user changes = incorrect
- Computed was_correct field rather than stored (suggested == final OR final is null)
- Time windows as query params (not separate routes) for simpler implementation
- Drill-down shows both transaction details AND pattern context for actionability

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Phase 32 complete. Phase 31 (Feedback UI) should still be implemented to add explicit checkmark/X feedback buttons and complete the feedback loop.

## Next Step

Ready for Phase 31 implementation or next milestone planning.
</output>
