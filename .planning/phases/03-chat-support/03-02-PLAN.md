---
phase: 03-chat-support
plan: 02
type: execute
domain: rails-models
---

<objective>
Add tool/function calling support to Anthropic chat_response.

Purpose: Enable Claude to call tools/functions during conversations, following the same architectural patterns as Provider::Openai but adapted for Anthropic's tool_use format.

Output: Working tool calling that converts Sure's functions format to Anthropic's tools format and parses tool_use blocks from responses.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/phase-prompt.md
~/.claude/get-shit-done/references/plan-format.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-chat-support/03-CONTEXT.md
@.planning/phases/03-chat-support/03-RESEARCH.md
@.planning/phases/03-chat-support/03-01-PLAN.md
@app/models/provider/anthropic.rb
@app/models/provider/anthropic/chat_config.rb
@app/models/provider/anthropic/chat_parser.rb
@app/models/provider/openai/chat_config.rb
@app/models/provider/openai/chat_parser.rb
@app/models/provider/llm_concept.rb

**Tech stack available:** anthropic gem ~> 1.16.0, ChatConfig/ChatParser from 03-01
**Established patterns:** OpenAI tool calling format, LlmConcept::ChatFunctionRequest

**Constraining decisions:**
- Phase 3-01: Basic chat structure established, max_tokens required
- Phase 3-01: Token field mapping established (input/output -> prompt/completion)
- Phase 3-02: Tool result ordering matters (tool_result blocks must come FIRST in user message)

**Key decisions from RESEARCH.md:**
- Anthropic uses `input_schema` instead of OpenAI's `parameters`
- Tool use blocks have type "tool_use" with id, name, and input fields
- May have parallel tool use (multiple tools in one response) - handle ALL tool_use blocks
- Stop reason "tool_use" indicates tools were called and need results
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tools conversion to ChatConfig</name>
  <files>app/models/provider/anthropic/chat_config.rb</files>
  <action>Update ChatConfig to convert Sure's functions format to Anthropic's tools format:

1. Update initialize to accept functions array
2. Implement tools method that converts functions to Anthropic format:
   - Each function becomes: {name:, description:, input_schema:}
   - Map fn[:name] -> name
   - Map fn[:description] -> description
   - Map fn[:params_schema] -> input_schema
   - Note: Anthropic uses "input_schema" not "parameters" like OpenAI
   - Note: Anthropic doesn't use "strict" parameter (ignore fn[:strict])

3. Keep build_input unchanged for now (function_results added in 03-03)

Key difference from OpenAI:
- OpenAI: {type: "function", function: {name, description, parameters, strict}}
- Anthropic: {name, description, input_schema}

Example mapping:
- Input: {name: "get_weather", description: "Get weather", params_schema: {type: "object", properties: {...}, required: ["location"]}, strict: true}
- Output: {name: "get_weather", description: "Get weather", input_schema: {type: "object", properties: {...}, required: ["location"]}}</action>
  <verify>tools method converts functions array to correct Anthropic format</verify>
  <done>ChatConfig creates valid Anthropic tools from Sure functions format</done>
</task>

<task type="auto">
  <name>Task 2: Add tool_use parsing to ChatParser</name>
  <files>app/models/provider/anthropic/chat_parser.rb</files>
  <action>Update ChatParser to extract tool_use blocks from Anthropic responses:

1. Add function_requests method that:
   - Filters response.content for blocks where block.type == "tool_use"
   - Maps each tool_use block to Provider::LlmConcept::ChatFunctionRequest:
     - id: block.id
     - call_id: block.id (same value - Anthropic uses id for both)
     - function_name: block.name
     - function_args: block.input (already a Hash, no parsing needed)

2. Update parsed method to include function_requests

3. Handle parallel tool use: iterate ALL tool_use blocks (Claude may call multiple tools at once)

Key differences from OpenAI:
- OpenAI has separate "function_call" type items in output array
- Anthropic has tool_use blocks in content array
- OpenAI: call_id is separate from id; Anthropic: id is used for both
- OpenAI: arguments is JSON string; Anthropic: input is already parsed Hash</action>
  <verify>ChatParser extracts tool_use blocks correctly, handles parallel tool calls</verify>
  <done>ChatParser returns ChatFunctionRequest objects for all tool_use blocks</done>
</task>

<task type="auto">
  <name>Task 3: Update chat_response to pass tools to API</name>
  <files>app/models/provider/anthropic.rb</files>
  <action>Update chat_response method to include tools in API call:

1. After building messages, get tools from chat_config:
   - tools = chat_config.tools

2. Pass tools to client.messages.create:
   - Add tools: tools parameter if tools.present?

3. Ensure ChatParser is used to parse the response (already implemented in 03-01)

4. No changes needed to Langfuse or LlmUsage (already working from 03-01)

Note: This plan only adds tool definitions and parsing. The multi-turn conversation with tool results is in 03-03.

For this plan:
- Tools are passed to Claude
- Tool requests are parsed from response
- Tool results are NOT yet sent back (that's 03-03)</action>
  <verify>When tools are provided, Claude can request tool use; ChatParser extracts tool_use blocks</verify>
  <done>chat_response passes tools to Anthropic API and parses tool_use requests</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] ChatConfig converts functions to Anthropic tools format (input_schema not parameters)
- [ ] ChatParser extracts all tool_use blocks (handles parallel tool use)
- [ ] chat_response passes tools parameter to API when tools present
- [ ] ChatFunctionRequest objects have correct structure (id, call_id, function_name, function_args)
- [ ] Tool calls work end-to-end (Claude requests tools, response parsed correctly)
- [ ] No errors or warnings introduced
</verification>

<success_criteria>

- All tasks completed
- Tool calling works from Anthropic to function request parsing
- Parallel tool use is handled (multiple tools in one response)
- Token counting still works correctly
- Langfuse traces still work with tools
  </success_criteria>

<output>
After completion, create `.planning/phases/03-chat-support/03-02-SUMMARY.md`:

# Phase 3 Plan 2: Tool Calling Support Summary

**Added tool/function calling support to Anthropic chat_response with proper format conversion**

## Accomplishments

- Updated ChatConfig to convert functions to Anthropic tools format (input_schema)
- Updated ChatParser to extract tool_use blocks from responses
- Updated chat_response to pass tools to Anthropic Messages API
- Added support for parallel tool use (multiple tools in one response)

## Files Created/Modified

- `app/models/provider/anthropic/chat_config.rb` - Added tools conversion
- `app/models/provider/anthropic/chat_parser.rb` - Added tool_use parsing
- `app/models/provider/anthropic.rb` - Updated chat_response to pass tools

## Decisions Made

- Anthropic uses "input_schema" not "parameters" for tool definitions
- Anthropic's id serves as both id and call_id (unlike OpenAI's separate fields)
- Anthropic's input is already a Hash (not JSON string like OpenAI's arguments)
- Parallel tool use is supported (iterate all tool_use blocks)

## Issues Encountered

[None expected, document any issues that arise]

## Next Step

Ready for 03-03-PLAN.md - Handle function results and multi-turn conversations
</output>
