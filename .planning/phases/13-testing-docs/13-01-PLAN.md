---
phase: 13-testing-docs
plan: 01
type: execute
domain: rails
---

<objective>
Test the LearnedPattern model and LearnedPatternMatcher service to ensure pattern learning and matching work correctly.

Purpose: Verify the core pattern learning infrastructure that enables approved AI categorizations to be reused for future transactions.
Output: Comprehensive test coverage for LearnedPattern model validation, normalization, and matching logic.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-testing-docs/13-CONTEXT.md

# Prior context from phases 10-12:
@.planning/phases/11-import-triggers/11-01-SUMMARY.md

# Key files to reference:
@app/models/learned_pattern.rb
@app/models/learned_pattern_matcher.rb
@app/models/family.rb
@app/models/transaction.rb
@test/models/learned_pattern_test.rb
@test/models/learned_pattern_matcher_test.rb
@test/support/entries_test_helper.rb

# Existing test patterns:
@test/models/provider/anthropic_test.rb
@test/models/family/auto_categorizer_test.rb

**Tech stack available:** Rails 7.2, Minitest, fixtures
**Established patterns:** Use fixtures, EntriesTestHelper for transaction creation, assert_difference for count assertions
**Constraining decisions:**
- Family-scoped patterns only (from 11-01)
- Substring matching sufficient (no fuzzy_match gem)
- Patterns use both original and normalized merchant names

**Key decisions from prior phases:**
- Phase 11-01: LearnedPattern uses automatic merchant name normalization
- Phase 11-01: LearnedPatternMatcher does fuzzy substring matching
- Phase 11-01: Transaction#merchant_name prefers merchant&.name, falls back to entry&.name
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LearnedPattern model test file</name>
  <files>test/models/learned_pattern_test.rb</files>
  <action>Create comprehensive test file for LearnedPattern model with:
1. Validations: presence of family, category, merchant_name; uniqueness of family_id + normalized_merchant
2. Normalization: merchant_name downcased, special characters stripped, extra whitespace collapsed
3. Associations: belongs_to family, belongs_to category
4. Edge cases: empty strings, nil values, very long merchant names, unicode characters

Follow existing test patterns from auto_categorizer_test.rb - use setup with fixtures, clear descriptive test names, assert_difference for count assertions.</action>
  <verify>bin/rails test test/models/learned_pattern_test.rb passes with all tests green</verify>
  <done>All LearnedPattern validations and normalization covered by tests</done>
</task>

<task type="auto">
  <name>Task 2: Create LearnedPatternMatcher service test file</name>
  <files>test/models/learned_pattern_matcher_test.rb</files>
  <action>Create test file for LearnedPatternMatcher service with:
1. Matching logic: exact substring match, case-insensitive matching
2. Multiple patterns: returns most recent pattern when multiple matches exist
3. No match scenario: returns nil when no patterns match
4. Original vs normalized: patterns match both original and normalized merchant names
5. Edge cases: empty merchant list, patterns with special characters, unicode matching

Create fixture patterns in setup using Family.first.categories.first for category. Use EntriesTestHelper pattern for test data creation.</action>
  <verify>bin/rails test test/models/learned_pattern_matcher_test.rb passes with all tests green</verify>
  <done>All LearnedPatternMatcher matching scenarios covered by tests</done>
</task>

<task type="auto">
  <name>Task 3: Add Family pattern learning/matching tests</name>
  <files>test/models/family_test.rb</files>
  <action>Add tests to family_test.rb for the learned pattern methods added in 11-01:
1. learned_pattern_for(merchant_name): returns matching pattern or nil
2. learn_pattern_from!(transaction): creates pattern from transaction's category and merchant
3. Integration: learning a pattern then finding it with learned_pattern_for

Use @family fixture from existing test setup. Create a transaction using EntriesTestHelper.create_transaction with category_id, then call learn_pattern_from! and verify pattern was created.

Follow existing family_test.rb patterns - use setup method, descriptive test names.</action>
  <verify>bin/rails test test/models/family_test.rb -n /learned_pattern/ passes</verify>
  <done>Family learned pattern integration covered by tests</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All new test files run without errors
- [ ] bin/rails test test/models/learned_pattern_test.rb passes
- [ ] bin/rails test test/models/learned_pattern_matcher_test.rb passes
- [ ] bin/rails test test/models/family_test.rb -n /learned_pattern/ passes
- [ ] Total test count increases by expected amount
- [ ] No regressions in existing tests
</verification>

<success_criteria>

- LearnedPattern model has comprehensive validation and normalization tests
- LearnedPatternMatcher service has full coverage of matching scenarios
- Family pattern learning/matching methods have integration tests
- All tests follow existing codebase patterns (fixtures, EntriesTestHelper, descriptive names)
- No test files skip or are marked as pending
</success_criteria>

<output>
After completion, create `.planning/phases/13-testing-docs/13-01-SUMMARY.md`:

# Phase 13 Plan 1: LearnedPattern Model Tests Summary

**Added comprehensive test coverage for LearnedPattern model and matching service**

## Accomplishments

- Created test/models/learned_pattern_test.rb with validation and normalization tests
- Created test/models/learned_pattern_matcher_test.rb with matching logic tests
- Added Family learned pattern integration tests to family_test.rb
- All tests follow existing patterns (fixtures, EntriesTestHelper, descriptive names)

## Files Created/Modified

- `test/models/learned_pattern_test.rb` - New test file
- `test/models/learned_pattern_matcher_test.rb` - New test file
- `test/models/family_test.rb` - Added learned pattern tests

## Test Coverage Added

- LearnedPattern validations (presence, uniqueness)
- LearnedPattern normalization (downcase, strip special chars, collapse whitespace)
- LearnedPattern associations (family, category)
- LearnedPatternMatcher exact substring matching (case-insensitive)
- LearnedPatternMatcher multiple pattern handling (returns most recent)
- Family#learned_pattern_for and Family#learn_pattern_from! integration

## Decisions Made

None - following patterns established in 11-01

## Issues Encountered

[Document any issues found during testing]

## Next Step

Ready for 13-02-PLAN.md (AI Categorization Controllers)
</output>
