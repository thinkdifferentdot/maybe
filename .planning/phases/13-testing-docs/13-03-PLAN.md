---
phase: 13-testing-docs
plan: 03
type: execute
domain: rails
---

<objective>
Test settings integration and confidence feature to ensure AI trigger toggles control behavior and confidence display works correctly.

Purpose: Verify that the three settings toggles (ai_categorize_on_import, ai_categorize_on_sync, ai_categorize_on_ui_action) actually control their respective trigger behaviors, and that confidence badge color coding is correct.
Output: Integration tests for settings-controlled triggers and confidence display verification.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-testing-docs/13-CONTEXT.md

# Prior context from phases 10-12:
@.planning/phases/10-settings-config/10-01-SUMMARY.md
@.planning/phases/11-import-triggers/11-02-SUMMARY.md
@.planning/phases/11-import-triggers/11-03-SUMMARY.md
@.planning/phases/12-transaction-ui-actions/12-02-SUMMARY.md

# Key files to reference:
@app/models/setting.rb
@app/models/transaction_import.rb
@app/models/lunchflow_account/post_processor.rb
@app/models/family/auto_categorizer.rb
@app/views/transactions/_confidence_badge.html.erb

# Existing test patterns:
@test/models/transaction_import_test.rb
@test/models/lunchflow_account/post_processor_test.rb
@test/models/family/auto_categorizer_test.rb

**Tech stack available:** Rails 7.2, Minitest, fixtures, ActiveJob::TestHelper
**Established patterns:** Setting.ai_categorize_on_import toggle, assert_enqueued_jobs for job verification, ProviderTestHelper for mocking
**Constraining decisions:**
- Settings default to false (opt-in) from 10-01
- Confidence colors: green >80%, yellow 60-80%, orange <60% from 12-02
- Import trigger checks setting at import time from 11-02
- Sync trigger checks Setting.ai_categorize_on_sync from 11-03

**Key decisions from prior phases:**
- Phase 10-01: Three settings fields added with default: false
- Phase 11-02: TransactionImport checks ai_categorize_on_import before triggering
- Phase 11-03: PostProcessor checks ai_categorize_on_sync before triggering
- Phase 12-02: Confidence badge color-coded by threshold
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test CSV import AI trigger respects setting</name>
  <files>test/models/transaction_import_test.rb</files>
  <action>Add integration test to verify TransactionImport respects ai_categorize_on_import setting:
1. Setting ON: AutoCategorizeJob enqueued for uncategorized transactions
2. Setting OFF: AutoCategorizeJob NOT enqueued
3. Already categorized: job not enqueued even when setting is ON
4. Per-transaction assertion: only uncategorized transactions enqueued

Use assert_enqueued_jobs(1, only: AutoCategorizeJob) pattern from 11-02. Use ClimateControl.modify if needed for setting override. Create test transactions with EntriesTestHelper.</action>
  <verify>bin/rails test test/models/transaction_import_test.rb -n /ai_categorize_on_import/ passes</verify>
  <done>CSV import AI trigger setting integration verified</done>
</task>

<task type="auto">
  <name>Task 2: Test Lunchflow sync AI trigger respects setting</name>
  <files>test/models/lunchflow_account/post_processor_test.rb</files>
  <action>Add integration test to verify PostProcessor respects ai_categorize_on_sync setting:
1. Setting ON: AutoCategorizeJob enqueued for imported uncategorized transactions
2. Setting OFF: AutoCategorizeJob NOT enqueued
3. Empty transaction list: handles gracefully without error

Follow existing PostProcessor test patterns. Use assert_enqueued_jobs to verify job enqueuing. Test with Setting.ai_categorize_on_sync = true and false.</action>
  <verify>bin/rails test test/models/lunchflow_account/post_processor_test.rb -n /ai_categorize_on_sync/ passes</verify>
  <done>Lunchflow sync AI trigger setting integration verified</done>
</task>

<task type="auto">
  <name>Task 3: Test confidence badge color coding</name>
  <files>test/helpers/transactions_helper_test.rb</files>
  <action>Create or extend test file for confidence badge helper/view:
1. High confidence (>80%): badge has green text/border classes
2. Medium confidence (60-80%): badge has yellow text/border classes
3. Low confidence (<60%): badge has orange text/border classes
4. No confidence: badge not rendered or shows neutral state

Test the _confidence_badge.html.erb partial rendering. Use assert_dom or similar to verify CSS classes present for each confidence range. This verifies the color coding implementation from 12-02.</action>
  <verify>bin/rails test test/helpers/transactions_helper_test.rb passes</verify>
  <done>Confidence badge color coding verified for all ranges</done>
</task>

<task type="auto">
  <name>Task 4: Test setting toggle integration in UI</name>
  <files>test/controllers/settings/auto_categorization_controller_test.rb</files>
  <action>Add integration tests to verify settings actually control behavior:
1. Toggle ai_categorize_on_import ON: Setting persisted correctly
2. Toggle ai_categorize_on_sync ON: Setting persisted correctly
3. Toggle ai_categorize_on_ui_action ON: Setting persisted correctly
4. Toggle OFF: Setting set to false
5. Admin-only access: non-admin users cannot access settings

Extend existing test file from 10-01. Verify Setting model actually updates and persists values.</action>
  <verify>bin/rails test test/controllers/settings/auto_categorization_controller_test.rb passes</verify>
  <done>Settings UI integration verified - toggles persist correctly</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] bin/rails test test/models/transaction_import_test.rb -n /ai_categorize_on_import/ passes
- [ ] bin/rails test test/models/lunchflow_account/post_processor_test.rb -n /ai_categorize_on_sync/ passes
- [ ] bin/rails test test/helpers/transactions_helper_test.rb passes
- [ ] bin/rails test test/controllers/settings/auto_categorization_controller_test.rb passes
- [ ] Confidence badge colors match specifications (green/yellow/orange)
- [ ] Settings toggles control their respective triggers
</verification>

<success_criteria>

- CSV import AI categorization respects ai_categorize_on_import setting
- Lunchflow sync AI categorization respects ai_categorize_on_sync setting
- Confidence badge displays correct color for each confidence range (>80%, 60-80%, <60%)
- Settings UI toggles persist correctly and control behavior
- All integration tests follow existing patterns (assert_enqueued_jobs, ClimateControl, sign_in)
</success_criteria>

<output>
After completion, create `.planning/phases/13-testing-docs/13-03-SUMMARY.md`:

# Phase 13 Plan 3: Settings & Confidence Integration Summary

**Verified settings toggles control AI triggers and confidence display works correctly**

## Accomplishments

- Added integration test for CSV import AI trigger respecting ai_categorize_on_import setting
- Added integration test for Lunchflow sync AI trigger respecting ai_categorize_on_sync setting
- Created confidence badge color coding tests for all ranges (green/yellow/orange)
- Extended settings controller tests for UI toggle integration

## Files Created/Modified

- `test/models/transaction_import_test.rb` - Added setting integration test
- `test/models/lunchflow_account/post_processor_test.rb` - Added setting integration test
- `test/helpers/transactions_helper_test.rb` - New or extended for confidence badge
- `test/controllers/settings/auto_categorization_controller_test.rb` - Extended integration tests

## Test Coverage Added

- CSV import: AI categorization only enqueued when ai_categorize_on_import is ON
- Lunchflow sync: AI categorization only enqueued when ai_categorize_on_sync is ON
- Confidence badge: >80% green, 60-80% yellow, <60% orange
- Settings UI: toggles persist and control behavior correctly

## Decisions Made

None - verifying behavior from 10-01, 11-02, 11-03, 12-02

## Issues Encountered

[Document any issues found during testing]

## Next Step

Ready for 13-04-PLAN.md (Full AI Regression)
</output>
