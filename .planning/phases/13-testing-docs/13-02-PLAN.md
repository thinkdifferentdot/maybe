---
phase: 13-testing-docs
plan: 02
type: execute
domain: rails
---

<objective>
Test the AI categorization controllers (individual and bulk) to ensure UI-triggered AI categorization works correctly.

Purpose: Verify the controller actions that handle individual and bulk AI categorization from the transaction UI work correctly with proper error handling, authorization, and Turbo Stream responses.
Output: Comprehensive test coverage for AiCategorizationsController and BulkAiCategorizationsController.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-testing-docs/13-CONTEXT.md

# Prior context from phases 10-12:
@.planning/phases/12-transaction-ui-actions/12-01-SUMMARY.md
@.planning/phases/12-transaction-ui-actions/12-02-SUMMARY.md
@.planning/phases/12-transaction-ui-actions/12-03-SUMMARY.md

# Key files to reference:
@app/controllers/transactions/ai_categorizations_controller.rb
@app/controllers/transactions/bulk_ai_categorizations_controller.rb
@app/models/family/auto_categorizer.rb
@app/javascript/controllers/ai_categorize_controller.js
@app/javascript/controllers/bulk_ai_categorize_controller.js

# Existing test patterns:
@test/controllers/transactions_controller_test.rb
@test/controllers/settings/auto_categorization_controller_test.rb

**Tech stack available:** Rails 7.2, Minitest, Turbo Stream, ActiveJob::TestHelper
**Established patterns:** sign_in @user for authentication, assert_enqueued_jobs, mock provider responses, assert_dom for DOM assertions
**Constraining decisions:**
- Individual AI button always visible (from 12-02)
- 60% confidence threshold for confirmation (from 12-03)
- Errors per transaction continue batch process (from 12-03)

**Key decisions from prior phases:**
- Phase 12-02: AiCategorizationsController returns Turbo Stream responses
- Phase 12-03: BulkAiCategorizationsController filters to uncategorized, enrichable only
- Phase 12-01: Provider selection uses family's configured LLM provider
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AiCategorizationsController test file</name>
  <files>test/controllers/transactions/ai_categorizations_controller_test.rb</files>
  <action>Create comprehensive test file for individual AI categorization:
1. Authentication: redirect when not signed in
2. Authorization: only user's own transactions
3. Success: uncategorized transaction gets categorized, Turbo Stream response
4. Already categorized: re-categorization works (button always visible per 12-02)
5. Provider selection: uses family's configured provider (openai/anthropic)
6. Confidence: stored in transaction.extra after categorization
7. Error handling: AI API errors return user-friendly Turbo Stream error message
8. Non-enrichable: handles non-enrichable transactions gracefully

Mock the Family::AutoCategorizer using mocha expects pattern. Use sign_in @user for authentication. Follow existing transactions_controller_test.rb patterns.</action>
  <verify>bin/rails test test/controllers/transactions/ai_categorizations_controller_test.rb passes</verify>
  <done>All individual AI categorization scenarios covered by tests</done>
</task>

<task type="auto">
  <name>Task 2: Create BulkAiCategorizationsController test file</name>
  <files>test/controllers/transactions/bulk_ai_categorizations_controller_test.rb</files>
  <action>Create comprehensive test file for bulk AI categorization:
1. Authentication: redirect when not signed in
2. Authorization: only user's own transactions
3. Success: multiple uncategorized transactions get categorized
4. Filtering: only uncategorized, enrichable transactions processed
5. Mixed results: some succeed, some skipped (already categorized)
6. Per-transaction errors: errors don't stop batch process (from 12-03)
7. Turbo Stream: returns inline updates for each transaction
8. Summary modal: appended to body with result counts
9. Empty selection: handles empty transaction_ids array gracefully

Mock Family::AutoCategorizer to return mix of success/error results. Use EntriesTestHelper to create multiple test transactions. Follow assert_enqueued_jobs pattern from existing controller tests.</action>
  <verify>bin/rails test test/controllers/transactions/bulk_ai_categorizations_controller_test.rb passes</verify>
  <done>All bulk AI categorization scenarios covered by tests</done>
</task>

<task type="auto">
  <name>Task 3: Add Stimulus controller integration verification</name>
  <files>test/system/transactions_ai_categorize_system_test.rb</files>
  <action>Create system test to verify the full AI categorization flow including JavaScript:
1. Individual: clicking AI categorize button shows loading state, then updates category
2. Bulk: selecting transactions and clicking bulk AI button shows summary modal
3. Confidence badge: displays correct color based on confidence score (>80% green, 60-80% yellow, <60% orange)
4. Error handling: API errors show flash notification

Note: System tests use sparingly per CLAUDE.md - this is the critical user-facing flow so justifies system test. Use Capybara selectors matching the stimulus controller data attributes.</action>
  <verify>bin/rails test test/system/transactions_ai_categorize_system_test.rb passes</verify>
  <done>Full AI categorization user flow verified by system test</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All new test files run without errors
- [ ] bin/rails test test/controllers/transactions/ai_categorizations_controller_test.rb passes
- [ ] bin/rails test test/controllers/transactions/bulk_ai_categorizations_controller_test.rb passes
- [ ] bin/rails test:system test/system/transactions_ai_categorize_system_test.rb passes
- [ ] No regressions in existing controller tests
- [ ] Mocked provider responses follow ProviderTestHelper pattern
</verification>

<success_criteria>

- AiCategorizationsController has full coverage of authentication, authorization, success, and error scenarios
- BulkAiCategorizationsController has full coverage including filtering, mixed results, and per-transaction error handling
- System test verifies the complete user flow including JavaScript behavior
- Confidence badge color coding is verified
- All tests follow existing patterns (sign_in, mocha mocks, Turbo Stream assertions)
</success_criteria>

<output>
After completion, create `.planning/phases/13-testing-docs/13-02-SUMMARY.md`:

# Phase 13 Plan 2: AI Categorization Controllers Summary

**Added comprehensive test coverage for individual and bulk AI categorization controllers**

## Accomplishments

- Created test/controllers/transactions/ai_categorizations_controller_test.rb with full coverage
- Created test/controllers/transactions/bulk_ai_categorizations_controller_test.rb with full coverage
- Created system test for JavaScript/UX verification
- All controller scenarios covered: auth, success, errors, Turbo Stream responses

## Files Created/Modified

- `test/controllers/transactions/ai_categorizations_controller_test.rb` - New test file
- `test/controllers/transactions/bulk_ai_categorizations_controller_test.rb` - New test file
- `test/system/transactions_ai_categorize_system_test.rb` - New system test file

## Test Coverage Added

- AiCategorizationsController: auth, authorization, categorization, re-categorization, provider selection, confidence, errors
- BulkAiCategorizationsController: auth, filtering, mixed results, per-transaction errors, Turbo Stream, summary modal
- System test: loading states, confidence badge colors, error notifications

## Decisions Made

None - following patterns established in 12-02 and 12-03

## Issues Encountered

[Document any issues found during testing]

## Next Step

Ready for 13-03-PLAN.md (Settings & Confidence Integration)
</output>
