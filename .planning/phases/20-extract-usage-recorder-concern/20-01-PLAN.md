---
phase: 20-extract-usage-recorder-concern
plan: 01
type: execute
---

<objective>
Extract duplicated usage recording code into a shared Provider::Concerns::UsageRecorder module that both OpenAI and Anthropic providers can use.

Purpose: DRY up code — AutoCategorizer and AutoMerchantDetector in Anthropic have identical `record_usage` methods that duplicate the pattern from OpenAI's concern. Centralizing this improves maintainability and ensures consistent behavior across providers.

Output: A shared `Provider::Concerns::UsageRecorder` module, both Anthropic classes refactored to use it, OpenAI concern aliased to the shared module for backward compatibility, all tests passing.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-extract-usage-recorder-concern/20-RESEARCH.md
@.planning/phases/20-extract-usage-recorder-concern/20-CONTEXT.md
@app/models/provider/openai/concerns/usage_recorder.rb
@app/models/provider/anthropic/auto_categorizer.rb
@app/models/provider/anthropic/auto_merchant_detector.rb
@app/models/provider/anthropic.rb
@test/models/provider/anthropic_test.rb
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared Provider::Concerns::UsageRecorder module</name>
  <files>app/models/provider/concerns/usage_recorder.rb</files>
  <action>Create app/models/provider/concerns directory and usage_recorder.rb module with:

1. `record_usage(model_name, usage_data, operation:, metadata:)` method that:
   - Returns early unless family && usage_data
   - Detects format via `extract_tokens` helper
   - Handles both Hash (OpenAI) with string keys AND Anthropic::Models::Usage BaseModel with input_tokens/output_tokens attributes
   - Calls LlmUsage.calculate_cost and creates LlmUsage record
   - Logs success/error with appropriate messages
   - Uses rescue for error handling

2. `extract_tokens(usage_data)` helper that:
   - Returns [input_tokens, output_tokens] if usage_data responds to :input_tokens (Anthropic BaseModel)
   - Returns [prompt_tokens, completion_tokens] from hash keys otherwise (OpenAI format)
   - Handles both old (prompt/completion) and new (input/output) key names for hash format

3. `record_usage_error(model_name, operation:, error:, metadata:)` method from OpenAI concern for error case handling

4. `extract_http_status_code(error)` helper from OpenAI concern for HTTP status extraction

Use the OpenAI concern as the reference implementation — it's battle-tested. Only change is the format detection logic in extract_tokens.</action>
  <verify>File exists at app/models/provider/concerns/usage_recorder.rb with all 4 methods defined, module is named Provider::Concerns::UsageRecorder</verify>
  <done>Shared concern module created with format-detecting extract_tokens, record_usage, record_usage_error, and extract_http_status_code methods</done>
</task>

<task type="auto">
  <name>Task 2: Refactor Anthropic::AutoCategorizer to use shared concern</name>
  <files>app/models/provider/anthropic/auto_categorizer.rb</files>
  <action>1. Add `include Provider::Concerns::UsageRecorder` at the top of the class after attr_reader line

2. Delete the entire `record_usage` method (lines 397-429 in current file) — it's now provided by the concern

3. The existing call to `record_usage(model, response.usage, operation: "auto_categorize", metadata: {...})` will automatically use the included concern's method

Do NOT modify any other parts of the class — only the include statement and deleting the duplicate method.</action>
  <verify>grep -q "include Provider::Concerns::UsageRecorder" app/models/provider/anthropic/auto_categorizer.rb returns true, and the old record_usage method is removed (no duplicate definition)</verify>
  <done>AutoCategorizer includes shared concern, duplicate record_usage method removed</done>
</task>

<task type="auto">
  <name>Task 3: Refactor Anthropic::AutoMerchantDetector to use shared concern</name>
  <files>app/models/provider/anthropic/auto_merchant_detector.rb</files>
  <action>1. Add `include Provider::Concerns::UsageRecorder` at the top of the class after attr_reader line

2. Delete the entire `record_usage` method (lines 330-362 in current file) — it's now provided by the concern

3. Also delete the duplicate `parse_json_flexibly` and `strip_thinking_tags` methods from this file (they exist in AutoCategorizer and should be extracted to avoid duplication, but that's separate — for this phase just remove them from AutoMerchantDetector since they're not used in the extraction flow, the class calls `parse_json_flexibly` in `extract_merchants` so we need to keep them... actually wait, let me check — yes, AutoMerchantDetector#extract_merchants calls parse_json_flexibly, so we MUST keep those methods in AutoMerchantDetector for now. Only remove record_usage.)

Do NOT modify any other parts of the class.</action>
  <verify>grep -q "include Provider::Concerns::UsageRecorder" app/models/provider/anthropic/auto_merchant_detector.rb returns true, and the old record_usage method is removed</verify>
  <done>AutoMerchantDetector includes shared concern, duplicate record_usage method removed</done>
</task>

<task type="auto">
  <name>Task 4: Alias OpenAI concern to shared concern for backward compatibility</name>
  <files>app/models/provider/openai/concerns/usage_recorder.rb</files>
  <action>Modify app/models/provider/openai/concerns/usage_recorder.rb to be an alias that includes the shared concern:

Replace the entire content with:
```ruby
# Backward compatibility alias - OpenAI classes include this specific path
# The actual implementation is now in Provider::Concerns::UsageRecorder
module Provider::Openai::Concerns::UsageRecorder
  include Provider::Concerns::UsageRecorder
end
```

This preserves backward compatibility — existing `include Provider::Openai::Concerns::UsageRecorder` statements in OpenAI::AutoCategorizer and AutoMerchantDetector continue to work without modification.</action>
  <verify>File contains only the alias module that includes Provider::Concerns::UsageRecorder, no duplicate methods</verify>
  <done>OpenAI concern now aliases to shared concern, backward compatibility preserved</done>
</task>

<task type="auto">
  <name>Task 5: Run tests and verify no regressions</name>
  <files>test/models/provider/anthropic_test.rb, test/models/provider/openai_test.rb</files>
  <action>Run the full test suite to verify refactoring didn't break anything:

1. Run Anthropic tests: bin/rails test test/models/provider/anthropic_test.rb
2. Run OpenAI tests: bin/rails test test/models/provider/openai_test.rb
3. Run full provider tests: bin/rails test test/models/provider/

If any tests fail, investigate — likely issues would be:
- Format detection not working for one provider
- Missing method that wasn't accounted for
- Namespace issue with the concern include

All tests should pass since we're only moving code around, not changing behavior.</action>
  <verify>All tests pass (anthropic_test.rb, openai_test.rb, and any usage-related tests)</verify>
  <done>All Anthropic and OpenAI tests passing, no regressions introduced</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `bin/rails test test/models/provider/anthropic_test.rb` passes
- [ ] `bin/rails test test/models/provider/openai_test.rb` passes
- [ ] Shared concern exists at app/models/provider/concerns/usage_recorder.rb
- [ ] Both Anthropic classes include the shared concern
- [ ] Duplicate record_usage methods removed from both classes
- [ ] OpenAI concern aliased to shared concern (backward compatibility)
</verification>

<success_criteria>

- Shared Provider::Concerns::UsageRecorder module created
- Both Anthropic classes refactored to use shared concern (no duplicate code)
- OpenAI concern aliased for backward compatibility
- All existing tests pass (no behavior changes)
- Code is more DRY and maintainable
</success_criteria>

<output>
After completion, create `.planning/phases/20-extract-usage-recorder-concern/20-01-SUMMARY.md`:

# Phase 20 Plan 1: Extract UsageRecorder Concern Summary

**Extracted duplicated usage recording code into a shared concern module, eliminating ~66 lines of duplicate code across Anthropic provider classes.**

## Accomplishments

- Created `Provider::Concerns::UsageRecorder` shared module with format-detecting `extract_tokens` helper
- Refactored `Provider::Anthropic::AutoCategorizer` to include and use shared concern
- Refactored `Provider::Anthropic::AutoMerchantDetector` to include and use shared concern
- Converted existing `Provider::Openai::Concerns::UsageRecorder` to backward-compatible alias
- All tests passing — no behavior changes, only code organization improvement

## Files Created/Modified

- `app/models/provider/concerns/usage_recorder.rb` - NEW: Shared concern with record_usage, extract_tokens, record_usage_error, extract_http_status_code
- `app/models/provider/anthropic/auto_categorizer.rb` - MODIFIED: Added include, removed duplicate record_usage method
- `app/models/provider/anthropic/auto_merchant_detector.rb` - MODIFIED: Added include, removed duplicate record_usage method
- `app/models/provider/openai/concerns/usage_recorder.rb` - MODIFIED: Converted to alias for backward compatibility

## Decisions Made

- Used top-level `Provider::Concerns` namespace instead of provider-specific to enable sharing
- Format detection via `respond_to?(:input_tokens)` handles both Anthropic BaseModel and OpenAI Hash formats
- Preserved OpenAI concern as alias to avoid breaking existing includes

## Issues Encountered

None — straightforward refactoring following existing patterns.

## Next Step

✅ **v1.2 Milestone COMPLETE!**

Phase 20 complete — Anthropic Feature Parity achieved. All 5 phases of v1.2 are now finished:
- Phase 16: Real Streaming Support ✅
- Phase 17: Auto-Categorization Test Coverage ✅
- Phase 18: Fuzzy Category & Merchant Matching ✅
- Phase 19: Flexible JSON Parsing ✅
- Phase 20: Extract UsageRecorder Concern ✅
</output>
