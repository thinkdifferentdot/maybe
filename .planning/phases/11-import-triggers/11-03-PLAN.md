---
phase: 11-import-triggers
plan: 03
type: execute
domain: rails
---

<objective>
Add AI categorization trigger to Lunchflow sync jobs, controlled by the ai_categorize_on_sync setting.

Purpose: Automatically categorize Lunch Money synced transactions using AI when the user has opted in.
Output: Lunchflow sync that triggers batch AI categorization for uncategorized transactions after sync completes.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-import-triggers/11-CONTEXT.md
@.planning/phases/11-import-triggers/11-RESEARCH.md

# Relevant prior phases (from dependency graph):
@.planning/phases/10-settings-config/10-01-PLAN.md
@.planning/phases/11-import-triggers/11-01-SUMMARY.md
@.planning/phases/11-import-triggers/11-02-SUMMARY.md

# Key files from prior work:
@app/models/setting.rb
@app/models/lunchflow_account.rb
@app/models/lunchflow_account/processor.rb
@app/models/lunchflow_account/transactions/processor.rb
@app/models/family.rb
@app/jobs/auto_categorize_job.rb

**Tech stack available:**
- Existing Lunchflow sync flow (LunchflowAccount::Processor)
- AutoCategorizeJob for async processing
- Setting.ai_categorize_on_sync boolean (from Phase 10)
- family.auto_categorize_transactions_later method

**Established patterns (from prior phases):**
- LunchflowAccount::Processor processes transactions via LunchflowAccount::Transactions::Processor
- Use async jobs (perform_later) to avoid blocking sync
- enrichable(:category_id) scope respects user locks
- learned patterns applied before AI (from 11-01)

**Constraining decisions (from prior phases):**
- Phase 10: ai_categorize_on_sync default is false (opt-in)
- Phase 11-01: Learned patterns checked before AI
- Research: Create PostProcessor for batch categorization after sync

**Issues being addressed:** None

**Research findings applied:**
- Create LunchflowAccount::PostProcessor for batch categorization
- Hook into LunchflowAccount::Processor#process after process_transactions
- Collect all transaction IDs from sync and trigger single batch job
- Use Setting.ai_categorize_on_sync to check if enabled
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LunchflowAccount::PostProcessor for batch AI categorization</name>
  <files>app/models/lunchflow_account/post_processor.rb</files>
  <action>
    Create app/models/lunchflow_account/post_processor.rb:

    class LunchflowAccount::PostProcessor
      attr_reader :lunchflow_account

      def initialize(lunchflow_account)
        @lunchflow_account = lunchflow_account
      end

      def process(transaction_ids)
        return unless ai_categorize_enabled?
        return unless lunchflow_account.current_account.present?

        account = lunchflow_account.current_account
        family = account.family

        # Find uncategorized transactions from this sync
        uncategorized_transactions = family.transactions
          .where(id: transaction_ids, category_id: nil)
          .enrichable(:category_id)

        uncategorized_ids = uncategorized_transactions.pluck(:id)

        return unless uncategorized_ids.any?

        Rails.logger.info("LunchflowAccount::PostProcessor - Triggering AI categorization for #{uncategorized_ids.count} transactions")

        family.auto_categorize_transactions_later(
          Transaction.where(id: uncategorized_ids)
        )
      end

      private

      def ai_categorize_enabled?
        Setting.ai_categorize_on_sync == true
      end
    end

    Follow the existing processor pattern - attr_reader, initialize with account.
    DO NOT run AI synchronously - always use auto_categorize_transactions_later.
  </action>
  <verify>
    bin/rails runner "account = LunchflowAccount.first; pp = LunchflowAccount::PostProcessor.new(account); puts pp.class.name" outputs "LunchflowAccount::PostProcessor"
  </verify>
  <done>
    PostProcessor class exists with process method
    process method checks ai_categorize_on_sync setting
    Triggers async AI categorization for uncategorized transactions
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tracking of imported transaction IDs in transactions processor</name>
  <files>app/models/lunchflow_account/transactions/processor.rb</files>
  <action>
    Modify app/models/lunchflow_account/transactions/processor.rb:

    1. Add instance variable at top of initialize method:
       @imported_transaction_ids = []

    2. In the processing loop (inside the begin block where result is assigned), when result is NOT nil:
       Add the imported transaction ID to the tracker:
       @imported_transaction_ids << result.transaction.id

    3. Add attr_reader :imported_transaction_ids after attr_reader :lunchflow_account (line 2)

    This allows the PostProcessor to know which transactions were imported for AI categorization.
    The IDs are tracked in memory (no DB changes needed).
  </action>
  <verify>
    bin/rails runner "processor = LunchflowAccount::Transactions::Processor.new(LunchflowAccount.new); puts processor.respond_to?(:imported_transaction_ids)" outputs "true"
  </verify>
  <done>
    processor.imported_transaction_ids returns array of imported transaction IDs
    IDs are populated during processing loop
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate PostProcessor into LunchflowAccount::Processor</name>
  <files>app/models/lunchflow_account/processor.rb</files>
  <action>
    Modify app/models/lunchflow_account/processor.rb:

    In the process method, after process_transactions call (line 27):

    Add:

    # Trigger AI categorization for imported transactions if enabled
    transactions_processor = LunchflowAccount::Transactions::Processor.new(lunchflow_account)
    transactions_result = transactions_processor.process

    # Then after that, add:
    if transactions_result[:imported].positive?
      LunchflowAccount::PostProcessor.new(lunchflow_account).process(
        transactions_processor.imported_transaction_ids
      )
    end

    This requires refactoring - the current code calls process_transactions which creates its own processor.
    Refactor to:

    transactions_processor = LunchflowAccount::Transactions::Processor.new(lunchflow_account)
    transactions_result = transactions_processor.process

    # Trigger AI categorization for imported transactions if enabled
    if transactions_result[:imported].positive? && transactions_processor.imported_transaction_ids.any?
      LunchflowAccount::PostProcessor.new(lunchflow_account).process(
        transactions_processor.imported_transaction_ids
      )
    end

    The process method currently calls LunchflowAccount::Transactions::Processor.new internally - this needs to be extracted to a variable so we can access imported_transaction_ids.
  </action>
  <verify>
    bin/rails test test/models/lunchflow_account/processor_test.rb (create if needed) passes
    Sync with imported transactions triggers AI categorization when enabled
    Sync with no imported transactions does not trigger AI
  </verify>
  <done>
    LunchflowAccount::Processor triggers PostProcessor after transactions imported
    PostProcessor receives array of imported transaction IDs
    AI categorization runs when ai_categorize_on_sync=true
  </done>
</task>

<task type="auto">
  <name>Task 4: Add test coverage for Lunchflow AI categorization</name>
  <files>test/models/lunchflow_account/post_processor_test.rb</files>
  <action>
    Create test/models/lunchflow_account/post_processor_test.rb:

    require "test_helper"

    class LunchflowAccount::PostProcessorTest < ActiveSupport::TestCase
      setup do
        @family = families(:default)
        @account = @family.accounts.create!(accountable: CreditCard.new, balance: 0, currency: "USD")
        @lunchflow_account = LunchflowAccount.create!(
          lunchflow_item: lunchflow_items(:default),
          account_id: "test-account",
          name: "Test Account",
          currency: "USD"
        )
        @lunchflow_account.update!(current_account: @account)
      end

      test "triggers AI categorization when ai_categorize_on_sync is enabled" do
        Setting.ai_categorize_on_sync = true

        transaction = @account.transactions.create!(
          entry: Entry.new(account: @account, date: Date.current, amount: -10, name: "Test"),
          category_id: nil
        )

        assert_difference "AutoCategorizeJob.jobs.count", 1 do
          LunchflowAccount::PostProcessor.new(@lunchflow_account).process([transaction.id])
        end
      end

      test "does not trigger AI categorization when ai_categorize_on_sync is disabled" do
        Setting.ai_categorize_on_sync = false

        transaction = @account.transactions.create!(
          entry: Entry.new(account: @account, date: Date.current, amount: -10, name: "Test"),
          category_id: nil
        )

        assert_no_difference "AutoCategorizeJob.jobs.count" do
          LunchflowAccount::PostProcessor.new(@lunchflow_account).process([transaction.id])
        end
      end

      test "does not categorize transactions that already have categories" do
        Setting.ai_categorize_on_sync = true

        category = @family.categories.first
        transaction = @account.transactions.create!(
          entry: Entry.new(account: @account, date: Date.current, amount: -10, name: "Test"),
          category: category
        )

        assert_no_difference "AutoCategorizeJob.jobs.count", 1 do
          LunchflowAccount::PostProcessor.new(@lunchflow_account).process([transaction.id])
        end
      end
    end

    Use existing fixtures pattern (families(:default), etc.).
  </action>
  <verify>
    bin/rails test test/models/lunchflow_account/post_processor_test.rb passes
    All three tests verify correct behavior
  </verify>
  <done>
    Test confirms AI categorization triggered when enabled
    Test confirms no trigger when disabled
    Test confirms categorized transactions are skipped
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] LunchflowAccount::PostProcessor class exists
- [ ] PostProcessor.checks ai_categorize_on_sync setting
- [ ] LunchflowAccount::Processor integrates PostProcessor after transactions
- [ ] Imported transaction IDs are tracked and passed to PostProcessor
- [ ] All tests pass
</verification>

<success_criteria>

- AI categorization triggers after Lunchflow sync when ai_categorize_on_sync=true
- Only uncategorized transactions are sent to AI
- Async job prevents sync blocking
- PostProcessor follows existing processor patterns
  </success_criteria>

<output>
After completion, create `.planning/phases/11-import-triggers/11-03-SUMMARY.md`:

# Phase 11 Plan 3: Lunchflow Sync AI Categorization Summary

**Added AI categorization trigger to Lunchflow sync jobs**

## Accomplishments

- Created LunchflowAccount::PostProcessor for batch AI categorization
- Modified LunchflowAccount::Transactions::Processor to track imported IDs
- Integrated PostProcessor into LunchflowAccount::Processor flow
- Added test coverage for PostProcessor behavior

## Files Created/Modified

- `app/models/lunchflow_account/post_processor.rb` - New post-processor
- `app/models/lunchflow_account/transactions/processor.rb` - Track imported IDs
- `app/models/lunchflow_account/processor.rb` - Integrate PostProcessor
- `test/models/lunchflow_account/post_processor_test.rb` - New test file

## Decisions Made

- Use PostProcessor pattern (batch after sync, not per-transaction)
- Track IDs in memory during processing (no DB changes)
- Async job to avoid blocking sync
- Follow existing processor patterns

## Issues Encountered

None

## Next Step

Ready for 11-04-PLAN.md (Bulk Review Workflow)
</output>
