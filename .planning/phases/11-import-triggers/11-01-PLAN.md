---
phase: 11-import-triggers
plan: 01
type: execute
domain: rails
---

<objective>
Create the LearnedPattern model infrastructure for storing and matching approved AI categorizations.

Purpose: Enable the system to "learn" from user-approved AI suggestions and automatically apply those patterns to future transactions, reducing AI costs over time.
Output: A LearnedPattern model with family-scoped merchant-to-category mappings and a fuzzy matching service for pattern discovery.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-import-triggers/11-CONTEXT.md
@.planning/phases/11-import-triggers/11-RESEARCH.md

# Relevant prior phases (from dependency graph):
@.planning/phases/05-settings-model/05-SUMMARY.md
@.planning/phases/08-validation-testing/08-03-SUMMARY.md

# Key files from prior work:
@app/models/setting.rb
@app/models/family/auto_categorizer.rb
@app/models/provider/openai/auto_categorizer.rb
@app/models/transaction.rb
@app/models/concerns/enrichable.rb

**Tech stack available:**
- Rails 8 with existing associations and validations
- PostgreSQL with jsonb support (for locked_attributes pattern)
- Existing fuzzy matching pattern in Provider::Openai::AutoCategorizer

**Established patterns (from prior phases):**
- belongs_to :family for multi-tenant data isolation
- normalized_name pattern for string matching
- scope :enrichable for respecting user locks
- enrich_attribute for tracking data source

**Constraining decisions (from prior phases):**
- Phase 5: Settings are family-scoped, not global
- Phase 8: AI categorization uses enrichable(:category_id) scope
- Context: Learned patterns are family-scoped only (no sharing across users)
- Context: Fuzzy matching uses substring + synonym variations (not new gems)

**Issues being addressed:** None

**Research findings applied:**
- No new gems needed - use existing substring matching from AutoCategorizer
- Store both original merchant_name and normalized_merchant for flexible matching
- Use find_or_create_by to avoid duplicate patterns
- Patterns apply to future uncategorized transactions only
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LearnedPattern model and migration</name>
  <files>db/migrate/20260110XXXXXX_create_learned_patterns.rb, app/models/learned_pattern.rb</files>
  <action>
    Generate migration for learned_patterns table:
    - t.references :family, null: false, foreign_key: true, index: true
    - t.references :category, null: false, foreign_key: true, index: true
    - t.string :merchant_name, null: false
    - t.string :normalized_merchant, null: false
    - t.timestamps

    Add composite index [:family_id, :normalized_merchant] for lookups

    Create app/models/learned_pattern.rb:
    - belongs_to :family
    - belongs_to :category
    - validates :merchant_name, presence: true
    - validates :normalized_merchant, presence: true, uniqueness: { scope: :family_id }
    - before_validation :normalize_merchant_name

    Define normalize_merchant_name method:
    - Downcase merchant_name
    - Remove special characters (keep alphanumeric and spaces)
    - Strip leading/trailing whitespace

    DO NOT add ENV defaults or global scope - patterns are strictly family-scoped.
  </action>
  <verify>
    bin/rails db:migrate:up VERSION=20260110XXXXXX succeeds
    LearnedPattern.new(family:, category:, merchant_name: "Amazon 123").save creates record with normalized_merchant="amazon 123"
  </verify>
  <done>
    Migration runs without errors, learned_patterns table created with all columns and indexes
    Model validates presence of merchant_name and normalizes to normalized_merchant
  </done>
</task>

<task type="auto">
  <name>Task 2: Create LearnedPatternMatcher service</name>
  <files>app/models/learned_pattern_matcher.rb</files>
  <action>
    Create app/models/learned_pattern_matcher.rb as a PORO service (not ActiveRecord):

    class LearnedPatternMatcher
      attr_reader :family

      def initialize(family)
        @family = family
      end

      def find_matching_pattern(transaction)
        return nil if transaction.merchant_name.blank?

        normalized_input = normalize(transaction.merchant_name)

        # Try exact match first
        pattern = family.learned_patterns.find_by(normalized_merchant: normalized_input)
        return pattern if pattern

        # Try substring matching (input contains pattern or pattern contains input)
        family.learned_patterns.find_each do |candidate|
          if substring_match?(normalized_input, candidate.normalized_merchant)
            return candidate
          end
        end

        nil
      end

      private

      def normalize(str)
        str.to_s.downcase.gsub(/[^a-z0-9\s]/, "").squeeze(" ").strip
      end

      def substring_match?(input, pattern)
        input.include?(pattern) || pattern.include?(input)
      end
    end

    Follow the existing fuzzy matching pattern from Provider::Openai::AutoCategorizer.
    DO NOT add external fuzzy matching gems - substring matching is sufficient.
  </action>
  <verify>
    bin/rails runner "family = Family.first; matcher = LearnedPatternMatcher.new(family); puts matcher.class.name" outputs "LearnedPatternMatcher"
  </verify>
  <done>
    LearnedPatternMatcher service exists with normalize and substring_match? methods
    find_matching_pattern returns first matching pattern or nil
  </done>
</task>

<task type="auto">
  <name>Task 3: Add family association and pattern learning methods</name>
  <files>app/models/family.rb</files>
  <action>
    In app/models/family.rb:

    1. Add has_many association after existing has_many lines (around line 32):
       has_many :learned_patterns, dependent: :destroy

    2. Add method to find pattern for transaction (after auto_detect_transaction_merchants line ~70):
       def learned_pattern_for(transaction)
         LearnedPatternMatcher.new(self).find_matching_pattern(transaction)
       end

    3. Add method to create pattern from approved AI categorization:
       def learn_pattern_from!(transaction)
         return unless transaction.merchant_name.present? && transaction.category_id.present?

         learned_patterns.find_or_create_by(
           normalized_merchant: LearnedPatternMatcher.new(self).send(:normalize, transaction.merchant_name)
         ) do |pattern|
           pattern.merchant_name = transaction.merchant_name
           pattern.category = transaction.category
         end
       end

    DO NOT add any global/classify pattern sharing - patterns remain family-scoped only.
  </action>
  <verify>
    bin/rails runner "family = Family.first; family.learned_patterns; puts family.learned_patterns.class.name" outputs "Family::ActiveRecord_Associations_CollectionProxy"
    bin/rails runner "family = Family.first; puts family.respond_to?(:learned_pattern_for?)" outputs "true"
  </verify>
  <done>
    has_many :learned_patterns association exists on Family
    learned_pattern_for method returns matching LearnedPattern or nil
    learn_pattern_from! creates pattern using find_or_create_by
  </done>
</task>

<task type="auto">
  <name>Task 4: Update AutoCategorizer to check learned patterns first</name>
  <files>app/models/family/auto_categorizer.rb</files>
  <action>
    Modify app/models/family/auto_categorizer.rb:

    1. In auto_categorize method, before calling llm_provider.auto_categorize, add learned pattern check:

       # First, apply any learned patterns (bypasses AI)
       scope.each do |transaction|
         if (pattern = family.learned_pattern_for(transaction))
           was_modified = transaction.enrich_attribute(
             :category_id,
             pattern.category_id,
             source: "learned_pattern"
           )
           transaction.lock_attr!(:category_id)
           modified_count += 1 if was_modified
         end
       end

       # Reload scope to get remaining uncategorized transactions
       remaining_scope = scope.where(category_id: nil).enrichable(:category_id)

    2. Only call AI categorization on remaining_scope (not full scope):
       Replace references to "scope" with "remaining_scope" in the AI call section

    This ensures learned patterns are applied WITHOUT using AI tokens, reducing costs over time.
  </action>
  <verify>
    bin/rails test test/models/family/auto_categorizer_test.rb (create if needed) passes
    Transaction with matching learned pattern gets categorized without AI call
  </verify>
  <done>
    AutoCategorizer checks learned patterns BEFORE calling AI provider
    Learned patterns are applied with source: "learned_pattern" and locked
    Remaining uncategorized transactions proceed to AI categorization
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Migration runs and creates learned_patterns table with all indexes
- [ ] LearnedPattern model normalizes merchant names correctly
- [ ] LearnedPatternMatcher finds patterns via substring matching
- [ ] Family has_many learned_patterns association
- [ ] family.learned_pattern_for returns pattern or nil
- [ ] family.learn_pattern_from! creates pattern from transaction
- [ ] AutoCategorizer applies learned patterns before AI call
</verification>

<success_criteria>

- LearnedPattern model exists with family_id, category_id, merchant_name, normalized_merchant
- LearnedPatternMatcher service performs substring-based fuzzy matching
- AutoCategorizer checks learned patterns first (reducing AI usage)
- All learned patterns are family-scoped (no global sharing)
  </success_criteria>

<output>
After completion, create `.planning/phases/11-import-triggers/11-01-SUMMARY.md`:

# Phase 11 Plan 1: LearnedPattern Model Summary

**Created LearnedPattern infrastructure for storing and matching approved AI categorizations**

## Accomplishments

- Created learned_patterns table migration with family/category associations
- Implemented LearnedPattern model with automatic merchant name normalization
- Created LearnedPatternMatcher service for fuzzy substring matching
- Added has_many :learned_patterns to Family model
- Added learned_pattern_for and learn_pattern_from! methods to Family
- Updated AutoCategorizer to check learned patterns before AI calls

## Files Created/Modified

- `db/migrate/20260110XXXXXX_create_learned_patterns.rb` - New migration
- `app/models/learned_pattern.rb` - New model
- `app/models/learned_pattern_matcher.rb` - New service
- `app/models/family.rb` - Added association and pattern methods
- `app/models/family/auto_categorizer.rb` - Added learned pattern check before AI

## Decisions Made

- Family-scoped patterns only (no cross-user learning)
- Substring matching sufficient (no fuzzy_match gem needed)
- Learned patterns applied BEFORE AI calls (cost reduction)
- Patterns use both original and normalized merchant names for flexibility

## Issues Encountered

None

## Next Step

Ready for 11-02-PLAN.md (CSV Import AI Categorization Trigger)
</output>
