---
phase: 11-import-triggers
plan: 02
type: execute
domain: rails
---

<objective>
Add AI categorization trigger to CSV import flow, controlled by the ai_categorize_on_import setting.

Purpose: Automatically categorize imported CSV transactions using AI when the user has opted in, reducing manual categorization work.
Output: CSV import that triggers AI categorization for uncategorized transactions after import completes.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-import-triggers/11-CONTEXT.md
@.planning/phases/11-import-triggers/11-RESEARCH.md

# Relevant prior phases (from dependency graph):
@.planning/phases/10-settings-config/10-01-PLAN.md
@.planning/phases/11-import-triggers/11-01-SUMMARY.md

# Key files from prior work:
@app/models/setting.rb
@app/models/transaction_import.rb
@app/models/import.rb
@app/models/family.rb
@app/jobs/auto_categorize_job.rb
@app/models/family/auto_categorizer.rb

**Tech stack available:**
- Existing ImportJob/Import.publish pattern
- AutoCategorizeJob for async processing
- Setting.ai_categorize_on_import boolean (from Phase 10)
- family.auto_categorize_transactions_later method

**Established patterns (from prior phases):**
- Import.publish calls import! then family.sync_later
- Use async jobs (perform_later) to avoid blocking imports
- enrichable(:category_id) scope respects user locks
- learned patterns applied before AI (from 11-01)

**Constraining decisions (from prior phases):**
- Phase 10: ai_categorize_on_import default is false (opt-in)
- Phase 11-01: Learned patterns checked before AI
- Research: Always use auto_categorize_transactions_later (async)

**Issues being addressed:** None

**Research findings applied:**
- Hook into TransactionImport#import! after transaction creation
- Collect uncategorized transaction IDs and trigger async job
- Use Setting.ai_categorize_on_import to check if enabled
- Only categorize transactions where category_id is nil
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add helper method to check if AI categorization is enabled for import</name>
  <files>app/models/transaction_import.rb</files>
  <action>
    In app/models/transaction_import.rb, add private helper method at end of class (before final "end"):

    def ai_categorize_enabled?
      Setting.ai_categorize_on_import == true
    end

    This is a simple boolean check against the Setting added in Phase 10.
    DO NOT add any additional complexity - the setting is the single source of truth.
  </action>
  <verify>
    bin/rails runner "import = TransactionImport.new; puts import.respond_to?(:ai_categorize_enabled?)" outputs "true"
  </verify>
  <done>
    ai_categorize_enabled? method exists and returns boolean based on Setting
  </done>
</task>

<task type="auto">
  <name>Task 2: Add AI categorization trigger to TransactionImport#import!</name>
  <files>app/models/transaction_import.rb</files>
  <action>
    In app/models/transaction_import.rb, modify the import! method:

    After the bulk import line (line 78: Transaction.import!(new_transactions, recursive: true)):

    Add:

    # Trigger AI categorization for newly imported uncategorized transactions
    if ai_categorize_enabled?
      uncategorized_imported_ids = new_transactions.select { |t| t.category_id.nil? }.map(&:id)

      if uncategorized_imported_ids.any?
        family.auto_categorize_transactions_later(
          Transaction.where(id: uncategorized_imported_ids)
        )
      end
    end

    Important: Keep this OUTSIDE the transaction block - AI runs after DB commit.
    Only select transactions where category_id is nil (user didn't provide category in CSV).
  </action>
  <verify>
    bin/rails test test/models/transaction_import_test.rb (create test) passes
    Import with uncategorized transactions and ai_categorize_on_import=true queues AutoCategorizeJob
    Import with all categorized transactions does NOT queue job
  </verify>
  <done>
    AI categorization triggered after CSV import when enabled
    Only uncategorized transactions are sent to AI
    Job runs asynchronously (doesn't block import)
  </done>
</task>

<task type="auto">
  <name>Task 3: Add test coverage for AI categorization trigger</name>
  <files>test/models/transaction_import_test.rb</files>
  <action>
    Create/add to test/models/transaction_import_test.rb:

    test "triggers AI categorization when ai_categorize_on_import is enabled and transactions are uncategorized" do
      Setting.ai_categorize_on_import = true

      import = @family.imports.create!(
        type: "TransactionImport",
        date_format: "%m-%d-%Y"
      )

      # Add rows without category mapping
      import.rows.create!(row_index: 0, raw_data: { date: "01-15-2024", amount: "-10.00", name: "Coffee Shop" }.to_json)

      # Mock mappings
      Account::ProviderImportAdapter.any_instance.stubs(:find_duplicate_transaction).returns(nil)

      assert_difference "AutoCategorizeJob.jobs.count", 1 do
        import.import!
      end
    end

    test "does not trigger AI categorization when ai_categorize_on_import is disabled" do
      Setting.ai_categorize_on_import = false

      import = @family.imports.create!(
        type: "TransactionImport",
        date_format: "%m-%d-%Y"
      )

      import.rows.create!(row_index: 0, raw_data: { date: "01-15-2024", amount: "-10.00", name: "Coffee Shop" }.to_json)

      Account::ProviderImportAdapter.any_instance.stubs(:find_duplicate_transaction).returns(nil)

      assert_no_difference "AutoCategorizeJob.jobs.count" do
        import.import!
      end
    end

    test "does not trigger AI categorization when all transactions are categorized" do
      Setting.ai_categorize_on_import = true

      import = @family.imports.create!(
        type: "TransactionImport",
        date_format: "%m-%d-%Y"
      )

      # Add row WITH category (categorized via CSV)
      import.rows.create!(row_index: 0, raw_data: { date: "01-15-2024", amount: "-10.00", name: "Coffee Shop", category: "Food" }.to_json)

      # Setup category mapping
      import.mappings.categories.create!(import_key: "Food", mappable: @category)

      Account::ProviderImportAdapter.any_instance.stubs(:find_duplicate_transaction).returns(nil)

      assert_no_difference "AutoCategorizeJob.jobs.count" do
        import.import!
      end
    end

    Use mocha for mocking (existing project pattern).
  </action>
  <verify>
    bin/rails test test/models/transaction_import_test.rb passes
    All three tests pass with correct behavior
  </verify>
  <done>
    Test confirms AI categorization triggered when enabled + uncategorized
    Test confirms no trigger when disabled
    Test confirms no trigger when transactions already categorized
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TransactionImport has ai_categorize_enabled? helper method
- [ ] import! method triggers AutoCategorizeJob when enabled
- [ ] Only uncategorized transactions are sent to AI
- [ ] Job runs asynchronously (doesn't block import)
- [ ] All tests pass
</verification>

<success_criteria>

- AI categorization triggers after CSV import when ai_categorize_on_import=true
- Only uncategorized transactions are categorized (respects CSV-provided categories)
- No trigger when setting is disabled
- Async job prevents import blocking
  </success_criteria>

<output>
After completion, create `.planning/phases/11-import-triggers/11-02-SUMMARY.md`:

# Phase 11 Plan 2: CSV Import AI Categorization Summary

**Added AI categorization trigger to CSV import flow**

## Accomplishments

- Added ai_categorize_enabled? helper to TransactionImport
- Modified TransactionImport#import! to trigger AI categorization for uncategorized transactions
- AI categorization runs asynchronously via AutoCategorizeJob
- Added test coverage for enabled/disabled scenarios

## Files Created/Modified

- `app/models/transaction_import.rb` - Added AI categorization trigger
- `test/models/transaction_import_test.rb` - Added test coverage

## Decisions Made

- Check setting at import time (not queue time)
- Only categorize transactions without user-provided categories
- Async job to avoid blocking import
- Uses existing AutoCategorizeJob pattern

## Issues Encountered

None

## Next Step

Ready for 11-03-PLAN.md (Lunchflow Sync AI Categorization)
</output>
