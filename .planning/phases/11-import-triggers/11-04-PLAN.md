---
phase: 11-import-triggers
plan: 04
type: execute
domain: rails
---

<objective>
Create bulk review workflow for approving/rejecting AI-categorized transactions after import/sync.

Purpose: Allow users to review AI suggestions in bulk, approve desired categorizations (which creates learned patterns), and reject others. This provides transparency and control over AI categorization.
Output: A review screen showing recently AI-categorized transactions with approve/reject actions.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-import-triggers/11-CONTEXT.md
@.planning/phases/11-import-triggers/11-RESEARCH.md

# Relevant prior phases (from dependency graph):
@.planning/phases/10-settings-config/10-01-PLAN.md
@.planning/phases/11-import-triggers/11-01-SUMMARY.md

# Key files from prior work:
@app/models/transaction.rb
@app/models/data_enrichment.rb
@app/models/family.rb
@app/controllers/transactions_controller.rb
@app/views/transactions/index.html.erb

**Tech stack available:**
- Existing transactions index with filtering
- DataEnrichment model tracks source: "ai" or "learned_pattern"
- Hotwire/Turbo for inline actions
- family.learn_pattern_from! method (from 11-01)

**Established patterns (from prior phases):**
- TransactionsController with index/update actions
- Turbo Frame for partial page updates
- i18n for all user-facing strings
- filter scope pattern for scoped queries

**Constraining decisions (from prior phases):**
- Phase 11-01: Learned patterns created when user approves AI suggestion
- Context: Review workflow happens after import/sync completes
- Context: Follow existing Sure UI patterns (no special requirements)

**Issues being addressed:** None

**Research findings applied:**
- Use DataEnrichment source="ai" to find AI-categorized transactions
- Add :recent_ai scope to Transaction model for filtering
- Approve action creates learned pattern + keeps category
- Reject action removes category + removes enrichment record
- Use Turbo Stream for approve/reject actions (no page reload)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add :recent_ai scope to Transaction model</name>
  <files>app/models/transaction.rb</files>
  <action>
    In app/models/transaction.rb, add scope after existing scopes (around where other scopes are defined):

    scope :recent_ai, ->(family, since: 7.days.ago) {
      joins(:enrichments)
        .where(
          data_enrichments: {
            source: "ai",
            attribute_name: "category_id",
            created_at: since..
          }
        )
        .where(transactions: { family_id: family.id })
        .distinct
    }

    This finds transactions categorized by AI within the specified time window.
    Uses the existing data_enrichments join to identify AI-sourced categorizations.
  </action>
  <verify>
    bin/rails runner "family = Family.first; puts Transaction.recent_ai(family).class.name" outputs "Transaction::ActiveRecord_Relation"
  </verify>
  <done>
    Transaction.recent_ai(family) scope exists
    Returns transactions with AI categorization from data_enrichments
    Accepts optional since: parameter for time window
  </done>
</task>

<task type="auto">
  <name>Task 2: Add approve/reject actions to TransactionsController</name>
  <files>app/controllers/transactions_controller.rb</files>
  <action>
    In app/controllers/transactions_controller.rb, add before_action for approve/reject (before the private section):

    before_action :set_transaction, only: %i[show edit update destroy approve_ai reject_ai]

    Then add approve_ai and reject_ai actions in the public action section (before rescue_from):

    def approve_ai
      @transaction.family.learn_pattern_from!(@transaction)
      @transaction.lock_attr!(:category_id)

      respond_to do |format|
        format.turbo_stream
        format.html { redirect_to transactions_path(filter: "recent_ai") }
      end
    end

    def reject_ai
      # Remove the AI-assigned category
      @transaction.update!(category_id: nil)

      # Remove the enrichment record so it doesn't show as "recent AI" anymore
      @transaction.data_enrichments
        .where(source: "ai", attribute_name: "category_id")
        .destroy_all

      respond_to do |format|
        format.turbo_stream
        format.html { redirect_to transactions_path(filter: "recent_ai") }
      end
    end

    These actions allow users to approve (create learned pattern) or reject (remove category) AI suggestions.
  </action>
  <verify>
    bin/rails routes | grep -E "(approve_ai|reject_ai)" shows both routes
  </verify>
  <done>
    approve_ai action exists and creates learned pattern
    reject_ai action exists and removes category
    Both respond with turbo_stream and html
  </done>
</task>

<task type="auto">
  <name>Task 3: Add routes for approve/reject actions</name>
  <files>config/routes.rb</files>
  <action>
    In config/routes.rb, find the resources :transactions block and add approve_ai and reject_ai routes:

    resources :transactions do
      # ... existing member routes ...
      member do
        post :approve_ai
        post :reject_ai
      end
    end

    If there's already a member block, add these actions to it.
    These are POST actions because they modify state.
  </action>
  <verify>
    bin/rails routes | grep approve_ai shows approve_ai_transaction POST path
    bin/rails routes | grep reject_ai shows reject_ai_transaction POST path
  </verify>
  <done>
    POST /transactions/:id/approve_ai route exists
    POST /transactions/:id/reject_ai route exists
  </done>
</task>

<task type="auto">
  <name>Task 4: Add "Recent AI" filter option to transactions index</name>
  <files>app/controllers/transactions_controller.rb, app/views/transactions/index.html.erb, config/locales/views/transactions/en.yml</files>
  <action>
    In app/controllers/transactions_controller.rb, modify the index action to support filter parameter:

    Add to index action before @transactions assignment:

    @filter = params[:filter]

    case @filter
    when "recent_ai"
      @transactions = @transactions.merge(Transaction.recent_ai(Current.family))
    end

    In app/views/transactions/index.html.erb, add filter option to the filter dropdown (or create if doesn't exist).
    Look for existing filter UI and add "Recent AI" option.

    In config/locales/views/transactions/en.yml, add:
    filters:
      recent_ai: "Recent AI Categorizations"

    This adds a new filter option to show only recently AI-categorized transactions for review.
  </action>
  <verify>
    Visit /transactions?filter=recent_ai shows only AI-categorized transactions
    Filter dropdown includes "Recent AI Categorizations" option
  </verify>
  <done>
    "Recent AI" filter option available in transactions index
    Filter shows only AI-categorized transactions from last 7 days
    Locale key added for filter label
  </done>
</task>

<task type="auto">
  <name>Task 5: Add approve/reject buttons to transaction list item</name>
  <files>app/views/transactions/_transaction.html.erb, config/locales/views/transactions/en.yml</files>
  <action>
    In app/views/transactions/_transaction.html.erb (or partial used in index), add approve/reject buttons when transaction has AI enrichment:

    Wrap in a conditional that checks if this is a recent AI categorization:

    <% if transaction.data_enrichments.where(source: "ai", attribute_name: "category_id").any? %>
      <div class="flex gap-2">
        <%= button_to approve_ai_transaction_path(transaction),
            method: :post,
            form: { data: { turbo_frame: "_top" } },
            class: "text-xs bg-green-100 text-green-700 px-2 py-1 rounded hover:bg-green-200" do %>
          <%= t(".approve_ai") %>
        <% end %>

        <%= button_to reject_ai_transaction_path(transaction),
            method: :post,
            form: { data: { turbo_frame: "_top" } },
            class: "text-xs bg-red-100 text-red-700 px-2 py-1 rounded hover:bg-red-200" do %>
          <%= t(".reject_ai") %>
        <% end %>
      </div>
    <% end %>

    In config/locales/views/transactions/en.yml, add:
    approve_ai: "Approve"
    reject_ai: "Reject"

    Buttons appear only for AI-categorized transactions and use turbo_stream for inline updates.
  </action>
  <verify>
    AI-categorized transactions show Approve/Reject buttons
    Clicking Approve creates learned pattern and buttons disappear
    Clicking Reject removes category and buttons disappear
    </verify>
  <done>
    Approve/Reject buttons render for AI-categorized transactions
    Approve creates learned pattern via family.learn_pattern_from!
    Reject removes category and enrichment record
    Turbo Stream provides inline updates without page reload
  </done>
</task>

<task type="auto">
  <name>Task 6: Add turbo_stream templates for approve/reject</name>
  <files>app/views/transactions/approve_ai.turbo_stream.erb, app/views/transactions/reject_ai.turbo_stream.erb</files>
  <action>
    Create app/views/transactions/approve_ai.turbo_stream.erb:

    <%= turbo_stream.remove @transaction %>
    <%= turbo_stream.append "flash_notice" do %>
      <div class="bg-green-50 text-green-700 px-4 py-2 rounded mb-4">
        <%= t(".approval_success") %>
      </div>
    <% end %>

    Create app/views/transactions/reject_ai.turbo_stream.erb:

    <%= turbo_stream.remove @transaction %>
    <%= turbo_stream.append "flash_notice" do %>
      <div class="bg-gray-50 text-gray-700 px-4 py-2 rounded mb-4">
        <%= t(".rejection_success") %>
      </div>
    <% end %>

    In config/locales/views/transactions/en.yml, add:
    approval_success: "Pattern learned! Future transactions will be auto-categorized."
    rejection_success: "Category removed. This transaction won't be auto-categorized."

    These templates remove the transaction from the list and show a success message.
  </action>
  <verify>
    Clicking Approve removes transaction from list and shows success message
    Clicking Reject removes transaction from list and shows success message
  </verify>
  <done>
    approve_ai.turbo_stream.erb removes transaction and shows approval success
    reject_ai.turbo_stream.erb removes transaction and shows rejection success
    Locale keys added for success messages
  </done>
</task>

<task type="auto">
  <name>Task 7: Add test coverage for approve/reject actions</name>
  <files>test/controllers/transactions_controller_test.rb</files>
  <action>
    Add to test/controllers/transactions_controller_test.rb:

    test "approve_ai creates learned pattern and locks category" do
      sign_in @user

      transaction = @family.transactions.create!(
        entry: Entry.new(account: @account, date: Date.current, amount: -10, name: "Coffee Shop"),
        category: @category
      )

      # Simulate AI categorization
      transaction.data_enrichments.create!(
        source: "ai",
        attribute_name: "category_id",
        attribute_value: @category.id
      )

      assert_difference "@family.learned_patterns.count", 1 do
        post approve_ai_transaction_path(transaction), as: :turbo_stream
      end

      assert transaction.reload.locked_attributes["category_id"].present?
      assert_response :success
    end

    test "reject_ai removes category and enrichment record" do
      sign_in @user

      transaction = @family.transactions.create!(
        entry: Entry.new(account: @account, date: Date.current, amount: -10, name: "Coffee Shop"),
        category: @category
      )

      # Simulate AI categorization
      enrichment = transaction.data_enrichments.create!(
        source: "ai",
        attribute_name: "category_id",
        attribute_value: @category.id
      )

      assert_no_difference "@family.learned_patterns.count" do
        post reject_ai_transaction_path(transaction), as: :turbo_stream
      end

      assert_nil transaction.reload.category_id
      assert_not DataEnrichment.exists?(enrichment.id)
      assert_response :success
    end

    Use existing test patterns (sign_in @user, @family, @account, @category fixtures).
  </action>
  <verify>
    bin/rails test test/controllers/transactions_controller_test.rb passes
    Both new tests pass with correct behavior
  </verify>
  <done>
    Test confirms approve_ai creates learned pattern
    Test confirms reject_ai removes category and enrichment
    Both tests verify response success
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Transaction.recent_ai scope exists and works
- [ ] approve_ai and reject_ai controller actions exist
- [ ] Routes exist for both actions
- [ ] "Recent AI" filter option works in transactions index
- [ ] Approve/Reject buttons appear for AI-categorized transactions
- [ ] Turbo stream templates provide inline updates
- [ ] All tests pass
</verification>

<success_criteria>

- Users can filter to see recently AI-categorized transactions
- Approve action creates learned pattern for future auto-categorization
- Reject action removes category and clears AI enrichment
- Bulk review workflow is functional with inline updates
  </success_criteria>

<output>
After completion, create `.planning/phases/11-import-triggers/11-04-SUMMARY.md`:

# Phase 11 Plan 4: Bulk Review Workflow Summary

**Created bulk review workflow for approving/rejecting AI-categorized transactions**

## Accomplishments

- Added :recent_ai scope to Transaction model for filtering AI-categorized transactions
- Added approve_ai and reject_ai actions to TransactionsController
- Created routes for approve/reject actions
- Added "Recent AI" filter option to transactions index
- Added Approve/Reject buttons to transaction list items
- Created turbo_stream templates for inline updates
- Added test coverage for approve/reject actions

## Files Created/Modified

- `app/models/transaction.rb` - Added recent_ai scope
- `app/controllers/transactions_controller.rb` - Added approve_ai/reject_ai actions
- `config/routes.rb` - Added routes
- `app/views/transactions/index.html.erb` - Added filter option
- `app/views/transactions/_transaction.html.erb` - Added approve/reject buttons
- `app/views/transactions/approve_ai.turbo_stream.erb` - New template
- `app/views/transactions/reject_ai.turbo_stream.erb` - New template
- `config/locales/views/transactions/en.yml` - Added locale keys
- `test/controllers/transactions_controller_test.rb` - Added tests

## Decisions Made

- Use DataEnrichment source="ai" for filtering (not new fields)
- Approve creates learned pattern for future use
- Reject removes category to allow manual re-categorization
- Turbo Stream for inline updates (no page reload)
- 7-day window for "recent" AI categorizations

## Issues Encountered

None

## Phase Complete

Phase 11 (Import Triggers) complete! All 4 plans finished:
- 11-01: LearnedPattern model infrastructure
- 11-02: CSV import AI categorization trigger
- 11-03: Lunchflow sync AI categorization trigger
- 11-04: Bulk review workflow

Ready for Phase 12 (Transaction UI Actions) or Phase 13 (Testing & Docs).
</output>
