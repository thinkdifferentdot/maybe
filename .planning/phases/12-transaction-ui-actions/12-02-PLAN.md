---
phase: 12-transaction-ui-actions
plan: 02
type: execute
domain: hotwire
---

<objective>
Add individual "AI Categorize" button to each transaction row with loading states and inline category updates via Turbo Streams.

Purpose: Users need a quick way to trigger AI categorization for individual transactions directly from the transaction list. The button should show loading state, update the category inline, and display the confidence score.

Output: AI categorize button in transaction rows with Stimulus controller for loading states; Turbo Stream endpoint for individual categorization
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-transaction-ui-actions/12-CONTEXT.md
@.planning/phases/12-transaction-ui-actions/12-RESEARCH.md
@app/models/family/auto_categorizer.rb
@app/controllers/transaction_categories_controller.rb
@app/views/transactions/_transaction.html.erb
@app/views/categories/_menu.html.erb
@app/views/categories/_category_name_mobile.html.erb
@app/javascript/controllers/bulk_select_controller.js
@config/routes.rb
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AI categorize button to transaction row</name>
  <files>app/views/transactions/_transaction.html.erb</files>
  <action>Add an "AI Categorize" button in the transaction row, positioned near the category badge (around line 124 in the desktop category column). The button should:
- Use a controller: "ai-categorize" Stimulus controller
- Have data-transaction-id-value attribute with the transaction ID
- Be styled as a small icon button using the design system (similar to existing action buttons)
- Show a sparkle/magic icon using the icon helper
- Include data-action="click->ai-categorize#categorize"
- Be conditionally shown: only on transactions without a category OR always visible for re-categorization (per CONTEXT.md)

The button HTML should follow this pattern:
```erb
<%= button_to nil,
    data: {
      controller: "ai-categorize",
      ai_categorize_transaction_id_value: transaction.id,
      action: "click->ai-categorize#categorize"
    },
    class: "p-1 hover:bg-gray-100 rounded",
    title: "AI Categorize" do %>
  <%= icon "sparkles", size: "sm" %>
<% end %>
```</action>
  <verify>View file contains AI categorize button with ai-categorize controller and transaction-id value</verify>
  <done>AI categorize button present in transaction row with correct Stimulus controller bindings</done>
</task>

<task type="auto">
  <name>Task 2: Create Transactions::AiCategorizationsController</name>
  <files>app/controllers/transactions/ai_categorizations_controller.rb</files>
  <action>Create a new controller at app/controllers/transactions/ai_categorizations_controller.rb with a create action that:
- Finds the transaction by id (using Current.family.entries.transactions.find)
- Calls Family::AutoCategorizer.new(Current.family, transaction_ids: [transaction.id]).auto_categorize
- Returns a Turbo Stream response that updates:
  1. The category menu (dom_id(transaction, :category_menu))
  2. The mobile category name ("category_name_mobile_#{transaction.id}")
  3. Adds a confidence indicator if available
- Handles AutoCategorizer::Error with flash error

Include include ActionView::RecordIdentifier for dom_id helper. Follow the pattern from TransactionCategoriesController for Turbo Stream responses.</action>
  <verify>Controller file exists with create action; uses AutoCategorizer; returns turbo_stream format with category updates</verify>
  <done>AiCategorizationsController handles individual AI categorization with Turbo Stream response</done>
</task>

<task type="auto">
  <name>Task 3: Add route for AI categorization endpoint</name>
  <files>config/routes.rb</files>
  <action>Add a nested route inside the namespace :transactions block for AI categorization. Add `resource :ai_categorization, only: :create, controller: "transactions/ai_categorizations"` after the existing bulk routes (around line 181). This creates the POST /transactions/ai_categorization endpoint.</action>
  <verify>bin/rails routes | grep ai_categorization shows the route; route is nested under transactions namespace</verify>
  <done>Route exists for POST /transactions/ai_categorization pointing to AiCategorizationsController</done>
</task>

<task type="auto">
  <name>Task 4: Create ai_categorize Stimulus controller</name>
  <files>app/javascript/controllers/ai_categorize_controller.js</files>
  <action>Create a new Stimulus controller that handles the AI categorize button click:
- Extend Controller from @hotwired/stimulus
- Define static targets: button, icon
- Define static values: transactionId (String), url (String - computed endpoint)
- categorize() method that:
  1. Prevents default and sets loading state (disables button, shows spinner icon)
  2. Fetches POST to the categorization endpoint with CSRF token
  3. On success: keeps button disabled briefly (visual feedback), then re-enables
  4. On error: shows error state, re-enables button

Use the fetch API with headers: { "X-CSRF-Token": this.csrfToken, "Accept": "text/vnd.turbo-stream.html" }. Follow existing controller patterns like confirm_dialog_controller.js for structure.</action>
  <verify>Controller file exists with categorize method; handles loading states and fetch to ai_categorization endpoint</verify>
  <done>ai_categorize controller manages button state and sends categorization request</done>
</task>

<task type="auto">
  <name>Task 5: Add confidence display partial</name>
  <files>app/views/transactions/_confidence_badge.html.erb</files>
  <action>Create a partial to display confidence percentage after categorization. The partial should:
- Accept local variable: confidence (float 0-1)
- Display as "XX% confident" with visual styling
- Use color coding: green for >80%, yellow for 60-80%, orange for <60%
- Be shown next to the category badge after AI categorization

Include this in the category menu partial or as a separate element updated via Turbo Stream.</action>
  <verify>Partial exists and displays confidence with appropriate color coding</verify>
  <done>Confidence badge partial shows AI certainty level with visual indicators</done>
</task>

<task type="auto">
  <name>Task 6: Update controller to include confidence in Turbo Stream</name>
  <files>app/controllers/transactions/ai_categorizations_controller.rb</files>
  <action>Modify the Turbo Stream response to include the confidence badge after successful categorization. Retrieve confidence from transaction.extra["ai_categorization_confidence"] and render the confidence badge partial. Append or replace a confidence element in the transaction row.</action>
  <verify>Controller response includes turbo_stream for confidence badge; confidence value from transaction metadata</verify>
  <done>Turbo Stream updates confidence display after AI categorization completes</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `bin/rails test` passes (no regressions)
- [ ] AI categorize button visible in transaction rows
- [ ] Clicking button shows loading state (spinner, disabled)
- [ ] Category updates inline without page reload
- [ ] Confidence percentage displayed after categorization
- [ ] Errors show flash notification
</verification>

<success_criteria>

- Individual AI categorize button works from transaction UI
- Loading state provides clear feedback during API call
- Turbo Stream updates category and confidence inline
- Confidence percentage displayed with color coding
- Error handling shows user-friendly messages
- Re-categorization works on already-categorized transactions
</success_criteria>

<output>
After completion, create `.planning/phases/12-transaction-ui-actions/12-02-SUMMARY.md`:

# Phase 12 Plan 2: Individual AI Categorize Button Summary

**Individual AI categorization now available directly from transaction rows**

## Accomplishments

- Added AI categorize button to each transaction row
- Created AiCategorizationsController with Turbo Stream responses
- Added ai_categorize Stimulus controller for loading states
- Confidence badge displays AI certainty percentage
- Inline category updates without page reload

## Files Created/Modified

- `app/views/transactions/_transaction.html.erb` - Added AI categorize button
- `app/controllers/transactions/ai_categorizations_controller.rb` - New controller
- `app/javascript/controllers/ai_categorize_controller.js` - New Stimulus controller
- `app/views/transactions/_confidence_badge.html.erb` - New confidence display partial
- `config/routes.rb` - Added ai_categorization route

## Decisions Made

- Button always visible (not just for uncategorized) to allow re-categorization
- Confidence stored in extra metadata for display
- Color-coded confidence: green >80%, yellow 60-80%, orange <60%

## Issues Encountered

None

## Next Step

Ready for 12-03-PLAN.md (Bulk AI categorize with cost estimation)
