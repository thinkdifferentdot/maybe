---
phase: 12-transaction-ui-actions
plan: 03
type: execute
domain: hotwire
---

<objective>
Add bulk AI categorization to the selection bar with cost estimation, low-confidence confirmations, and batch processing with inline updates.

Purpose: Users need to categorize multiple transactions at once. The bulk action should show estimated API cost before running, handle low-confidence results with confirmation dialogs, process transactions independently (continue on errors), and show a summary of results.

Output: Bulk AI categorize button in selection bar; cost estimation display; confirmation modal for low-confidence results; batch processing with inline updates
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-transaction-ui-actions/12-CONTEXT.md
@.planning/phases/12-transaction-ui-actions/12-RESEARCH.md
@app/models/family/auto_categorizer.rb
@app/models/llm_usage.rb
@app/views/transactions/_selection_bar.html.erb
@app/javascript/controllers/bulk_select_controller.js
@app/components/DS/dialog.rb
@app/javascript/controllers/confirm_dialog_controller.js
@config/routes.rb
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add bulk AI categorize button to selection bar</name>
  <files>app/views/transactions/_selection_bar.html.erb</files>
  <action>Add a new bulk action button for AI categorization in the selection bar (after the delete button, around line 21). The button should:
- Use a sparkle/magic icon (icon "sparkles")
- Have title "AI Categorize all"
- Use data-bulk-select-scope-param="bulk_ai_categorize" and data-action="bulk-select#submitBulkRequest"
- Include a data-estimated-cost attribute that updates dynamically with selected count
- Follow the existing button pattern in the selection bar

Also add a cost estimation display span that shows "Est: $0.XXXX" and updates via Stimulus when selection changes.</action>
  <verify>Selection bar includes AI categorize button with sparkle icon; cost estimation span present</verify>
  <done>Bulk AI categorize button added to selection bar with dynamic cost display</done>
</task>

<task type="auto">
  <name>Task 2: Add route for bulk AI categorization</name>
  <files>config/routes.rb</files>
  <action>Add `resource :bulk_ai_categorization, only: :create, controller: "transactions/bulk_ai_categorizations"` to the namespace :transactions block (around line 181, after bulk_deletion and bulk_update). This creates the POST /transactions/bulk_ai_categorization endpoint.</action>
  <verify>bin/rails routes | grep bulk_ai_categorization shows the route</verify>
  <done>Route exists for POST /transactions/bulk_ai_categorization</done>
</task>

<task type="auto">
  <name>Task 3: Create BulkAiCategorizationsController</name>
  <files>app/controllers/transactions/bulk_ai_categorizations_controller.rb</files>
  <action>Create a controller that handles bulk AI categorization:
- create action extracts entry_ids from params[:bulk_ai_categorize][:entry_ids]
- Calls Family::AutoCategorizer with all transaction IDs
- Returns JSON response with results including: success_count, error_count, results (array of {transaction_id, category_name, confidence, status})
- Each transaction is wrapped in begin/rescue to continue on errors
- Records LLM usage for the batch operation

The response format should enable frontend to show:
1. Inline updates for successfully categorized transactions
2. Error summary for failed transactions
3. Confirmation modal for low-confidence results</action>
  <verify>Controller exists with create action; processes batch and returns structured results; handles errors per transaction</verify>
  <done>BulkAiCategorizationsController processes batch with per-transaction error handling</done>
</task>

<task type="auto">
  <name>Task 4: Add cost estimation to bulk_select_controller</name>
  <files>app/javascript/controllers/bulk_select_controller.js</files>
  <action>Add cost estimation calculation to the existing bulk_select_controller. Add:
- static values: categoryCount (Number, default: 0), modelName (String, from Setting)
- selectedIdsValueChanged() callback that updates cost estimation
- _updateCostEstimation() private method that calculates cost using a rough formula: (selected_count * 150 tokens + category_count * 50) * model_pricing

Update the cost display span in the selection bar when selection changes. For now, use a simple estimation formula - exact cost calculation will use LlmUsage.estimate_auto_categorize_cost from the backend in a future enhancement.</action>
  <verify>Controller updates cost estimation when selection changes; cost display shows estimated API cost</verify>
  <done>Cost estimation displayed and updates dynamically with selection count</done>
</task>

<task type="auto">
  <name>Task 5: Create bulk AI categorization Stimulus controller</name>
  <files>app/javascript/controllers/bulk_ai_categorize_controller.js</files>
  <action>Create a controller that handles the bulk categorization flow:
- Extends Controller, targets: confirmButton, costDisplay
- categorize() method that submits the bulk request
- On response, updates each transaction row via Turbo Stream
- For low-confidence results (<60%), shows a confirmation dialog using DS::Dialog
- Confirmation dialog lists each low-confidence suggestion with accept/skip options
- After confirmations, submits a second request to apply selected categories
- Shows summary modal with: success count, skipped count, error count

Use the existing confirm_dialog_controller.js pattern for confirmation dialogs.</action>
  <verify>Controller handles bulk categorization response; shows confirmation for low-confidence; displays summary</verify>
  <done>bulk_ai_categorize controller manages the full bulk categorization workflow</done>
</task>

<task type="auto">
  <name>Task 6: Create low-confidence confirmation dialog partial</name>
  <files>app/views/transactions/_low_confidence_confirmation.html.erb</files>
  <action>Create a partial for the low-confidence confirmation modal that:
- Accepts locals: results (array of low-confidence categorizations)
- Uses DS::Dialog component
- Lists each suggestion with: transaction name, suggested category, confidence percentage
- Has checkboxes to select which suggestions to accept
- Has "Apply Selected" and "Skip All" buttons
- Follows the design system modal patterns

Each row should show the transaction details clearly so users can make informed decisions.</action>
  <verify>Partial exists with DS::Dialog; displays low-confidence suggestions with checkboxes; has action buttons</verify>
  <done>Low-confidence confirmation dialog shows suggestions for user review</done>
</task>

<task type="auto">
  <name>Task 7: Create bulk summary partial</name>
  <files>app/views/transactions/_bulk_ai_summary.html.erb</files>
  <action>Create a partial for the bulk categorization summary that:
- Accepts locals: success_count, error_count, skipped_count, total_cost
- Uses DS::Dialog component
- Shows summary stats: "X transactions categorized, Y skipped, Z errors"
- Lists any errors that occurred during processing
- Has a "Close" button
- Auto-dismisses after 5 seconds if user doesn't interact

The summary provides clear feedback on what happened during the bulk operation.</action>
  <verify>Partial exists with DS::Dialog; displays summary stats; lists errors</verify>
  <done>Bulk summary modal shows categorization results and any errors</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `bin/rails test` passes (no regressions)
- [ ] Bulk AI categorize button appears in selection bar when transactions selected
- [ ] Cost estimation updates with selection count
- [ ] Bulk categorization processes all selected transactions
- [ ] Low-confidence results show confirmation dialog
- [ ] High-confidence results apply immediately
- [ ] Summary modal shows results after completion
- [ ] Errors don't stop the batch process
</verification>

<success_criteria>

- Bulk AI categorization works from selection bar
- Cost estimation shown before operation
- Low-confidence (<60%) suggestions require confirmation
- High-confidence suggestions apply immediately
- Errors per transaction don't stop batch processing
- Summary shows success/skip/error counts
- Inline updates via Turbo Stream for each transaction
</success_criteria>

<output>
After completion, create `.planning/phases/12-transaction-ui-actions/12-03-SUMMARY.md`:

# Phase 12 Plan 3: Bulk AI Categorization Summary

**Bulk AI categorization now available with cost estimation and low-confidence confirmations**

## Accomplishments

- Added bulk AI categorize button to selection bar
- Cost estimation displayed dynamically based on selection
- BulkAiCategorizationsController processes batches with per-transaction error handling
- Low-confidence (<60%) results require user confirmation
- High-confidence results apply immediately
- Summary modal shows categorization results
- Errors don't stop the batch process

## Files Created/Modified

- `app/views/transactions/_selection_bar.html.erb` - Added AI categorize button and cost display
- `app/controllers/transactions/bulk_ai_categorizations_controller.rb` - New controller
- `app/javascript/controllers/bulk_ai_categorize_controller.js` - New controller
- `app/javascript/controllers/bulk_select_controller.js` - Added cost estimation
- `app/views/transactions/_low_confidence_confirmation.html.erb` - New confirmation dialog
- `app/views/transactions/_bulk_ai_summary.html.erb` - New summary modal
- `config/routes.rb` - Added bulk_ai_categorization route

## Decisions Made

- 60% confidence threshold for confirmation (from CONTEXT.md)
- Errors per transaction continue batch process
- Cost estimation uses client-side calculation for responsiveness
- Confirmation modal lists each low-confidence suggestion individually

## Issues Encountered

None

## Next Step

Phase 12 complete, ready for Phase 13: Testing & Docs
