---
phase: 12-transaction-ui-actions
plan: 01
type: execute
domain: rails
---

<objective>
Update Family::AutoCategorizer to support dynamic provider selection (OpenAI/Anthropic) and return confidence scores for categorization results.

Purpose: The current AutoCategorizer hardcodes OpenAI as the provider and only returns category names. This plan enables provider selection based on user settings and adds confidence tracking so the UI can display certainty levels and prompt for confirmation on low-confidence results.

Output: Updated AutoCategorizer that uses the configured LLM provider and returns confidence scores; tests passing
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-transaction-ui-actions/12-CONTEXT.md
@.planning/phases/12-transaction-ui-actions/12-RESEARCH.md
@app/models/family/auto_categorizer.rb
@app/models/provider/registry.rb
@app/models/setting.rb
@test/models/family/auto_categorizer_test.rb
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update AutoCategorizer to use dynamic LLM provider</name>
  <files>app/models/family/auto_categorizer.rb</files>
  <action>Modify the `llm_provider` private method to dynamically select the provider based on family settings instead of hardcoding `Provider::Registry.get_provider(:openai)`. Use `Provider::Registry.for_concept(:llm).get_provider(family.llm_provider || "openai")` to get the configured provider. This respects the user's provider selection from settings (set in Phase 5 of v1.0).</action>
  <verify>Read the updated file; llm_provider method should call Provider::Registry.for_concept(:llm).get_provider with family.llm_provider</verify>
  <done>AutoCategorizer uses family's configured LLM provider (openai or anthropic) instead of hardcoded openai</done>
</task>

<task type="auto">
  <name>Task 2: Add AutoCategorization::Result struct with confidence score</name>
  <files>app/models/family/auto_categorizer.rb</files>
  <action>Create a new Result struct within Family::AutoCategorizer or as a separate class to hold categorization results with confidence scores. The struct should have attributes: transaction_id, category_name, confidence (float 0-1). Update the auto_categorize method to return an array of these Result objects instead of just modifying transactions. Note: The Provider#auto_categorize method will need to be updated in a separate plan to return confidence scores - for now, default confidence to 1.0 (100%) for compatibility.</action>
  <verify>Family::AutoCategorizer::Result is defined with transaction_id, category_name, confidence attributes; auto_categorize returns array of Result objects</verify>
  <done>Result struct exists with confidence field; auto_categorize method returns results with confidence data</done>
</task>

<task type="auto">
  <name>Task 3: Store confidence score when applying categorization</name>
  <files>app/models/family/auto_categorizer.rb</files>
  <action>Update the auto_categorize method to store the confidence score in the transaction's extra metadata (extra["ai_categorization_confidence"]) when applying the category. This preserves the confidence information for display in the UI. Use the confidence value from each Result object when calling enrich_attribute.</action>
  <verify>Method stores confidence in transaction.extra["ai_categorization_confidence"]; enriched transactions have confidence metadata</verify>
  <done>Confidence scores are persisted with each AI-categorized transaction for UI display</done>
</task>

<task type="auto">
  <name>Task 4: Update tests for provider selection and confidence</name>
  <files>test/models/family/auto_categorizer_test.rb</files>
  <action>Add tests verifying AutoCategorizer uses the family's configured provider. Add tests for confidence score storage in transaction metadata. Ensure existing tests still pass. Mock Provider::Registry to return different providers and verify the correct provider is used. Test with both "openai" and "anthropic" provider settings.</action>
  <verify>bin/rails test test/models/family/auto_categorizer_test.rb passes with new tests for provider selection and confidence</verify>
  <done>All AutoCategorizer tests pass including new provider selection and confidence tracking tests</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `bin/rails test test/models/family/auto_categorizer_test.rb` passes
- [ ] AutoCategorizer uses family.llm_provider for provider selection
- [ ] Result struct includes confidence attribute
- [ ] Confidence scores stored in transaction.extra metadata
- [ ] No regressions in existing AutoCategorizer functionality
</verification>

<success_criteria>

- AutoCategorizer dynamically selects LLM provider based on family settings
- Confidence scores returned with categorization results
- Confidence metadata persisted on transactions
- Tests verify provider selection works for both openai and anthropic
- Backward compatible - existing functionality still works
</success_criteria>

<output>
After completion, create `.planning/phases/12-transaction-ui-actions/12-01-SUMMARY.md`:

# Phase 12 Plan 1: Backend Provider Selection & Confidence Summary

**AutoCategorizer now supports dynamic provider selection and confidence tracking**

## Accomplishments

- Updated AutoCategorizer to use family's configured LLM provider (openai/anthropic)
- Added AutoCategorization::Result struct with transaction_id, category_name, confidence
- Confidence scores stored in transaction.extra["ai_categorization_confidence"]
- Tests verify provider selection and confidence tracking work correctly

## Files Created/Modified

- `app/models/family/auto_categorizer.rb` - Dynamic provider selection, Result struct, confidence storage
- `test/models/family/auto_categorizer_test.rb` - Tests for provider selection and confidence

## Decisions Made

- Confidence stored in transaction.extra metadata for simplicity (no new table)
- Default confidence of 1.0 for now until providers return actual confidence scores
- Provider selection uses family.llm_provider with "openai" fallback

## Issues Encountered

None

## Next Step

Ready for 12-02-PLAN.md (Individual AI categorize button in UI)
