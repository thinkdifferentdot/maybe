---
phase: 19-flexible-json-parsing
type: execute
---

<objective>
Port `parse_json_flexibly` and `strip_thinking_tags` methods from OpenAI provider to Anthropic provider for resilient JSON parsing from LLM responses.

Purpose: LLMs often return messy JSON - wrapped in markdown code blocks, enclosed in `<thinking>` tags, or with unclosed blocks. Flexible parsing ensures AI features work reliably despite these quirks.

Output: Both `Provider::Anthropic::AutoCategorizer` and `Provider::Anthropic::AutoMerchantDetector` can extract valid JSON from malformed LLM outputs.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-flexible-json-parsing/19-RESEARCH.md
@.planning/phases/19-flexible-json-parsing/19-CONTEXT.md

# Source implementation to port:
@app/models/provider/openai/auto_categorizer.rb
@app/models/provider/openai/auto_merchant_detector.rb

# Target files to modify:
@app/models/provider/anthropic/auto_categorizer.rb
@app/models/provider/anthropic/auto_merchant_detector.rb

**Tech stack available:** Ruby JSON stdlib (built-in), Regexp patterns (built-in)
**Established patterns:** Multi-strategy fallback parsing (direct parse → closed markdown → unclosed markdown → key extraction → last resort)
**Constraining decisions:** Use exact same implementation as OpenAI - no Claude-specific modifications needed per research

**Key methods to port:**
1. `parse_json_flexibly(raw)` - 4-strategy fallback parser
2. `strip_thinking_tags(raw)` - removes `<thinking>` blocks for non-Claude thinking models
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add parse_json_flexibly and strip_thinking_tags to Anthropic::AutoCategorizer</name>
  <files>app/models/provider/anthropic/auto_categorizer.rb</files>
  <action>
Port the exact implementation from OpenAI::AutoCategorizer (lines 374-457):

1. Add `parse_json_flexibly(raw)` private method:
   - Early return `{}` if raw.blank?
   - Call `strip_thinking_tags(raw)` to get cleaned input
   - Try direct `JSON.parse(cleaned)` first (fast path)
   - Rescue JSON::ParserError and try 4 strategies in order:
     * Strategy 1: Closed markdown code blocks ```json...``` (non-greedy, reverse_each)
     * Strategy 2: Unclosed markdown blocks ```json...$ (greedy end-of-string)
     * Strategy 3: Key-specific extraction for "categorizations" key
     * Strategy 4: Last-resort grab of any JSON object
   - Raise `Provider::Anthropic::Error` with truncated message if all strategies fail

2. Add `strip_thinking_tags(raw)` private method:
   - Check if raw contains `<thinking>` tag
   - If `</think>` closing tag exists: extract content after it
   - If no closing tag or no content after: extract content inside `<thinking>` tags
   - Return cleaned string or original if no tags found

3. Update `extract_categorizations(response)` to use flexible parsing:
   - Keep the tool_use block extraction (lines 171-200) unchanged
   - For the text content fallback path (lines 174-191), replace the simple `gsub` markdown stripping with a call to `parse_json_flexibly(text)`
   - Remove the now-redundant markdown stripping gsub calls
   - Keep the existing error handling

IMPORTANT: Port the code verbatim from OpenAI. Only change class name in error messages (Provider::Openai::Error → Provider::Anthropic::Error) and key name ("categorizations" not "merchants").
  </action>
  <verify>
1. `grep -n "parse_json_flexibly" app/models/provider/anthropic/auto_categorizer.rb` confirms method exists
2. `grep -n "strip_thinking_tags" app/models/provider/anthropic/auto_categorizer.rb` confirms method exists
3. `bin/rails test test/models/provider/anthropic/auto_categorizer_test.rb` passes
  </verify>
  <done>
Both methods ported to AutoCategorizer, extract_categorizations uses flexible parsing for text content fallback path, tests pass.
</done>
</task>

<task type="auto">
  <name>Task 2: Add parse_json_flexibly and strip_thinking_tags to Anthropic::AutoMerchantDetector</name>
  <files>app/models/provider/anthropic/auto_merchant_detector.rb</files>
  <action>
Port the exact implementation from OpenAI::AutoMerchantDetector (lines 333-408):

1. Add `parse_json_flexibly(raw)` private method:
   - Same structure as Task 1 BUT use "merchants" key in Strategy 3 (not "categorizations")
   - Pattern: `(\{"merchants"\s*:\s*\[[\s\S]*\]\s*\})` for key-specific extraction
   - All other strategies identical to AutoCategorizer

2. Add `strip_thinking_tags(raw)` private method:
   - Identical implementation to AutoCategorizer (can be duplicated following OpenAI pattern)

3. Update `extract_merchants(response)` to use flexible parsing:
   - Replace current simple text extraction (lines 204-222) with `parse_json_flexibly(content_block.text)`
   - Remove the now-redundant `gsub(/```json\n?/, "").gsub(/```\n?/, "")` calls
   - Keep the existing error handling and result handling

IMPORTANT: The key difference from AutoCategorizer is Strategy 3 uses "merchants" key instead of "categorizations". Everything else is identical.
  </action>
  <verify>
1. `grep -n "parse_json_flexibly" app/models/provider/anthropic/auto_merchant_detector.rb` confirms method exists
2. `grep -n "strip_thinking_tags" app/models/provider/anthropic/auto_merchant_detector.rb` confirms method exists
3. `grep 'merchants"' app/models/provider/anthropic/auto_merchant_detector.rb` confirms Strategy 3 uses correct key
4. `bin/rails test test/models/provider/anthropic/auto_merchant_detector_test.rb` passes
  </verify>
  <done>
Both methods ported to AutoMerchantDetector with correct "merchants" key, extract_merchants uses flexible parsing, tests pass.
</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `bin/rails test test/models/provider/anthropic/auto_categorizer_test.rb` passes
- [ ] `bin/rails test test/models/provider/anthropic/auto_merchant_detector_test.rb` passes
- [ ] No Anthropic regressions: `bin/rails test test/models/provider/anthropic/` passes all tests
- [ ] Code inspection confirms both methods exist in both files
</verification>

<success_criteria>

- Both `parse_json_flexibly` and `strip_thinking_tags` exist in AutoCategorizer
- Both `parse_json_flexibly` and `strip_thinking_tags` exist in AutoMerchantDetector
- AutoCategorizer Strategy 3 uses "categorizations" key
- AutoMerchantDetector Strategy 3 uses "merchants" key
- All Anthropic tests pass
- Phase 19 complete, ready for Phase 20
  </success_criteria>

<output>
After completion, create `.planning/phases/19-flexible-json-parsing/19-01-SUMMARY.md`:

# Phase 19 Plan 1: Flexible JSON Parsing Summary

**Ported resilient JSON parsing methods from OpenAI to Anthropic providers for handling messy LLM outputs.**

## Accomplishments

- Ported `parse_json_flexibly` method with 4-strategy fallback (direct parse → closed markdown → unclosed markdown → key extraction → last resort)
- Ported `strip_thinking_tags` helper for removing `<thinking>` blocks from thinking model outputs
- Updated `extract_categorizations` in AutoCategorizer to use flexible parsing
- Updated `extract_merchants` in AutoMerchantDetector to use flexible parsing
- Verified correct key names ("categorizations" vs "merchants") in Strategy 3 for each class

## Files Created/Modified

- `app/models/provider/anthropic/auto_categorizer.rb` - Added parse_json_flexibly, strip_thinking_tags methods (~80 lines)
- `app/models/provider/anthropic/auto_merchant_detector.rb` - Added parse_json_flexibly, strip_thinking_tags methods (~80 lines)

## Decisions Made

- Ported verbatim from OpenAI implementation rather than creating Claude-specific version (follows research recommendation)
- Duplicated methods in both files rather than extracting to shared module (follows existing OpenAI pattern)
- No test coverage added as OpenAI has no dedicated tests for these methods (they're implementation details)

## Issues Encountered

None

## Next Step

Phase 19 complete, ready for Phase 20: Extract UsageRecorder Concern
</output>
