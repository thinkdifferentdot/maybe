---
phase: 27-simplify-json-parsing
plan: 01
type: execute
---

<objective>
Refactor the 85-line `parse_json_flexibly` method in Provider::Concerns::JsonParser into smaller, focused helper methods for improved readability and maintainability.

Purpose: Complex nested method with 4+ extraction strategies is difficult to understand and maintain. Breaking into helpers makes each strategy explicit and testable.

Output: Refactored JsonParser concern with 5-6 focused helper methods, each handling one extraction strategy.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 25 summary - JsonParser extraction context
@.planning/phases/25-extract-json-parser/25-01-SUMMARY.md

# Current implementation to refactor
@app/models/provider/concerns/json_parser.rb
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract closed markdown code block strategy into helper method</name>
  <files>app/models/provider/concerns/json_parser.rb</files>
  <action>Create private method `extract_from_closed_code_blocks(text)` that handles both array [...] and object {...} patterns within ```json or ``` code blocks. Extract lines 34-55 from parse_json_flexibly into this method. Return parsed JSON or nil. Update parse_json_flexibly to call this helper.</action>
  <verify>Method defined with correct signature, handles both array/object patterns, parse_json_flexibly calls it</verify>
  <done>Closed code block extraction logic encapsulated in dedicated helper method</done>
</task>

<task type="auto">
  <name>Task 2: Extract unclosed markdown code block strategy into helper method</name>
  <files>app/models/provider/concerns/json_parser.rb</files>
  <action>Create private method `extract_from_unclosed_code_blocks(text)` that handles unclosed ```json or ``` blocks (thinking models often forget closing). Extract lines 59-74 from parse_json_flexibly. Return parsed JSON or nil. Update parse_json_flexibly to call this helper.</action>
  <verify>Method defined with correct signature, handles unclosed patterns, parse_json_flexibly calls it</verify>
  <done>Unclosed code block extraction logic encapsulated in dedicated helper method</done>
</task>

<task type="auto">
  <name>Task 3: Extract key-based JSON search strategy into helper method</name>
  <files>app/models/provider/concerns/json_parser.rb</files>
  <action>Create private method `extract_json_with_key(text, key)` that finds JSON objects containing specific keys (categorizations, merchants). Extract lines 76-110 from parse_json_flexibly, generalizing for any key. Return parsed JSON or nil. Update parse_json_flexibly to call with "categorizations" and "merchants" keys.</action>
  <verify>Method accepts key parameter, handles both greedy/non-greedy matches, parse_json_flexibly calls it twice</verify>
  <done>Key-based JSON extraction logic encapsulated in reusable helper method</done>
</task>

<task type="auto">
  <name>Task 4: Extract fallback any-JSON-object strategy into helper method</name>
  <files>app/models/provider/concerns/json_parser.rb</files>
  <action>Create private method `extract_any_json_object(text)` as last resort to find any {...} pattern. Extract lines 113-119 from parse_json_flexibly. Return parsed JSON or nil. Update parse_json_flexibly to call this as final strategy before raising error.</action>
  <verify>Method defined, finds any JSON object, parse_json_flexibly calls as final strategy</verify>
  <done>Fallback JSON extraction logic encapsulated in dedicated helper method</done>
</task>

<task type="auto">
  <name>Task 5: Add unit tests for JsonParser helper methods</name>
  <files>test/models/provider/concerns/json_parser_test.rb</files>
  <action>Create test file test/models/provider/concerns/json_parser_test.rb. Test each helper method with various inputs: valid closed code blocks, unclosed blocks, key-based extraction, fallback extraction. Use a test class that includes Provider::Concerns::JsonParser. Cover edge cases: empty strings, malformed JSON, multiple matches.</action>
  <verify>Test file exists with 10-15 test cases covering all helper methods, bin/rails test test/models/provider/concerns/json_parser_test.rb passes</verify>
  <done>Unit tests exist for all helper methods with comprehensive edge case coverage</done>
</task>

<task type="auto">
  <name>Task 6: Run full test suite to verify no regressions</name>
  <files>app/models/provider/concerns/json_parser.rb, test/models/provider/concerns/json_parser_test.rb</files>
  <action>Run bin/rails test to verify all provider tests still pass after refactoring. The refactoring should not change behavior - only code structure. Verify existing 174 provider tests pass plus new JsonParser unit tests.</action>
  <verify>bin/rails test passes with 174+ provider tests passing, no regressions in other tests</verify>
  <done>All tests passing, refactoring complete with no behavior changes</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] bin/rails test passes (all 174+ provider tests)
- [ ] New json_parser_test.rb has comprehensive coverage
- [ ] parse_json_flexibly is now ~30 lines calling helpers
- [ ] Each helper method has single responsibility
</verification>

<success_criteria>

- All 5 helper methods extracted and working
- parse_json_flexibly simplified from ~85 lines to ~30 lines
- Unit tests cover all helper methods
- All existing provider tests pass (no regressions)
  </success_criteria>

<output>
After completion, create `.planning/phases/27-simplify-json-parsing/27-01-SUMMARY.md`:

# Phase 27 Plan 1: Simplify JSON Parsing Summary

**Refactored 85-line parse_json_flexibly method into 5 focused helper methods for improved readability and testability.**

## Accomplishments

- Extracted closed code block strategy to `extract_from_closed_code_blocks`
- Extracted unclosed code block strategy to `extract_from_unclosed_code_blocks`
- Extracted key-based search to `extract_json_with_key` (reusable)
- Extracted fallback strategy to `extract_any_json_object`
- Added comprehensive unit tests in json_parser_test.rb
- parse_json_flexibly simplified from ~85 to ~30 lines

## Files Created/Modified

- `app/models/provider/concerns/json_parser.rb` - MODIFIED: Added 5 private helper methods
- `test/models/provider/concerns/json_parser_test.rb` - NEW: Unit tests for all helpers

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for Phase 28: Standardize Error Handling
</output>
