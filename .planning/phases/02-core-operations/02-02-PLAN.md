---
phase: 02-core-operations
plan: 02
type: execute
---

<objective>
Implement AutoCategorizer class using Anthropic Messages API with structured outputs.

Purpose: Enable transaction categorization through Anthropic Claude, matching the functionality of the existing OpenAI provider.

Output: Provider::Anthropic::AutoCategorizer class that uses Anthropic's Messages API with structured outputs for reliable categorization.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-operations/02-RESEARCH.md
@.planning/phases/02-core-operations/02-CONTEXT.md
@app/models/provider/openai.rb
@app/models/provider/openai/auto_categorizer.rb
@app/models/provider/llm_concept.rb
@app/models/provider/anthropic.rb
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AutoCategorizer class structure</name>
  <files>app/models/provider/anthropic/auto_categorizer.rb</files>
  <action>Create Provider::Anthropic::AutoCategorizer class with:
1. Constructor accepting: client, model, transactions, user_categories, langfuse_trace (optional), family (optional)
2. attr_reader for all constructor parameters
3. auto_categorize method that calls the Anthropic API
4. Private methods: developer_message, json_schema, build_response, extract_categorizations

Follow the structure from app/models/provider/openai/auto_categorizer.rb (lines 1-60, 120-160). Key differences:
- Use Anthropic's Messages API (not OpenAI's responses.create)
- Include betas: ["structured-outputs-2025-11-13"] header for JSON schema compliance
- Extract content from response.content.find { |block| block.type == "text" }</action>
  <verify>ruby -c app/models/provider/anthropic/auto_categorizer.rb passes</verify>
  <done>AutoCategorizer class created with constructor and auto_categorize method</done>
</task>

<task type="auto">
  <name>Task 2: Implement Messages API call with structured outputs</name>
  <files>app/models/provider/anthropic/auto_categorizer.rb</files>
  <action>Implement the API call in auto_categorize method:
1. Call @client.messages.create with:
   - model: @model or default
   - max_tokens: 1024
   - messages: [{role: "user", content: developer_message}]
   - system: instructions (from detailed_instructions method)
   - betas: ["structured-outputs-2025-11-13"] for structured outputs
2. Extract text content from response: response.content.find { |block| block.type == "text" }&.text
3. Parse JSON and extract "categorizations" key
4. Use build_response to create AutoCategorization objects

Reference the conceptual example from RESEARCH.md code_examples section. The response structure differs from OpenAI - content is an array of blocks, not a nested hash.</action>
  <verify>grep -E "messages.create|betas.*structured" app/models/provider/anthropic/auto_categorizer.rb shows API call pattern</verify>
  <done>Messages API call with beta header, content extraction from response blocks</done>
</task>

<task type="auto">
  <name>Task 3: Implement prompt and schema methods</name>
  <files>app/models/provider/anthropic/auto_categorizer.rb</files>
  <action>Add private methods:
1. instructions - Return detailed instructions (reuse from OpenAI::AutoCategorizer detailed_instructions, lines 97-116)
2. developer_message - Format transactions and user_categories as JSON
3. json_schema - Define JSON schema for categorizations response with:
   - categorizations array
   - Each item: transaction_id (enum of input IDs), category_name (enum of user categories or "null")
   - required: transaction_id, category_name
   - additionalProperties: false

Reuse the exact prompts from OpenAI provider - they're well-tested for categorization. The schema should match OpenAI's but work with Anthropic's structured outputs format.</action>
  <verify>grep -E "def instructions|def developer_message|def json_schema" app/models/provider/anthropic/auto_categorizer.rb shows all three methods</verify>
  <done>Prompt and schema methods implemented with proper JSON structure</done>
</task>

<task type="auto">
  <name>Task 4: Connect AutoCategorizer to Provider::Anthropic</name>
  <files>app/models/provider/anthropic.rb</files>
  <action>Add auto_categorize method to Provider::Anthropic that:
1. Validates transactions.size <= 25 (raise Error if too many)
2. Validates user_categories present (raise Error if blank)
3. Creates Langfuse trace with name: "anthropic.auto_categorize"
4. Instantiates AutoCategorizer with client, model, transactions, user_categories, langfuse_trace, family
5. Calls auto_categorize and updates trace with output
6. Returns result (array of AutoCategorization objects)

Follow the pattern from Provider::Openai#auto_categorize (lines 54-85). This method delegates to the AutoCategorizer class.</action>
  <verify>grep -E "def auto_categorize|AutoCategorizer.new" app/models/provider/anthropic.rb shows delegation pattern</verify>
  <done>Provider::Anthropic#auto_categorize delegates to AutoCategorizer with trace support</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `ruby -c app/models/provider/anthropic/auto_categorizer.rb` passes
- [ ] `ruby -c app/models/provider/anthropic.rb` passes
- [ ] Provider::Anthropic responds to auto_categorize
- [ ] JSON schema matches expected format (transaction_id, category_name)
- [ ] Beta header included in API call
</verification>

<success_criteria>

- AutoCategorizer class implements categorization via Anthropic Messages API
- Structured outputs beta header used for JSON schema compliance
- Provider::Anthropic#auto_categorize method works end-to-end
- Follows same interface as OpenAI provider (drop-in compatible)
  </success_criteria>

<output>
After completion, create `.planning/phases/02-core-operations/02-02-SUMMARY.md`:

# Phase 2 Plan 2: AutoCategorize Summary

**Implemented Anthropic-based transaction categorization using Messages API with structured outputs**

## Accomplishments

- Created Provider::Anthropic::AutoCategorizer class
- Implemented Messages API call with structured outputs beta header
- Added prompt and JSON schema methods for categorization
- Connected AutoCategorizer to Provider::Anthropic
- Added Langfuse tracing support

## Files Created/Modified

- `app/models/provider/anthropic/auto_categorizer.rb` - New categorization logic
- `app/models/provider/anthropic.rb` - Added auto_categorize method

## Decisions Made

- Used structured outputs beta (2025-11-13) instead of tools for simpler implementation
- Reused OpenAI's prompts (well-tested for categorization)
- Content extraction from response.content array (Anthropic-specific structure)

## Issues Encountered

None

## Next Step

Ready for 02-03-PLAN.md - Implement auto_detect_merchants with error handling
</output>
