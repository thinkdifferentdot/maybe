---
phase: 25-extract-json-parser
plan: 01
type: execute
---

<objective>
Extract duplicated `parse_json_flexibly` method to a shared Provider::Concerns::JsonParser module across 4 provider files.

Purpose: DRY up code — The `parse_json_flexibly` method (85 lines) is duplicated across AutoCategorizer and AutoMerchantDetector in both Anthropic and OpenAI providers. Centralizing this improves maintainability and ensures consistent JSON parsing behavior across all providers.

Output: A shared `Provider::Concerns::JsonParser` module with parse_json_flexibly and strip_thinking_tags methods, all 4 provider classes refactored to use it, all tests passing.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONCERNS.md
@.planning/phases/20-extract-usage-recorder-concern/20-01-SUMMARY.md
@app/models/provider/concerns/usage_recorder.rb
@app/models/provider/anthropic/auto_categorizer.rb
@app/models/provider/anthropic/auto_merchant_detector.rb
@app/models/provider/openai/auto_categorizer.rb
@app/models/provider/openai/auto_merchant_detector.rb
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared Provider::Concerns::JsonParser module</name>
  <files>app/models/provider/concerns/json_parser.rb</files>
  <action>Create app/models/provider/concerns/json_parser.rb module with:

1. `parse_json_flexibly(raw)` method that:
   - Returns {} if raw is blank
   - Calls strip_thinking_tags to clean the input
   - Tries direct JSON.parse first
   - Falls back to 4 extraction strategies on JSON::ParserError:
     * Strategy 1: Closed markdown code blocks with arrays (```json [...]```)
     * Strategy 1b: Closed markdown code blocks with objects (```json {...}```)
     * Strategy 2: Unclosed markdown code blocks with arrays
     * Strategy 2b: Unclosed markdown code blocks with objects
     * Strategy 3: Find JSON object with "categorizations" key
     * Strategy 4: Find any JSON object (last resort)
   - Raises Provider::Anthropic::Error if all strategies fail

2. `strip_thinking_tags(raw)` method that:
   - Handles <thinking>...</thinking> tags (Anthropic format)
   - Handles <think>...</think> tags (OpenAI/o1 format)
   - Extracts content after closing tag if present
   - Falls back to extracting content from inside thinking block if no closing tag
   - Returns cleaned string or original if no thinking tags found

Use the Anthropic::AutoCategorizer implementation as reference — it's the most complete. Note that OpenAI uses slightly different tag names (<think> vs <thinking>), so handle both formats.

IMPORTANT: The error class should be generic. Since different providers may raise different errors, catch StandardError or create a provider-agnostic error. For this extraction, use the existing pattern — raise Provider::Anthropic::Error (Anthropic classes already use this, and OpenAI classes will need to handle it appropriately).</action>
  <verify>File exists at app/models/provider/concerns/json_parser.rb with both parse_json_flexibly and strip_thinking_tags methods defined, module is named Provider::Concerns::JsonParser</verify>
  <done>Shared JsonParser concern created with parse_json_flexibly (handles all 4 extraction strategies) and strip_thinking_tags (handles both <thinking> and <think> tag formats)</done>
</task>

<task type="auto">
  <name>Task 2: Refactor Anthropic::AutoCategorizer to use shared JsonParser</name>
  <files>app/models/provider/anthropic/auto_categorizer.rb</files>
  <action>1. Add `include Provider::Concerns::JsonParser` at the top of the class after the attr_reader line (around line 14, after the UsageRecorder include)

2. Delete the entire `parse_json_flexibly` method (lines 292-377 in current file) — it's now provided by the concern

3. Delete the entire `strip_thinking_tags` method (lines 379-398 in current file) — it's now provided by the concern

Do NOT modify any other parts of the class. The existing calls to `parse_json_flexibly` will automatically use the included concern's method.</action>
  <verify>grep -q "include Provider::Concerns::JsonParser" app/models/provider/anthropic/auto_categorizer.rb returns true, and both parse_json_flexibly and strip_thinking_tags methods are removed (no duplicate definitions)</verify>
  <done>AutoCategorizer includes shared JsonParser concern, duplicate parse_json_flexibly and strip_thinking_tags methods removed</done>
</task>

<task type="auto">
  <name>Task 3: Refactor Anthropic::AutoMerchantDetector to use shared JsonParser</name>
  <files>app/models/provider/anthropic/auto_merchant_detector.rb</files>
  <action>1. Add `include Provider::Concerns::JsonParser` at the top of the class after the attr_reader line

2. Delete the entire `parse_json_flexibly` method (approximately lines 207-293) — it's now provided by the concern

3. Delete the entire `strip_thinking_tags` method (approximately lines 295-325) — it's now provided by the concern

Do NOT modify any other parts of the class.</action>
  <verify>grep -q "include Provider::Concerns::JsonParser" app/models/provider/anthropic/auto_merchant_detector.rb returns true, and both parse_json_flexibly and strip_thinking_tags methods are removed</verify>
  <done>AutoMerchantDetector includes shared JsonParser concern, duplicate methods removed</done>
</task>

<task type="auto">
  <name>Task 4: Refactor OpenAI::AutoCategorizer to use shared JsonParser</name>
  <files>app/models/provider/openai/auto_categorizer.rb</files>
  <action>1. Add `include Provider::Concerns::JsonParser` at the top of the class after existing includes (around line 7, after the UsageRecorder include)

2. Delete the entire `parse_json_flexibly` method (approximately lines 375-439) — it's now provided by the concern

3. Delete the entire `strip_thinking_tags` method (approximately lines 441-463) — it's now provided by the concern

NOTE: The OpenAI version uses slightly different tag names (<think> vs <thinking>). The shared concern handles both formats, so this is safe.

Do NOT modify any other parts of the class.</action>
  <verify>grep -q "include Provider::Concerns::JsonParser" app/models/provider/openai/auto_categorizer.rb returns true, and both parse_json_flexibly and strip_thinking_tags methods are removed</verify>
  <done>AutoCategorizer includes shared JsonParser concern, duplicate methods removed</done>
</task>

<task type="auto">
  <name>Task 5: Refactor OpenAI::AutoMerchantDetector to use shared JsonParser</name>
  <files>app/models/provider/openai/auto_merchant_detector.rb</files>
  <action>1. Add `include Provider::Concerns::JsonParser` at the top of the class after existing includes

2. Delete the entire `parse_json_flexibly` method (approximately lines 334-395) — it's now provided by the concern

3. Delete the entire `strip_thinking_tags` method (approximately lines 397-420) — it's now provided by the concern

Do NOT modify any other parts of the class.</action>
  <verify>grep -q "include Provider::Concerns::JsonParser" app/models/provider/openai/auto_merchant_detector.rb returns true, and both parse_json_flexibly and strip_thinking_tags methods are removed</verify>
  <done>AutoMerchantDetector includes shared JsonParser concern, duplicate methods removed</done>
</task>

<task type="auto">
  <name>Task 6: Run tests and verify no regressions</name>
  <files>test/models/provider/anthropic_test.rb, test/models/provider/openai_test.rb</files>
  <action>Run the full test suite to verify refactoring didn't break anything:

1. Run Anthropic tests: bin/rails test test/models/provider/anthropic_test.rb
2. Run OpenAI tests: bin/rails test test/models/provider/openai_test.rb
3. Run full provider tests: bin/rails test test/models/provider/

If any tests fail, investigate — likely issues would be:
- Method signature difference between providers (unlikely since they're identical)
- Error class mismatch (OpenAI classes may not expect Provider::Anthropic::Error)
- Missing include in one of the classes

All tests should pass since we're only moving code around, not changing behavior.

NOTE: If tests fail due to Provider::Anthropic::Error being raised in OpenAI classes, we may need to make the error class more generic. For now, proceed with the current approach and adjust if needed.</action>
  <verify>All tests pass (anthropic_test.rb, openai_test.rb, and any JSON parsing-related tests)</verify>
  <done>All Anthropic and OpenAI tests passing, no regressions introduced, ~340 lines of duplicate code eliminated across 4 files</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `bin/rails test test/models/provider/anthropic_test.rb` passes
- [ ] `bin/rails test test/models/provider/openai_test.rb` passes
- [ ] Shared concern exists at app/models/provider/concerns/json_parser.rb
- [ ] All 4 provider classes include the shared concern
- [ ] Duplicate parse_json_flexibly methods removed from all 4 classes
- [ ] Duplicate strip_thinking_tags methods removed from all 4 classes
</verification>

<success_criteria>

- Shared Provider::Concerns::JsonParser module created
- All 4 provider classes (Anthropic::AutoCategorizer, Anthropic::AutoMerchantDetector, OpenAI::AutoCategorizer, OpenAI::AutoMerchantDetector) refactored to use shared concern
- All existing tests pass (no behavior changes)
- ~340 lines of duplicate code eliminated
- Code is more DRY and maintainable
</success_criteria>

<output>
After completion, create `.planning/phases/25-extract-json-parser/25-01-SUMMARY.md`:

# Phase 25 Plan 1: Extract JsonParser Concern Summary

**Extracted duplicated parse_json_flexibly and strip_thinking_tags methods into a shared concern module, eliminating ~340 lines of duplicate code across 4 provider classes.**

## Accomplishments

- Created `Provider::Concerns::JsonParser` shared module with 4-strategy JSON parsing
- Refactored all 4 provider classes to include shared concern:
  - Provider::Anthropic::AutoCategorizer
  - Provider::Anthropic::AutoMerchantDetector
  - Provider::Openai::AutoCategorizer
  - Provider::Openai::AutoMerchantDetector
- Removed duplicate parse_json_flexibly and strip_thinking_tags methods from all classes
- All tests passing with no behavior changes

## Files Created/Modified

- `app/models/provider/concerns/json_parser.rb` - NEW: Shared concern with parse_json_flexibly and strip_thinking_tags
- `app/models/provider/anthropic/auto_categorizer.rb` - MODIFIED: Added include, removed ~107 lines
- `app/models/provider/anthropic/auto_merchant_detector.rb` - MODIFIED: Added include, removed ~107 lines
- `app/models/provider/openai/auto_categorizer.rb` - MODIFIED: Added include, removed ~89 lines
- `app/models/provider/openai/auto_merchant_detector.rb` - MODIFIED: Added include, removed ~89 lines

## Decisions Made

- Used shared Provider::Concerns namespace (same as UsageRecorder)
- Both <thinking> and <think> tag formats handled in single strip_thinking_tags method
- Preserved Provider::Anthropic::Error for JSON parsing failures (works for both providers)

## Issues Encountered

[None expected - straightforward refactoring following existing UsageRecorder pattern]

## Next Step

Phase 26: Extract Thinking Tags (actually, this is already done as part of JsonParser — Phase 26 may need to be adjusted or marked as complete)

Phase 25 complete — ready for Phase 27: Simplify JSON Parsing
</output>
