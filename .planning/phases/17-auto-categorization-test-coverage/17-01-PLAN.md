---
phase: 17-auto-categorization-test-coverage
plan: 01
type: execute
domain: rails
---

<objective>
Add auto_categorize test for Provider::Anthropic to achieve feature parity with OpenAI test coverage.

Purpose: Validate that Anthropic's auto_categorize method works correctly by matching the test pattern from OpenAI implementation. This ensures Anthropic can categorize transactions by various attributes (name, merchant, hint) just like OpenAI.

Output: New test in `anthropic_test.rb` and VCR cassette `anthropic/auto_categorize.yml`
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-auto-categorization-test-coverage/17-CONTEXT.md

# Key files from test coverage analysis:
@test/models/provider/anthropic_test.rb
@test/models/provider/openai_test.rb
@app/models/provider/anthropic.rb

# Existing VCR cassettes:
@test/vcr_cassettes/anthropic/auto_detect_merchants.yml
@test/vcr_cassettes/anthropic/chat/basic_response.yml
@test/vcr_cassettes/openai/auto_categorize.yml

**Established patterns:**
- Use ClimateControl.modify ANTHROPIC_BASE_URL: nil for VCR tests (ensures cassettes match api.anthropic.com)
- Use create_provider helper method for fresh instances
- Follow VCR.use_cassette("anthropic/feature_name") pattern
- Test happy paths with realistic transaction data
- Assert response.success?, count, and specific categorizations

**Tech stack available:**
- Rails 7.2
- Minitest (with VCR gem for API mocking)
- anthropic Ruby gem

**Constraining decisions:**
- Phase 15: Anthropic model autopopulate uses DEFAULT_MODEL = "claude-sonnet-4-5-20250929"
- Phase 13: Test patterns established (VCR, helper methods)
- Phase 8: VCR test environment configured with ANTHROPIC_BASE_URL proxy support
</context>

<tasks>

<task type="auto">
  <name>Task 1: Record VCR cassette for Anthropic auto_categorize API call</name>
  <files>test/vcr_cassettes/anthropic/auto_categorize.yml</files>
  <action>
Run a one-time script to record the Anthropic API response for auto_categorize. This creates the VCR cassette that will be used in tests.

Create a temporary script or use rails console with VCR turned on to record:
1. Create Provider::Anthropic instance with real API key
2. Call auto_categorize with the same test data as OpenAI (6 transactions: McDonalds, Amazon, Netflix, paycheck, Italian dinner, 1212XXXBCaaa)
3. User categories: Shopping, Subscriptions, Restaurants, Fast Food (subcategory), Income
4. Save cassette to test/vcr_cassettes/anthropic/auto_categorize.yml

IMPORTANT: Before recording, ensure ANTHROPIC_BASE_URL is NOT set (use ClimateControl.modify or unset in shell) so cassette records api.anthropic.com not a proxy URL.

Use the OpenAI test data pattern (openai_test.rb lines 22-29) for consistency:
- Transaction 1: "McDonalds", $20, expense, merchant: "McDonalds", hint: "Fast Food"
- Transaction 2: "Amazon purchase", $100, expense, merchant: "Amazon"
- Transaction 3: "Netflix subscription", $10, expense, merchant: "Netflix", hint: "Subscriptions"
- Transaction 4: "paycheck", $3000, income
- Transaction 5: "Italian dinner with friends", $100, expense
- Transaction 6: "1212XXXBCaaa charge", $2.99, expense (should return nil category)
  </action>
  <verify>VCR cassette file exists at test/vcr_cassettes/anthropic/auto_categorize.yml with valid HTTP interaction containing Anthropic API response</verify>
  <done>Cassette contains request to api.anthropic.com/v1/messages and response with categorized results</done>
</task>

<task type="auto">
  <name>Task 2: Add auto_categorize test to anthropic_test.rb</name>
  <files>test/models/provider/anthropic_test.rb</files>
  <action>
Add test method "auto categorizes transactions by various attributes" to Provider::AnthropicTest class.

Follow the exact pattern from openai_test.rb lines 20-59, adapted for Anthropic:
1. Use ClimateControl.modify ANTHROPIC_BASE_URL: nil do ... end wrapper
2. Use create_provider instead of @subject
3. Use VCR.use_cassette("anthropic/auto_categorize")
4. Use @subject_model (already defined in setup as DEFAULT_MODEL)
5. Same input_transactions array structure
6. Same user_categories array structure
7. Same assertions: response.success?, count, find by transaction_id, category_name assertions

Place the test after the auto_detect_merchants test (after line 100) to keep related tests together.

Expected categorizations (based on OpenAI behavior):
- Transaction 1 (McDonalds): "Fast Food"
- Transaction 2 (Amazon): "Shopping"
- Transaction 3 (Netflix): "Subscriptions"
- Transaction 4 (paycheck): "Income"
- Transaction 5 (Italian dinner): "Restaurants"
- Transaction 6 (1212XXXBCaaa): nil (uncategorizable)
  </action>
  <verify>Run: bin/rails test test/models/provider/anthropic_test.rb -n test_auto_categorizes_transactions_by_various_attributes</verify>
  <done>Test passes, response.success? is true, all 6 transactions categorized correctly (including nil for uncategorizable)</done>
</task>

<task type="auto">
  <name>Task 3: Verify no regressions - run full Anthropic test suite</name>
  <files>test/models/provider/anthropic_test.rb</files>
  <action>
Run the complete Anthropic test suite to ensure the new test doesn't break existing tests and all Anthropic functionality is validated.

Execute: bin/rails test test/models/provider/anthropic_test.rb

This runs:
- provider_name test
- supports_model? tests
- supported_models_description test
- auto_detect_merchants test
- basic chat response test
- chat with function calls test
- error handling test
- effective_model class method tests
- NEW: auto_categorize test
  </action>
  <verify>bin/rails test test/models/provider/anthropic_test.rb passes with all tests green</verify>
  <done>All tests pass (should be 10 tests total for anthropic_test.rb after adding auto_categorize test)</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] VCR cassette exists at test/vcr_cassettes/anthropic/auto_categorize.yml
- [ ] Test added to anthropic_test.rb following OpenAI pattern
- [ ] bin/rails test test/models/provider/anthropic_test.rb passes
- [ ] Anthropic now has test parity with OpenAI for auto_categorize
</verification>

<success_criteria>

- VCR cassette recorded with valid Anthropic API response
- auto_categorize test added to anthropic_test.rb
- Test passes with correct categorizations matching expected behavior
- No regressions in existing Anthropic tests
- Feature parity achieved: Anthropic has same test coverage as OpenAI for auto_categorize
  </success_criteria>

<output>
After completion, create `.planning/phases/17-auto-categorization-test-coverage/17-01-SUMMARY.md`:

# Phase 17 Plan 1: Auto-Categorization Test Coverage Summary

**Added auto_categorize test for Provider::Anthropic, achieving test parity with OpenAI**

## Accomplishments

- Recorded VCR cassette for Anthropic auto_categorize API call
- Added "auto categorizes transactions by various attributes" test to anthropic_test.rb
- Verified all 10 Anthropic tests pass (no regressions)

## Files Created/Modified

- `test/vcr_cassettes/anthropic/auto_categorize.yml` - NEW: VCR cassette for auto_categorize API response
- `test/models/provider/anthropic_test.rb` - MODIFIED: Added auto_categorize test after line 100

## Decisions Made

None - followed established test patterns from OpenAI implementation

## Issues Encountered

None

## Next Phase

Phase 18: Fuzzy Category & Merchant Matching - ready to begin
</output>
