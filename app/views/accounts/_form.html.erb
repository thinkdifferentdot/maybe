<%# locals: (account:, url:) %>

<% if @error_message.present? %>
  <%= render DS::Alert.new(message: @error_message, variant: :error) %>
<% end %>

<%= styled_form_with model: account, url: url, scope: :account, data: { turbo: false }, class: "flex flex-col gap-4 justify-between grow text-primary" do |form| %>
  <div class="grow space-y-2">
    <%= form.hidden_field :return_to, value: params[:return_to] %>

    <%= form.text_field :name, placeholder: t(".name_placeholder"), required: "required", label: t(".name_label") %>

    <% unless account.linked? %>
      <%= form.money_field :balance, label: t(".balance"), required: true, default_currency: Current.family.currency %>
    <% end %>

    <%# Lunchflow Account Type Section - only show for Lunchflow accounts %>
    <% if account.persisted? && account.respond_to?(:lunchflow_account) && account.lunchflow_account.present? %>
      <div class="space-y-4 border-t border-primary mt-6 pt-6">
        <h3 class="text-lg font-semibold">Lunchflow Account Type</h3>

        <%# Account Type Selection %>
        <div>
          <%= form.label :accountable_type, "Account Type" %>
          <%= form.select :accountable_type,
                          accountable_type_options,
                          {},
                          class: "form-select w-full px-3 py-2 border border-primary rounded-md",
                          data: {
                            controller: "account-type-selector",
                            action: "change->account-type-selector#updateSubtypes",
                            account_type_selector_target: "typeSelect"
                          } %>
        </div>

        <%# Subtype Selection (conditional) %>
        <div data-account-type-selector-target="subtypeContainer">
          <%= form.label :subtype, "Account Subtype" %>
          <%= form.select :subtype,
                          subtype_options_for(account.accountable_type),
                          { include_blank: "None" },
                          class: "form-select w-full px-3 py-2 border border-primary rounded-md",
                          data: { account_type_selector_target: "subtypeSelect" } %>
        </div>

        <div class="text-sm text-gray-600">
          <p>Changing the account type will preserve your existing transactions and balances.
             If the account has data incompatible with the new type (e.g., holdings on a non-Investment account),
             the change will be blocked.</p>
        </div>
      </div>
    <% else %>
      <%= form.hidden_field :accountable_type %>
    <% end %>

    <%= yield form if block_given? %>
  </div>

  <%= form.submit %>
<% end %>
